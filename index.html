<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‡ ìƒ¤ì¸ ì£¼ì°¨ë³„ ì „ë¬¸ê°€</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 12px;
      padding: 10px;
      line-height: 1.4;
    }
    
    /* Weather Panel */
    .weather-panel {
      margin-bottom: 8px;
      padding: 10px;
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .weather-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .weather-header .title { font-size: 12px; color: #e2e8f0; font-weight: 600; }
    .weather-header .location {
      margin-left: auto;
    }
    .weather-header select {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 3px;
      color: #e2e8f0;
      font-size: 10px;
      padding: 3px 6px;
    }
    .weather-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .weather-day {
      flex: 1;
      min-width: 280px;
      background: rgba(59,130,246,0.1);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(59,130,246,0.2);
    }
    .weather-day .day-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(59,130,246,0.2);
    }
    .weather-day .day-label { font-size: 11px; font-weight: 600; color: #e2e8f0; }
    .weather-day .day-icon { font-size: 22px; }
    .weather-day .day-temp { font-size: 14px; font-weight: 700; color: #60a5fa; }
    .weather-day .day-desc { font-size: 10px; color: #94a3b8; margin-left: auto; }
    .weather-day .day-precip { font-size: 9px; color: #38bdf8; }
    
    /* Hourly inside day */
    .hourly-scroll {
      display: flex;
      gap: 3px;
      overflow-x: auto;
      padding: 4px 0;
    }
    .hourly-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 30px;
      padding: 3px 2px;
      background: rgba(71,85,105,0.4);
      border-radius: 4px;
    }
    .hourly-item .time { font-size: 9px; color: #94a3b8; }
    .hourly-item .icon { font-size: 14px; margin: 2px 0; }
    .hourly-item .t { font-size: 11px; font-weight: 700; }
    .hourly-item .rain { font-size: 8px; color: #38bdf8; }
    .hourly-item .snow { font-size: 8px; color: #a5b4fc; }
    .hourly-item.now { background: rgba(34,197,94,0.3); border: 1px solid rgba(34,197,94,0.5); }
    
    .weather-loading { font-size: 10px; color: #64748b; padding: 20px; text-align: center; }
    
    /* Header */
    .header {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
      padding: 10px;
      background: linear-gradient(135deg, #7c3aed, #a855f7);
      border-radius: 8px;
    }
    .header h1 { font-size: 14px; flex: 1; }
    .header input {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      padding: 5px 8px;
      color: white;
      font-size: 11px;
      width: 110px;
    }
    .header input::placeholder { color: rgba(255,255,255,0.6); }
    .header .stat {
      background: rgba(0,0,0,0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
    }
    .header .stat b { color: #fcd34d; }
    
    /* Week List */
    .week-list { display: flex; flex-direction: column; gap: 2px; }
    
    /* Week Item */
    .week-item {
      background: #1e293b;
      border-radius: 4px;
      overflow: hidden;
      border-left: 3px solid #475569;
    }
    .week-item.active { border-left-color: #a855f7; }
    .week-item.current { border-left-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
    
    /* Week Header (Toggle) */
    .week-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .week-header:hover { background: #334155; }
    .week-icon { font-size: 14px; width: 20px; text-align: center; }
    .week-info { flex: 1; display: flex; align-items: baseline; gap: 6px; }
    .week-title { font-weight: 600; font-size: 11px; }
    .week-dates { font-size: 9px; color: #fde047; font-weight: 700; }
    .week-alert {
      font-size: 8px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(239,68,68,0.15);
      color: #fca5a5;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .week-toggle {
      font-size: 10px;
      color: #64748b;
      transition: transform 0.3s;
    }
    .week-item.open .week-toggle { transform: rotate(180deg); }
    
    /* Week Content */
    .week-content {
      display: none;
      padding: 0 12px 12px;
    }
    .week-item.open .week-content { display: block; }
    
    /* Grid inside content */
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    
    /* Card */
    .card {
      background: #334155;
      border-radius: 6px;
      padding: 8px;
    }
    .card-title {
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Row */
    .row {
      background: #475569;
      border-radius: 3px;
      padding: 4px 6px;
      margin-bottom: 3px;
      font-size: 10px;
    }
    .row:last-child { margin-bottom: 0; }
    .row-label { font-size: 8px; color: #94a3b8; }
    .row-value { font-weight: 600; color: #f1f5f9; }
    .row-sub { font-size: 9px; color: #cbd5e1; }
    .row-ok { font-size: 8px; color: #4ade80; }
    .row-warn { font-size: 8px; color: #fbbf24; }
    
    .row.water { border-left: 2px solid #22d3ee; }
    .row.fert { border-left: 2px solid #4ade80; }
    .row.temp { border-left: 2px solid #fb923c; }
    .row.humid { border-left: 2px solid #3b82f6; }
    .row.vent { border-left: 2px solid #facc15; }
    .row.pest { border-left: 2px solid #f87171; }
    .row.pf { border-left: 2px solid #f472b6; }
    
    /* Badge */
    .badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 6px;
      font-size: 8px;
      font-weight: 600;
    }
    .badge.h { background: rgba(239,68,68,0.2); color: #f87171; }
    .badge.m { background: rgba(250,204,21,0.2); color: #fbbf24; }
    .badge.l { background: rgba(74,222,128,0.2); color: #4ade80; }
    .badge.pf { background: rgba(244,114,182,0.2); color: #f472b6; }
    .badge.current { background: #22c55e; color: white; }
    
    /* Task List */
    .task-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .task {
      background: #475569;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 9px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .task input[type="checkbox"] {
      width: 12px;
      height: 12px;
      accent-color: #a855f7;
      cursor: pointer;
      margin: 0;
    }
    .task.checked span { opacity: 0.5; text-decoration: line-through; }
    
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>ğŸ‡ ìƒ¤ì¸ ì£¼ì°¨ë³„ ì „ë¬¸ê°€</h1>
    <input type="date" id="heatStart" value="2025-01-19" title="ì—´ê°€ë‘  ì‹œì‘ì¼">
    <input type="date" id="targetDate" title="ë¶„ì„ì¼">
    <div class="stat">ì£¼ì°¨ <b id="dWeek">-</b></div>
    <div class="stat">ê²½ê³¼ <b id="dDays">-</b></div>
  </div>
  
  <!-- Weather Panel -->
  <div class="weather-panel">
    <div class="weather-header">
      <span class="title">ğŸŒ¤ï¸ ì˜¤ëŠ˜Â·ë‚´ì¼ ë‚ ì”¨</span>
      <div class="location">
        <select id="weatherLocation" onchange="loadWeather()">
          <option value="Gimcheon">ê¹€ì²œ</option>
          <option value="Sangju">ìƒì£¼</option>
          <option value="Yeongcheon">ì˜ì²œ</option>
          <option value="Gyeongsan">ê²½ì‚°</option>
          <option value="Daegu">ëŒ€êµ¬</option>
        </select>
      </div>
    </div>
    <div id="weatherContent"><div class="weather-loading">ë‚ ì”¨ ë¡œë”©ì¤‘...</div></div>
  </div>
  
  
  <!-- Week List -->
  <div class="week-list" id="weekList"></div>
  
  <script src="shine_expert.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let currentWeekNo = 1;
    
    function init() {
      const t = new Date();
      $('targetDate').value = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      
      ['heatStart', 'targetDate'].forEach(id => {
        $(id).addEventListener('change', run);
        $(id).addEventListener('input', run);
      });
      
      renderWeekList();
      run();
      setTimeout(loadTaskStates, 100);
    }
    
    function run() {
      const { analyze, getWeekNo } = window.ShineExpert;
      const heatStart = new Date($('heatStart').value);
      const targetDate = new Date($('targetDate').value);
      
      const rawWeekNo = getWeekNo(heatStart, targetDate);
      const daysFromStart = Math.floor((targetDate - heatStart) / (24 * 60 * 60 * 1000));
      
      // ì‹œì¦Œ ë²”ìœ„ ì²´í¬ (1~52ì£¼ = ì—°ê°„ ì‚¬ì´í´)
      if (rawWeekNo <= 0) {
        currentWeekNo = 0;
        $('dWeek').textContent = 'ì‹œì¦Œ ì „';
        $('dDays').textContent = 'D' + daysFromStart;
      } else if (rawWeekNo > 52) {
        // 52ì£¼ ì´ˆê³¼ ì‹œ ë‹¤ìŒ ì—°ë„ë¡œ ìˆœí™˜ (rawWeekNo % 52 ë˜ëŠ” ê·¸ëƒ¥ 52ì£¼ í‘œì‹œ)
        currentWeekNo = ((rawWeekNo - 1) % 52) + 1;
        $('dWeek').textContent = currentWeekNo + 'ì£¼';
        $('dDays').textContent = 'D+' + daysFromStart;
      } else {
        currentWeekNo = rawWeekNo;
        $('dWeek').textContent = rawWeekNo + 'ì£¼';
        $('dDays').textContent = 'D+' + daysFromStart;
      }
      
      updateWeekHighlight(currentWeekNo);
    }
    
    function updateWeekHighlight(weekNo) {
      document.querySelectorAll('.week-item').forEach((el, i) => {
        el.classList.remove('current');
        if (i + 1 === weekNo) {
          el.classList.add('current');
        }
      });
    }
    
    function renderWeekList() {
      const { WEEKLY_DATA } = window.ShineExpert;
      const container = $('weekList');
      container.innerHTML = '';
      
      for (let i = 1; i <= 52; i++) {
        const w = WEEKLY_DATA[i];
        if (!w) continue;
        
        const item = document.createElement('div');
        item.className = 'week-item';
        item.innerHTML = `
          <div class="week-header" onclick="toggleWeek(${i})">
            <div class="week-icon">${w.phaseEmoji}</div>
            <div class="week-info">
              <div class="week-title">${i}ì£¼ì°¨ - ${w.phase}</div>
              <div class="week-dates">${w.dateRange}</div>
            </div>
            <div class="week-alert">${w.keyAlert}</div>
            <div class="week-toggle">â–¼</div>
          </div>
          <div class="week-content" id="weekContent${i}">
            ${renderWeekContent(w)}
          </div>
        `;
        container.appendChild(item);
      }
    }
    
    function renderWeekContent(w) {
      const rb = w.pest.risk === 'HIGH' ? 'h' : w.pest.risk === 'MEDIUM' ? 'm' : 'l';
      
      return `
        <div style="margin-bottom:8px;padding:6px;background:#1e293b;border-radius:4px;font-size:11px;">
          <strong>ğŸ¯ ëª©í‘œ:</strong> ${w.goal}
        </div>
        
        <div class="content-grid">
          <!-- ê´€ìˆ˜ -->
          <div class="card">
            <div class="card-title">ğŸ’§ ê´€ìˆ˜</div>
            <div class="row water"><div class="row-label">ì£¼ê¸°</div><div class="row-value">${w.water.interval}</div></div>
            <div class="row water"><div class="row-label">ìš©ëŸ‰</div><div class="row-value">${w.water.amountTon}</div><div class="row-sub">${w.water.amountL}</div></div>
            <div class="row water"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.water.method}</div></div>
            <div class="row water"><div class="row-ok">âœ“ ${w.water.point}</div></div>
            <div class="row water"><div class="row-warn">âš  ${w.water.caution}</div></div>
          </div>
          
          <!-- ì‹œë¹„ -->
          <div class="card">
            <div class="card-title">ğŸ§ª ì‹œë¹„</div>
            <div class="row fert"><div class="row-label">${w.fertilizer.type}</div><div class="row-value">${w.fertilizer.main}</div></div>
            ${w.fertilizer.sub ? `<div class="row fert"><div class="row-sub">${w.fertilizer.sub}</div></div>` : ''}
            ${w.fertilizer.foliar ? `<div class="row fert"><div class="row-label">ì—½ë©´</div><div class="row-sub">${w.fertilizer.foliar}</div></div>` : ''}
            <div class="row fert"><div class="row-label">EC</div><div class="row-value">${w.fertilizer.ec}</div></div>
            <div class="row fert"><div class="row-ok">âœ“ ${w.fertilizer.npk}</div></div>
            <div class="row fert"><div class="row-warn">âš  ${w.fertilizer.point}</div></div>
          </div>
          
          <!-- PFë†ë²• -->
          <div class="card">
            <div class="card-title">ğŸ¦  PFë†ë²• (ë¹„)</div>
            ${w.pf.apply ? `
              <div class="row pf"><span class="badge pf">${w.pf.note}</span></div>
              <div class="row pf"><div class="row-label">ìš©ëŸ‰</div><div class="row-value">${w.pf.amount}</div></div>
              <div class="row pf"><div class="row-sub">${w.pf.timing || ''}</div></div>
            ` : `<div class="row"><div class="row-value">${w.pf.note}</div></div>`}
          </div>
          
          <!-- ë©€ì¹­ -->
          ${w.mulching ? `
          <div class="card">
            <div class="card-title">ğŸ›ï¸ ë©€ì¹­</div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-label">ìƒíƒœ</div><div class="row-value" style="color:#a78bfa">${w.mulching.status}</div></div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-label">ì‘ì—…</div><div class="row-sub">${w.mulching.action}</div></div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-ok">âœ“ ${w.mulching.point}</div></div>
          </div>
          ` : ''}
          
          <!-- ì „ì • -->
          ${w.pruning ? `
          <div class="card">
            <div class="card-title">âœ‚ï¸ ì „ì •</div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-label">ìƒíƒœ</div><div class="row-value" style="color:#f472b6">${w.pruning.status}</div></div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-label">ì‘ì—…</div><div class="row-sub">${w.pruning.action}</div></div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-ok">âœ“ ${w.pruning.point}</div></div>
          </div>
          ` : ''}
          
          <!-- í™”ìˆ˜ì •í˜• -->
          ${w.hwasoo ? `
          <div class="card">
            <div class="card-title">âœ‚ï¸ í™”ìˆ˜ì •í˜•</div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#f472b6">${w.hwasoo.stage}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ì‹œê¸°</div><div class="row-sub">${w.hwasoo.timing}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ëª©í‘œ</div><div class="row-value">${w.hwasoo.target}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.hwasoo.method}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-ok">âœ“ ${w.hwasoo.point}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-warn">${w.hwasoo.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ë©”ë¦¬íŠ¸ì²­ -->
          ${w.meritcheong ? `
          <div class="card">
            <div class="card-title">ğŸ§´ ë©”ë¦¬íŠ¸ì²­ (ë¹„)</div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#fbbf24">${w.meritcheong.stage}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ì‹œê¸°</div><div class="row-value">${w.meritcheong.timing}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë†ë„</div><div class="row-sub">${w.meritcheong.concentration}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.meritcheong.method}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-ok">âœ“ ${w.meritcheong.point}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-warn">${w.meritcheong.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ì§€ë² ë ë¦°(GA) -->
          ${w.ga ? `
          <div class="card">
            <div class="card-title">ğŸ’‰ ì§€ë² ë ë¦°(GA)</div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#34d399">${w.ga.stage}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ì‹œê¸°</div><div class="row-value">${w.ga.timing}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë†ë„</div><div class="row-sub">${w.ga.concentration}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.ga.method}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-ok">âœ“ ${w.ga.point}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-warn">${w.ga.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- í† ì–‘ì ê²€ -->
          ${w.soilCheck ? `
          <div class="card">
            <div class="card-title">ğŸ”¬ í† ì–‘ì ê²€</div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#818cf8">${w.soilCheck.stage}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ì‹œê¸°</div><div class="row-sub">${w.soilCheck.timing}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">í•­ëª©</div><div class="row-sub">${w.soilCheck.items}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ì ì •ê°’</div><div class="row-value" style="font-size:9px">${w.soilCheck.target}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.soilCheck.method}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-ok">âœ“ ${w.soilCheck.point}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-warn">${w.soilCheck.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ë‹¹ë„ ì˜¬ë¦¬ê¸° ë¹„ë²• -->
          ${w.brix ? `
          <div class="card" style="grid-column: span 2;">
            <div class="card-title">ğŸ¯ ë‹¹ë„ ì˜¬ë¦¬ê¸° ë¹„ë²• (ë¹„)</div>
            <div class="row" style="border-left:2px solid #f59e0b;background:#451a03;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#fcd34d">${w.brix.stage}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ëª©í‘œ</div><div class="row-value" style="color:#fbbf24">${w.brix.target}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;">
              <div class="row-label">ğŸ”‘ ë¹„ë²•</div>
              <div style="font-size:9px;color:#fcd34d;">
                ${w.brix.secrets.map(s => `<div style="margin:2px 0;">${s}</div>`).join('')}
              </div>
            </div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.brix.method}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-ok">âœ“ ${w.brix.point}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-warn">${w.brix.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ì˜¨ë„ -->
          <div class="card">
            <div class="card-title">ğŸŒ¡ï¸ ì˜¨ë„</div>
            ${w.avgOutdoorTemp ? `<div class="row" style="background:#1e3a5f;border-left:2px solid #3b82f6;"><div class="row-label">ğŸŒ¤ï¸ ì™¸ë¶€ í†µìƒ</div><div class="row-value" style="color:#60a5fa">${w.avgOutdoorTemp.min}~${w.avgOutdoorTemp.max}Â°C <span style="font-size:9px;color:#94a3b8">(í‰ê·  ${w.avgOutdoorTemp.avg}Â°C)</span></div></div>` : ''}
            <div class="row temp"><div class="row-label">ì£¼ê°„ ëª©í‘œ</div><div class="row-value">${w.temperature.dayTarget[0]}~${w.temperature.dayTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-label">ì•¼ê°„ ëª©í‘œ</div><div class="row-value">${w.temperature.nightTarget[0]}~${w.temperature.nightTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-label">ì§€ì˜¨ ëª©í‘œ</div><div class="row-value">${w.temperature.soilTarget[0]}~${w.temperature.soilTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-ok">âœ“ ${w.temperature.point}</div></div>
            <div class="row temp"><div class="row-warn">âš  ${w.temperature.caution}</div></div>
          </div>
          
          <!-- ìŠµë„ -->
          <div class="card">
            <div class="card-title">ğŸ’¨ ìŠµë„</div>
            <div class="row humid"><div class="row-label">ì£¼ê°„</div><div class="row-value">${w.humidity.dayTarget[0]}~${w.humidity.dayTarget[1]}%</div></div>
            <div class="row humid"><div class="row-label">ì•¼ê°„</div><div class="row-value">${w.humidity.nightTarget[0]}~${w.humidity.nightTarget[1]}%</div></div>
            <div class="row humid"><div class="row-label">VPD</div><div class="row-value">${w.humidity.vpdTarget[0]}~${w.humidity.vpdTarget[1]} kPa</div></div>
            <div class="row humid"><div class="row-ok">âœ“ ${w.humidity.point}</div></div>
            <div class="row humid"><div class="row-warn">âš  ${w.humidity.caution}</div></div>
          </div>
          
          <!-- í™˜ê¸° -->
          <div class="card">
            <div class="card-title">ğŸŒ¬ï¸ í™˜ê¸°</div>
            <div class="row vent"><div class="row-label">ì‹œê°„ëŒ€</div><div class="row-value">${w.ventilation.timing}</div></div>
            <div class="row vent"><div class="row-label">ì‹œê°„</div><div class="row-value">${w.ventilation.duration}</div></div>
            <div class="row vent"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.ventilation.method}</div></div>
            <div class="row vent"><div class="row-ok">âœ“ ${w.ventilation.point}</div></div>
            <div class="row vent"><div class="row-warn">âš  ${w.ventilation.caution}</div></div>
          </div>
          
          <!-- ë³‘í•´ -->
          <div class="card">
            <div class="card-title">ğŸ›¡ï¸ ë³‘í•´ì¶©</div>
            <div class="row pest"><div class="row-label">ì£¼ì˜</div><div class="row-value">${w.pest.watch.join(', ')}</div><span class="badge ${rb}">${w.pest.risk}</span></div>
            <div class="row pest"><div class="row-label">ì¡°ê±´</div><div class="row-sub">${w.pest.condition}</div></div>
            <div class="row pest"><div class="row-label">ì˜ˆë°©</div><div class="row-sub">${w.pest.prevention}</div></div>
            <div class="row pest"><div class="row-label">ì•½ì œ</div><div class="row-sub">ğŸ’Š ${w.pest.spray}</div></div>
          </div>
          
          <!-- ì‘ì—… -->
          <div class="card">
            <div class="card-title">ğŸ“‹ ì´ë²ˆ ì£¼ ì‘ì—…</div>
            <div class="task-list">
              ${w.tasks.map((t, i) => `<div class="task" onclick="toggleTask(this)"><input type="checkbox" id="task_\${weekNum}_${i}"><span>${t}</span></div>`).join('')}
            </div>
          </div>
          
          <!-- ì²´í¬ -->
          <div class="card">
            <div class="card-title">âœ… ì²´í¬í¬ì¸íŠ¸</div>
            <div class="task-list">
              ${w.checkPoints.map((c, i) => `<div class="task" onclick="toggleTask(this)"><input type="checkbox" id="check_\${weekNum}_${i}"><span>${c}</span></div>`).join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    function toggleTask(el) {
      const checkbox = el.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      el.classList.toggle('checked', checkbox.checked);
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      const id = checkbox.id;
      const checked = JSON.parse(localStorage.getItem('shineTasks') || '{}');
      checked[id] = checkbox.checked;
      localStorage.setItem('shineTasks', JSON.stringify(checked));
    }
    
    function loadTaskStates() {
      const checked = JSON.parse(localStorage.getItem('shineTasks') || '{}');
      Object.keys(checked).forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && checked[id]) {
          checkbox.checked = true;
          checkbox.closest('.task').classList.add('checked');
        }
      });
    }
    
    function toggleWeek(weekNo) {
      const items = document.querySelectorAll('.week-item');
      items.forEach((item, i) => {
        if (i + 1 === weekNo) {
          item.classList.toggle('open');
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // í˜„ì¬ ì£¼ì°¨ ìë™ ì—´ê¸°
    function openCurrentWeek() {
      const items = document.querySelectorAll('.week-item');
      if (currentWeekNo >= 1 && currentWeekNo <= 52) {
        items[currentWeekNo - 1]?.classList.add('open', 'current');
      }
    }
    
    // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
    function getWeatherIcon(code) {
      const icons = {
        '113': 'â˜€ï¸', '116': 'â›…', '119': 'â˜ï¸', '122': 'â˜ï¸',
        '143': 'ğŸŒ«ï¸', '176': 'ğŸŒ¦ï¸', '179': 'ğŸŒ¨ï¸', '182': 'ğŸŒ§ï¸',
        '185': 'ğŸŒ§ï¸', '200': 'â›ˆï¸', '227': 'ğŸŒ¨ï¸', '230': 'â„ï¸',
        '248': 'ğŸŒ«ï¸', '260': 'ğŸŒ«ï¸', '263': 'ğŸŒ¦ï¸', '266': 'ğŸŒ§ï¸',
        '281': 'ğŸŒ§ï¸', '284': 'ğŸŒ§ï¸', '293': 'ğŸŒ¦ï¸', '296': 'ğŸŒ§ï¸',
        '299': 'ğŸŒ§ï¸', '302': 'ğŸŒ§ï¸', '305': 'ğŸŒ§ï¸', '308': 'ğŸŒ§ï¸',
        '311': 'ğŸŒ§ï¸', '314': 'ğŸŒ§ï¸', '317': 'ğŸŒ¨ï¸', '320': 'ğŸŒ¨ï¸',
        '323': 'ğŸŒ¨ï¸', '326': 'ğŸŒ¨ï¸', '329': 'â„ï¸', '332': 'â„ï¸',
        '335': 'â„ï¸', '338': 'â„ï¸', '350': 'ğŸŒ§ï¸', '353': 'ğŸŒ¦ï¸',
        '356': 'ğŸŒ§ï¸', '359': 'ğŸŒ§ï¸', '362': 'ğŸŒ¨ï¸', '365': 'ğŸŒ¨ï¸',
        '368': 'ğŸŒ¨ï¸', '371': 'â„ï¸', '374': 'ğŸŒ¨ï¸', '377': 'ğŸŒ¨ï¸',
        '386': 'â›ˆï¸', '389': 'â›ˆï¸', '392': 'â›ˆï¸', '395': 'â„ï¸'
      };
      return icons[code] || 'ğŸŒ¤ï¸';
    }
    
    // ë‚ ì”¨ ë¡œë“œ
    async function loadWeather() {
      const location = document.getElementById('weatherLocation').value;
      const container = document.getElementById('weatherContent');
      
      try {
        container.innerHTML = '<div class="weather-loading">ë‚ ì”¨ ë¡œë”©ì¤‘...</div>';
        
        const response = await fetch(`https://wttr.in/${location}?format=j1`);
        if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        
        const data = await response.json();
        const today = data.weather[0];
        const tomorrow = data.weather[1];
        const current = data.current_condition[0];
        const currentHour = new Date().getHours();
        
        const todayIcon = getWeatherIcon(current.weatherCode);
        const tomorrowIcon = getWeatherIcon(tomorrow.hourly[4].weatherCode);
        
        // ì˜¨ë„ë³„ ìƒ‰ìƒ (ì¶”ìš¸ìˆ˜ë¡ ì ìƒ‰, ë”ìš¸ìˆ˜ë¡ íŒŒë€ìƒ‰)
        const getTempColor = (temp) => {
          const t = parseInt(temp);
          if (t <= -10) return '#ef4444'; // ë§¤ìš° ì¶”ì›€ - ë¹¨ê°•
          if (t <= -5) return '#f97316';  // ë§ì´ ì¶”ì›€ - ì£¼í™©ë¹¨ê°•
          if (t <= 0) return '#fb923c';   // ì¶”ì›€ - ì£¼í™©
          if (t <= 5) return '#fbbf24';   // ìŒ€ìŒ€ - ë…¸ë‘
          if (t <= 10) return '#facc15';  // ì„ ì„  - ë°ì€ë…¸ë‘
          if (t <= 15) return '#a3e635';  // ì ë‹¹ - ì—°ë‘
          if (t <= 20) return '#4ade80';  // ë”°ëœ» - ì´ˆë¡
          if (t <= 25) return '#22d3ee';  // ì˜¨í™” - í•˜ëŠ˜
          if (t <= 30) return '#38bdf8';  // ë”ì›€ - íŒŒë‘
          if (t <= 35) return '#3b82f6';  // ë§ì´ ë”ì›€ - ì§„íŒŒë‘
          return '#6366f1';               // ë§¤ìš° ë”ì›€ - ë³´ë¼íŒŒë‘
        };
        
        // 3ì‹œê°„ ë°ì´í„°ë¥¼ 2ì‹œê°„ ë‹¨ìœ„ë¡œ ë³´ê°„
        const interpolateHourly = (hourlyData) => {
          const result = [];
          for (let hour = 0; hour <= 22; hour += 2) {
            // í•´ë‹¹ ì‹œê°„ì— ê°€ì¥ ê°€ê¹Œìš´ 3ì‹œê°„ ë°ì´í„° ì°¾ê¸°
            const idx = Math.min(Math.floor(hour / 3), hourlyData.length - 1);
            const nextIdx = Math.min(idx + 1, hourlyData.length - 1);
            const h = hourlyData[idx];
            const hNext = hourlyData[nextIdx];
            
            // ì„ í˜• ë³´ê°„ ê³„ìˆ˜
            const hourInSlot = hour % 3;
            const ratio = hourInSlot / 3;
            
            // ì˜¨ë„ ë³´ê°„
            const temp = Math.round(parseFloat(h.tempC) * (1 - ratio) + parseFloat(hNext.tempC) * ratio);
            // ê°•ìˆ˜ í™•ë¥ ì€ ë†’ì€ ê°’ ì‚¬ìš©
            const rain = Math.max(parseInt(h.chanceofrain), parseInt(hNext.chanceofrain) * ratio);
            const snow = Math.max(parseInt(h.chanceofsnow), parseInt(hNext.chanceofsnow) * ratio);
            
            result.push({
              hour,
              temp,
              rain: Math.round(rain),
              snow: Math.round(snow),
              weatherCode: h.weatherCode,
              icon: getWeatherIcon(h.weatherCode)
            });
          }
          return result;
        };
        
        // ì‹œê°„ë³„ ë°ì´í„° ë Œë”ë§ (2ì‹œê°„ ë‹¨ìœ„)
        const renderHourly = (hourlyData, dayLabel, isToday = false) => {
          const interpolated = interpolateHourly(hourlyData);
          
          return interpolated.map(h => {
            const isNow = isToday && currentHour >= h.hour && currentHour < h.hour + 2;
            const tempColor = getTempColor(h.temp);
            
            return `
              <div class="hourly-item ${isNow ? 'now' : ''}">
                <span class="time">${h.hour}ì‹œ</span>
                <span class="icon">${h.icon}</span>
                <span class="t" style="color:${tempColor};text-shadow:0 0 4px ${tempColor}40;">${h.temp}Â°</span>
                ${h.rain > 20 ? `<span class="rain">ğŸ’§${h.rain}%</span>` : ''}
                ${h.snow > 20 ? `<span class="snow">â„ï¸${h.snow}%</span>` : ''}
              </div>
            `;
          }).join('');
        };
        
        // ì˜¤ëŠ˜ ìµœëŒ€ ê°•ìˆ˜/ì ì„¤ í™•ë¥ 
        const todayMaxRain = Math.max(...today.hourly.map(h => parseInt(h.chanceofrain)));
        const todayMaxSnow = Math.max(...today.hourly.map(h => parseInt(h.chanceofsnow)));
        const tomorrowMaxRain = Math.max(...tomorrow.hourly.map(h => parseInt(h.chanceofrain)));
        const tomorrowMaxSnow = Math.max(...tomorrow.hourly.map(h => parseInt(h.chanceofsnow)));
        
        container.innerHTML = `
          <div class="weather-grid">
            <!-- ì˜¤ëŠ˜ -->
            <div class="weather-day">
              <div class="day-header">
                <span class="day-label">ì˜¤ëŠ˜ (${today.date.slice(5)})</span>
                <span class="day-icon">${todayIcon}</span>
                <span class="day-temp">${today.mintempC}Â° ~ ${today.maxtempC}Â°C</span>
                <span class="day-desc">${current.lang_ko?.[0]?.value || current.weatherDesc[0].value}</span>
                <span class="day-precip">
                  ${todayMaxRain > 20 ? `ğŸ’§${todayMaxRain}%` : ''}
                  ${todayMaxSnow > 20 ? `â„ï¸${todayMaxSnow}%` : ''}
                </span>
              </div>
              <div class="hourly-scroll">${renderHourly(today.hourly, 'ì˜¤ëŠ˜', true)}</div>
            </div>
            
            <!-- ë‚´ì¼ -->
            <div class="weather-day">
              <div class="day-header">
                <span class="day-label">ë‚´ì¼ (${tomorrow.date.slice(5)})</span>
                <span class="day-icon">${tomorrowIcon}</span>
                <span class="day-temp">${tomorrow.mintempC}Â° ~ ${tomorrow.maxtempC}Â°C</span>
                <span class="day-desc">${tomorrow.hourly[4].lang_ko?.[0]?.value || tomorrow.hourly[4].weatherDesc[0].value}</span>
                <span class="day-precip">
                  ${tomorrowMaxRain > 20 ? `ğŸ’§${tomorrowMaxRain}%` : ''}
                  ${tomorrowMaxSnow > 20 ? `â„ï¸${tomorrowMaxSnow}%` : ''}
                </span>
              </div>
              <div class="hourly-scroll">${renderHourly(tomorrow.hourly, 'ë‚´ì¼', false)}</div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<div class="weather-loading">âš ï¸ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setTimeout(openCurrentWeek, 100);
      loadWeather(); // ë‚ ì”¨ ë¡œë“œ
    });
  </script>
</body>
</html>
