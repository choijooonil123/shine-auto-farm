<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‡ ìƒ¤ì¸ ì£¼ì°¨ë³„ ì „ë¬¸ê°€</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      font-size: 12px;
      padding: 10px;
      line-height: 1.4;
    }
    
    /* Weather Panel */
    .weather-panel {
      margin-bottom: 8px;
      padding: 10px;
      background: linear-gradient(135deg, #1e3a5f, #1e293b);
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .weather-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .weather-header .title { font-size: 12px; color: #e2e8f0; font-weight: 600; }
    .weather-header .location {
      margin-left: auto;
    }
    .weather-header select {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 3px;
      color: #e2e8f0;
      font-size: 10px;
      padding: 3px 6px;
    }
    .weather-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .weather-day {
      flex: 1;
      min-width: 280px;
      background: rgba(59,130,246,0.1);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(59,130,246,0.2);
    }
    .weather-day .day-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(59,130,246,0.2);
    }
    .weather-day .day-label { font-size: 11px; font-weight: 600; color: #e2e8f0; }
    .weather-day .day-icon { font-size: 22px; }
    .weather-day .day-temp { font-size: 14px; font-weight: 700; color: #60a5fa; }
    .weather-day .day-desc { font-size: 10px; color: #94a3b8; margin-left: auto; }
    .weather-day .day-precip { font-size: 9px; color: #38bdf8; }
    
    /* Hourly inside day */
    .hourly-scroll {
      display: flex;
      gap: 3px;
      overflow-x: auto;
      padding: 4px 0;
    }
    .hourly-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 30px;
      padding: 3px 2px;
      background: rgba(71,85,105,0.4);
      border-radius: 4px;
    }
    .hourly-item .time { font-size: 9px; color: #94a3b8; }
    .hourly-item .icon { font-size: 14px; margin: 2px 0; }
    .hourly-item .t { font-size: 11px; font-weight: 700; }
    .hourly-item .rain { font-size: 8px; color: #38bdf8; }
    .hourly-item .snow { font-size: 8px; color: #a5b4fc; }
    .hourly-item.now { background: rgba(34,197,94,0.3); border: 1px solid rgba(34,197,94,0.5); }
    
    .weather-loading { font-size: 10px; color: #64748b; padding: 20px; text-align: center; }
    
    /* Header */
    .header {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
      padding: 10px;
      background: linear-gradient(135deg, #7c3aed, #a855f7);
      border-radius: 8px;
    }
    .header h1 { font-size: 14px; flex: 1; }
    .header input {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      padding: 5px 8px;
      color: white;
      font-size: 11px;
      width: 110px;
    }
    .header input::placeholder { color: rgba(255,255,255,0.6); }
    .header .stat {
      background: rgba(0,0,0,0.2);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
    }
    .header .stat b { color: #fcd34d; }
    .header .stat.phase-stat {
      background: rgba(139, 92, 246, 0.3);
      border: 1px solid #8b5cf6;
    }
    .header .stat.phase-stat b { color: #c4b5fd; font-size: 10px; }
    
    /* Week List */
    .week-list { display: flex; flex-direction: column; gap: 2px; }
    
    /* Week Item */
    .week-item {
      background: #1e293b;
      border-radius: 4px;
      overflow: hidden;
      border-left: 3px solid #475569;
    }
    .week-item.active { border-left-color: #a855f7; }
    .week-item.current { border-left-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
    .week-item.highlight { 
      animation: highlightPulse 0.5s ease-in-out 3;
      border-left-color: #f59e0b; 
      box-shadow: 0 0 0 2px #f59e0b; 
    }
    @keyframes highlightPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* Week Header (Toggle) */
    .week-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .week-header:hover { background: #334155; }
    .week-icon { font-size: 14px; width: 20px; text-align: center; }
    .week-info { flex: 1; display: flex; align-items: baseline; gap: 6px; }
    .week-title { font-weight: 600; font-size: 11px; }
    .week-dates { font-size: 9px; color: #475569; }
    .week-alert {
      font-size: 8px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(239,68,68,0.15);
      color: #fca5a5;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .week-toggle {
      font-size: 10px;
      color: #64748b;
      transition: transform 0.3s;
    }
    .week-item.open .week-toggle { transform: rotate(180deg); }
    
    /* Week Content */
    .week-content {
      display: none;
      padding: 0 8px 12px;
    }
    .week-item.open .week-content { display: block; }
    
    /* Grid inside content */
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    
    /* Card */
    .card {
      background: #334155;
      border-radius: 6px;
      padding: 8px;
    }
    .card-title {
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Row */
    .row {
      background: #475569;
      border-radius: 3px;
      padding: 4px 6px;
      margin-bottom: 3px;
      font-size: 10px;
    }
    .row:last-child { margin-bottom: 0; }
    .row-label { font-size: 8px; color: #94a3b8; }
    .row-value { font-weight: 600; color: #f1f5f9; }
    .row-sub { font-size: 9px; color: #cbd5e1; }
    .row-ok { font-size: 8px; color: #4ade80; }
    .row-warn { font-size: 8px; color: #fbbf24; }
    
    .row.water { border-left: 2px solid #22d3ee; }
    .row.fert { border-left: 2px solid #4ade80; }
    .row.temp { border-left: 2px solid #fb923c; }
    .row.humid { border-left: 2px solid #3b82f6; }
    .row.vent { border-left: 2px solid #facc15; }
    .row.pest { border-left: 2px solid #f87171; }
    .row.pf { border-left: 2px solid #f472b6; }
    
    /* Weekly Scheduler */
    .scheduler-panel {
      margin-bottom: 12px;
      padding: 12px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 10px;
      border: 1px solid #334155;
    }
    .scheduler-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .scheduler-header .title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
    .scheduler-header .toggle { font-size: 10px; color: #64748b; margin-left: auto; }
    .scheduler-content { display: none; }
    .scheduler-panel.open .scheduler-content { display: block; }
    .scheduler-panel.open .toggle { transform: rotate(180deg); }
    
    /* Week Calendar */
    .week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      width: 100%;
    }
    .day-column {
      background: #1e293b;
      border-radius: 6px;
      padding: 8px 6px;
      min-height: 200px;
    }
    .day-column.blocked {
      background: #18181b;
      opacity: 0.6;
    }
    .day-column.today {
      border: 2px solid #22c55e;
    }
    .day-header-cal {
      text-align: center;
      padding-bottom: 6px;
      border-bottom: 1px solid #334155;
      margin-bottom: 6px;
    }
    .day-name { font-size: 10px; color: #94a3b8; }
    .day-date { font-size: 12px; font-weight: 600; color: #fef08a; }
    .weather-row {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 4px;
    }
    .day-weather {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 8px;
      color: #64748b;
      padding: 3px 5px;
      border-radius: 4px;
      background: rgba(0,0,0,0.2);
    }
    .day-weather.historical {
      border: 1px solid #fbbf24;
    }
    .day-weather.historical .temp { color: #fbbf24; }
    .day-weather.historical .weather-label { color: #fbbf24; font-size: 7px; }
    .day-weather.realtime {
      border: 1px solid #22c55e;
    }
    .day-weather.realtime .temp { color: #22c55e; }
    .day-weather.realtime .weather-label { color: #22c55e; font-size: 7px; }
    .day-weather .temp { font-weight: 600; }
    .day-weather .rain { color: #38bdf8; }
    .day-blocked-label {
      text-align: center;
      font-size: 9px;
      color: #ef4444;
      padding: 10px 0;
    }
    
    /* Hourly Climate Display */
    .hourly-climate {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-top: 4px;
      padding: 4px;
      background: rgba(71, 85, 105, 0.3);
      border-radius: 4px;
    }
    .hourly-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 8px;
    }
    .h-time { color: #64748b; width: 20px; }
    .h-temp { color: #fbbf24; font-weight: 600; width: 28px; text-align: right; }
    .h-humid { color: #38bdf8; width: 28px; text-align: right; }
    
    /* Historical label */
    .hourly-climate::before {
      content: 'ğŸ“… 5ë…„í‰ê·  ì‹œê°„ë³„';
      display: block;
      font-size: 7px;
      color: #fbbf24;
      margin-bottom: 2px;
      opacity: 0.8;
    }
    
    /* Weather Source Badges */
    .historical-badge {
      font-size: 7px;
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.15);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .realtime-badge {
      font-size: 7px;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
      padding: 1px 4px;
      border-radius: 3px;
    }
    
    /* Weather Alerts */
    .weather-alerts {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-top: 4px;
    }
    .alert-badge {
      font-size: 7px;
      padding: 2px 4px;
      border-radius: 3px;
      white-space: nowrap;
    }
    .alert-badge.EXTREME_HEAT { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .alert-badge.HEAT_WAVE { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .alert-badge.TROPICAL_NIGHT { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
    .alert-badge.HEAVY_RAIN { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .alert-badge.MONSOON { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
    .alert-badge.LOCALIZED_STORM { background: rgba(30, 64, 175, 0.2); color: #60a5fa; }
    .alert-badge.COLD_SNAP { background: rgba(14, 165, 233, 0.2); color: #0ea5e9; }
    .alert-badge.FROST { background: rgba(224, 242, 254, 0.3); color: #bae6fd; }
    
    .day-column.has-alert {
      border: 1px solid rgba(239, 68, 68, 0.4);
    }
    .day-column.has-severe-alert {
      border: 2px solid rgba(239, 68, 68, 0.6);
      background: linear-gradient(135deg, #1e293b, rgba(127, 29, 29, 0.2));
    }
    
    /* Alert recommendation */
    .alert-recommendation {
      font-size: 8px;
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
      padding: 4px 6px;
      border-radius: 4px;
      margin-top: 4px;
      border-left: 2px solid #fbbf24;
    }
    
    /* 52ì£¼ ì „ì²´ ì‘ì—… ë°°ì¹˜í‘œ */
    .all-weeks-schedule {
      margin-bottom: 12px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 10px;
      border: 1px solid #334155;
      overflow: hidden;
    }
    .all-weeks-header {
      display: flex;
      align-items: center;
      padding: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #4c1d95, #1e1b4b);
    }
    .all-weeks-header:hover { background: linear-gradient(135deg, #5b21b6, #2e1065); }
    .all-weeks-header .title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
    .all-weeks-header .toggle { margin-left: auto; font-size: 10px; color: #94a3b8; transition: transform 0.3s; }
    .all-weeks-schedule.open .all-weeks-header .toggle { transform: rotate(180deg); }
    
    .all-weeks-content {
      padding: 12px;
      max-height: 600px;
      overflow-y: auto;
    }
    .all-weeks-loading {
      text-align: center;
      color: #64748b;
      padding: 20px;
      font-size: 11px;
    }
    
    /* ì‘ì—…ë³„ ì—°ê°„ ìŠ¤ì¼€ì¤„ */
    .task-yearly-schedule {
      margin-bottom: 12px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 10px;
      border: 1px solid #334155;
      overflow: hidden;
    }
    .task-yearly-header {
      display: flex;
      align-items: center;
      padding: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #065f46, #064e3b);
    }
    .task-yearly-header:hover { background: linear-gradient(135deg, #047857, #065f46); }
    .task-yearly-header .title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
    .task-yearly-header .toggle { margin-left: auto; font-size: 10px; color: #94a3b8; transition: transform 0.3s; }
    .task-yearly-schedule.open .task-yearly-header .toggle { transform: rotate(180deg); }
    
    .task-yearly-content {
      padding: 12px;
      max-height: 500px;
      overflow-y: auto;
    }
    .task-filter {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    .task-filter label { font-size: 11px; color: #94a3b8; }
    .task-filter select {
      background: #334155;
      border: 1px solid #475569;
      color: #e2e8f0;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
    }
    .task-yearly-grid {
      display: grid;
      grid-template-columns: repeat(13, 1fr);
      gap: 2px;
    }
    .task-yearly-cell {
      background: #1e293b;
      padding: 4px;
      text-align: center;
      font-size: 8px;
      border-radius: 3px;
      min-height: 28px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .task-yearly-cell.header {
      background: #334155;
      font-weight: 600;
      color: #e2e8f0;
      font-size: 9px;
    }
    .task-yearly-cell.week-label {
      background: #475569;
      color: #cbd5e1;
      font-size: 7px;
    }
    .task-yearly-cell.has-task {
      background: rgba(34, 197, 94, 0.3);
      border: 1px solid #22c55e;
    }
    .task-yearly-cell.has-task.GA { background: rgba(16, 185, 129, 0.3); border-color: #10b981; }
    .task-yearly-cell.has-task.SPRAY { background: rgba(245, 158, 11, 0.3); border-color: #f59e0b; }
    .task-yearly-cell.has-task.WATER { background: rgba(56, 189, 248, 0.3); border-color: #38bdf8; }
    .task-yearly-cell.has-task.FERTILIZER { background: rgba(34, 197, 94, 0.3); border-color: #22c55e; }
    .task-yearly-cell.has-task.PF { background: rgba(139, 92, 246, 0.3); border-color: #8b5cf6; }
    .task-yearly-cell.has-task.PRUNING { background: rgba(236, 72, 153, 0.3); border-color: #ec4899; }
    .task-yearly-cell.has-task.BAGGING { background: rgba(251, 191, 36, 0.3); border-color: #fbbf24; }
    .task-yearly-cell.has-task.HARVEST { background: rgba(168, 85, 247, 0.3); border-color: #a855f7; }
    .task-yearly-cell.has-task.HUMIDITY { background: rgba(6, 182, 212, 0.3); border-color: #06b6d4; }
    .task-yearly-cell .task-icon { font-size: 10px; }
    .task-yearly-cell .task-count { font-size: 7px; color: #94a3b8; }
    .task-yearly-cell.current { box-shadow: 0 0 0 2px #22c55e; }
    .task-yearly-loading {
      text-align: center;
      color: #64748b;
      padding: 20px;
      font-size: 11px;
    }
    
    /* ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„ ì¹´ë“œ */
    .week-schedule-card {
      background: #1e293b;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #475569;
      overflow: hidden;
    }
    .week-schedule-card.current { border-left-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
    
    .week-schedule-header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      gap: 8px;
    }
    .week-schedule-header:hover { background: #334155; }
    .week-schedule-icon { font-size: 16px; }
    .week-schedule-title { font-size: 11px; font-weight: 600; color: #e2e8f0; }
    .week-schedule-dates { font-size: 9px; color: #64748b; }
    .week-schedule-climate {
      margin-left: auto;
      font-size: 9px;
      color: #fbbf24;
      display: flex;
      gap: 8px;
    }
    .week-schedule-toggle { font-size: 10px; color: #64748b; }
    
    .week-schedule-content {
      display: none;
      padding: 0 12px 12px;
    }
    .week-schedule-card.open .week-schedule-content { display: block; }
    .week-schedule-card.open .week-schedule-toggle { transform: rotate(180deg); }
    
    /* ìš”ì¼ë³„ ì‘ì—… ê·¸ë¦¬ë“œ */
    .week-day-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }
    .day-schedule-item {
      background: #334155;
      border-radius: 6px;
      padding: 8px;
      min-height: 80px;
    }
    .day-schedule-item.blocked {
      background: #18181b;
      opacity: 0.5;
    }
    .day-schedule-name {
      font-size: 10px;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 4px;
      padding-bottom: 4px;
      border-bottom: 1px solid #475569;
    }
    .day-schedule-climate {
      font-size: 8px;
      color: #64748b;
      margin-bottom: 6px;
    }
    .day-schedule-tasks {
      font-size: 8px;
    }
    .day-task-item {
      background: #475569;
      padding: 3px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      border-left: 2px solid #a855f7;
    }
    .day-task-item.weather-sensitive { border-left-color: #fbbf24; }
    .day-task-item.weather-independent { border-left-color: #64748b; }
    
    /* 52ì£¼ ì „ì²´ ìº˜ë¦°ë” (í˜„ì¬ ì£¼ì™€ ë™ì¼ í˜•íƒœ) */
    .week-full-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width: 100%;
    }
    .week-calendar-full {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width: 100%;
    }
    .day-col-full {
      background: #0f172a;
      border-radius: 8px;
      padding: 12px;
      min-height: 200px;
    }
    .day-col-full.blocked {
      background: #18181b;
      opacity: 0.6;
      min-height: 100px;
    }
    .day-header-full {
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
      margin-bottom: 8px;
    }
    .day-name-full {
      font-size: 13px;
      font-weight: 700;
      color: #e2e8f0;
      padding: 6px 0;
    }
    .day-col-full:first-child .day-name-full { color: #ef4444; }
    .day-col-full:last-child .day-name-full { color: #3b82f6; }
    .day-climate-full {
      margin-top: 6px;
    }
    .badge-5yr {
      font-size: 8px;
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .hourly-mini {
      margin-top: 6px;
      background: rgba(71, 85, 105, 0.4);
      border-radius: 4px;
      padding: 6px;
    }
    .hm-row {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      padding: 2px 0;
    }
    .hm-t { color: #94a3b8; width: 20px; font-weight: 500; }
    .hm-temp { color: #fbbf24; width: 32px; text-align: right; font-weight: 600; }
    .hm-hum { color: #38bdf8; width: 32px; text-align: right; font-weight: 600; }
    
    .blocked-label {
      font-size: 11px;
      color: #ef4444;
      padding: 25px 0;
      font-weight: 600;
    }
    
    .day-tasks-full {
      font-size: 9px;
      margin-top: 8px;
    }
    .no-task {
      color: #64748b;
      text-align: center;
      padding: 20px 0;
      font-size: 10px;
    }
    .task-item-full {
      background: #334155;
      border-radius: 4px;
      padding: 8px 10px;
      margin-bottom: 5px;
      border-left: 3px solid #a855f7;
    }
    .task-item-full.ws { border-left-color: #fbbf24; }
    .task-item-full.wi { border-left-color: #64748b; }
    .task-item-full.water { border-left-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
    .task-item-full.fertilizer { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); cursor: pointer; }
    .task-item-full.fertilizer:hover { background: rgba(34, 197, 94, 0.2); }
    .task-item-full.spray { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); cursor: pointer; }
    .task-item-full.spray:hover { background: rgba(245, 158, 11, 0.2); }
    .task-item-full.pf { border-left-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); cursor: pointer; }
    .task-item-full.pf:hover { background: rgba(139, 92, 246, 0.2); }
    .task-item-full.humidity { border-left-color: #06b6d4; background: rgba(6, 182, 212, 0.1); cursor: pointer; }
    .task-item-full.humidity:hover { background: rgba(6, 182, 212, 0.2); }
    .task-time-full { color: #fef08a; font-size: 9px; }
    .task-detail-full {
      display: none;
      margin-top: 6px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      font-size: 8px;
      color: #94a3b8;
      white-space: pre-line;
      line-height: 1.4;
    }
    .task-item-full.open .task-detail-full { display: block; }
    .task-name-full { color: #e2e8f0; font-size: 10px; font-weight: 600; margin: 3px 0; }
    .task-cond-full { color: #fbbf24; font-size: 9px; }
    
    /* ì£¼ì°¨ë³„ ë‚´ì¥ ìŠ¤ì¼€ì¤„ëŸ¬ */
    .week-scheduler-section {
      margin-top: 12px;
      padding: 12px;
      background: linear-gradient(135deg, #1e1b4b, #0f172a);
      border-radius: 8px;
      border: 1px solid #4c1d95;
      width: 100%;
      box-sizing: border-box;
    }
    .week-scheduler-title {
      font-size: 12px;
      font-weight: 600;
      color: #a855f7;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px;
      background: rgba(168, 85, 247, 0.1);
      border-radius: 6px;
      transition: background 0.2s;
    }
    .week-scheduler-title:hover {
      background: rgba(168, 85, 247, 0.2);
    }
    .week-scheduler-toggle {
      margin-left: auto;
      font-size: 10px;
      color: #94a3b8;
      transition: transform 0.3s;
    }
    .week-scheduler-section.open .week-scheduler-toggle {
      transform: rotate(180deg);
    }
    .week-scheduler-section.open .week-scheduler-title {
      margin-bottom: 10px;
    }
    .week-scheduler-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      width: 100%;
    }
    .wsc-day {
      background: #1e293b;
      border-radius: 8px;
      padding: 12px;
      min-height: 200px;
    }
    .wsc-day.blocked {
      background: #18181b;
      opacity: 0.6;
      min-height: 80px;
    }
    .wsc-day.today {
      border: 2px solid #22c55e;
    }
    .wsc-day.has-alert {
      border: 1px solid rgba(239, 68, 68, 0.4);
    }
    .wsc-day.has-severe-alert {
      border: 2px solid rgba(239, 68, 68, 0.6);
      background: linear-gradient(135deg, #1e293b, rgba(127, 29, 29, 0.2));
    }
    .wsc-header {
      text-align: center;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
      margin-bottom: 8px;
    }
    .wsc-dayname { 
      font-size: 13px; 
      font-weight: 700; 
      color: #e2e8f0;
      padding: 6px 0;
    }
    .wsc-day:first-child .wsc-dayname { color: #ef4444; }
    .wsc-day:last-child .wsc-dayname { color: #3b82f6; }
    .wsc-badge { 
      display: inline-block;
      font-size: 8px; 
      color: #fbbf24; 
      background: rgba(251,191,36,0.2); 
      padding: 2px 6px; 
      border-radius: 4px; 
      margin-top: 4px;
      font-weight: 500;
    }
    .wsc-climate {
      margin-top: 6px;
      background: rgba(71,85,105,0.4);
      border-radius: 4px;
      padding: 6px;
    }
    .wsc-climate-row {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      padding: 2px 0;
    }
    /* ì‹œê°„ë³„ ìŠ¤í¬ë¡¤ (ì˜¤ëŠ˜Â·ë‚´ì¼ ìŠ¤íƒ€ì¼) */
    .wsc-hourly-scroll {
      display: flex;
      gap: 2px;
      overflow-x: auto;
      padding: 4px 0;
      margin-top: 4px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .wsc-hourly-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 32px;
      padding: 3px 2px;
      background: rgba(71,85,105,0.3);
      border-radius: 3px;
    }
    .wsc-h-time {
      font-size: 8px;
      color: #fef08a;
      font-weight: 500;
    }
    .wsc-h-temp {
      font-size: 10px;
      font-weight: 600;
    }
    .wsc-h-hum {
      font-size: 7px;
      color: #67e8f9;
    }
    .wsc-hr { color: #94a3b8; width: 20px; font-weight: 500; }
    .wsc-temp { color: #fbbf24; width: 32px; text-align: right; font-weight: 600; }
    .wsc-hum { color: #38bdf8; width: 32px; text-align: right; font-weight: 600; }
    .wsc-blocked-label {
      text-align: center;
      font-size: 11px;
      color: #ef4444;
      padding: 25px 0;
      font-weight: 600;
    }
    .wsc-tasks { margin-top: 6px; }
    .wsc-task {
      background: #334155;
      border-radius: 4px;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-left: 3px solid #a855f7;
      font-size: 9px;
    }
    .wsc-task.ws { border-left-color: #fbbf24; }
    .wsc-task.wi { border-left-color: #64748b; }
    .wsc-task.water { border-left-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
    .wsc-task.fertilizer { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); cursor: pointer; }
    .wsc-task.fertilizer:hover { background: rgba(34, 197, 94, 0.2); }
    .wsc-task.spray { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); cursor: pointer; }
    .wsc-task.spray:hover { background: rgba(245, 158, 11, 0.2); }
    .wsc-task.pf { border-left-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); cursor: pointer; }
    .wsc-task.pf:hover { background: rgba(139, 92, 246, 0.2); }
    .wsc-task.humidity { border-left-color: #06b6d4; background: rgba(6, 182, 212, 0.1); cursor: pointer; }
    .wsc-task.humidity:hover { background: rgba(6, 182, 212, 0.2); }
    .wsc-task-time { color: #fef08a; font-size: 8px; }
    .wsc-task-detail {
      display: none;
      margin-top: 6px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      font-size: 8px;
      color: #94a3b8;
      white-space: pre-line;
      line-height: 1.4;
    }
    .wsc-task.open .wsc-task-detail { display: block; }
    .wsc-task-name { color: #e2e8f0; font-weight: 600; margin: 2px 0; font-size: 9px; }
    .wsc-task-cond { font-size: 8px; }
    .wsc-no-task { color: #64748b; text-align: center; padding: 15px 0; font-size: 10px; }
    
    /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
    .wsc-task[draggable="true"] { cursor: grab; }
    .wsc-task[draggable="true"]:active { cursor: grabbing; }
    .wsc-task.dragging { opacity: 0.5; transform: scale(0.95); }
    .wsc-day.drag-over { background: rgba(59, 130, 246, 0.2); border: 2px dashed #3b82f6; }
    .wsc-day.drag-over .wsc-tasks { min-height: 50px; }
    .task-item-full[draggable="true"] { cursor: grab; }
    .task-item-full[draggable="true"]:active { cursor: grabbing; }
    .task-item-full.dragging { opacity: 0.5; transform: scale(0.95); }
    .day-column-full.drag-over, .day-col-full.drag-over { background: rgba(59, 130, 246, 0.2); border: 2px dashed #3b82f6; }
    .drag-hint { font-size: 8px; color: #64748b; text-align: center; margin-top: 4px; }
    .drag-hint::before { content: 'â†”ï¸ '; }
    .reset-moves-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      margin-left: auto;
      margin-right: 10px;
    }
    .reset-moves-btn:hover { background: #dc2626; }
    
    /* ì‘ì—… ìƒíƒœ ë²„íŠ¼ */
    .task-actions {
      display: flex;
      flex-direction: row;
      gap: 4px;
      margin-top: 4px;
      justify-content: flex-start;
      align-items: center;
    }
    .task-action-btn {
      background: #475569;
      color: #e2e8f0;
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      font-size: 9px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .task-action-btn:hover { background: #64748b; }
    .task-action-btn.complete { background: rgba(34, 197, 94, 0.3); color: #86efac; }
    .task-action-btn.complete:hover { background: rgba(34, 197, 94, 0.5); }
    .task-action-btn.delete { background: rgba(239, 68, 68, 0.25); color: #fca5a5; }
    .task-action-btn.delete:hover { background: rgba(239, 68, 68, 0.4); }
    .task-action-btn.restore { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
    .task-action-btn.restore:hover { background: rgba(59, 130, 246, 0.5); }
    .task-action-btn.permanent-delete { background: rgba(127, 29, 29, 0.4); color: #fecaca; }
    .task-action-btn.permanent-delete:hover { background: rgba(127, 29, 29, 0.6); }
    
    /* ì™„ë£Œëœ ì‘ì—… ìŠ¤íƒ€ì¼ */
    .wsc-task.completed, .task-item-full.completed {
      opacity: 0.6;
      background: rgba(34, 197, 94, 0.1) !important;
      border-left-color: #22c55e !important;
    }
    .wsc-task.completed .wsc-task-name, .task-item-full.completed .task-name-full {
      text-decoration: line-through;
      color: #22c55e;
    }
    
    /* ì‚­ì œëœ ì‘ì—… ìŠ¤íƒ€ì¼ */
    .wsc-task.deleted, .task-item-full.deleted {
      opacity: 0.4;
      background: rgba(239, 68, 68, 0.1) !important;
      border-left-color: #ef4444 !important;
    }
    .wsc-task.deleted .wsc-task-name, .task-item-full.deleted .task-name-full {
      text-decoration: line-through;
      color: #ef4444;
    }
    
    /* ì´ì›”ëœ ì‘ì—… í‘œì‹œ */
    .task-carried-over {
      font-size: 7px;
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.2);
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 4px;
    }
    
    /* ì‘ì—… ìƒíƒœ ìš”ì•½ */
    .task-status-summary {
      display: flex;
      gap: 8px;
      font-size: 9px;
      margin-top: 6px;
      padding: 4px 8px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .status-item { display: flex; align-items: center; gap: 3px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; }
    .status-dot.pending { background: #fbbf24; }
    .status-dot.completed { background: #22c55e; }
    .status-dot.deleted { background: #ef4444; }
    
    /* Scheduled Tasks */
    .scheduled-task {
      background: #334155;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 4px;
      font-size: 9px;
      border-left: 3px solid #a855f7;
    }
    .scheduled-task.GA { border-left-color: #10b981; }
    .scheduled-task.SPRAY { border-left-color: #f59e0b; }
    .scheduled-task.WATER { border-left-color: #3b82f6; }
    .scheduled-task.PRUNING { border-left-color: #ec4899; }
    .scheduled-task.HARVEST { border-left-color: #22c55e; }
    .scheduled-task.warning { border-left-color: #ef4444; background: rgba(239,68,68,0.1); }
    .scheduled-task.weather-independent { border-left-color: #64748b; background: rgba(100, 116, 139, 0.15); }
    .scheduled-task.PURCHASE { border-left-color: #94a3b8; }
    .scheduled-task.EQUIPMENT { border-left-color: #78716c; }
    .scheduled-task.PLANNING { border-left-color: #a1a1aa; }
    .scheduled-task.HEATING { border-left-color: #f97316; }
    .scheduled-task.CLEANING { border-left-color: #71717a; }
    .scheduled-task.OBSERVATION { border-left-color: #a3a3a3; }
    .scheduled-task.SENSOR { border-left-color: #6b7280; }
    .scheduled-task.CUSTOM { border-left-color: #a855f7; background: rgba(168, 85, 247, 0.15); }
    .scheduled-task.CUSTOM::before {
      content: 'âœï¸';
      font-size: 8px;
      margin-right: 4px;
    }
    .scheduled-task.water-task { border-left-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
    .scheduled-task.fertilizer-task { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); cursor: pointer; }
    .scheduled-task.fertilizer-task:hover { background: rgba(34, 197, 94, 0.2); }
    .scheduled-task.pf-task { border-left-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); cursor: pointer; }
    .scheduled-task.pf-task:hover { background: rgba(139, 92, 246, 0.2); }
    .scheduled-task.spray-task { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); cursor: pointer; }
    .scheduled-task.spray-task:hover { background: rgba(245, 158, 11, 0.2); }
    .scheduled-task.FERTILIZER { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
    .scheduled-task.PF { border-left-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
    .scheduled-task.HUMIDITY { border-left-color: #06b6d4; background: rgba(6, 182, 212, 0.1); }
    .scheduled-task.humidity-task { border-left-color: #06b6d4; background: rgba(6, 182, 212, 0.1); cursor: pointer; }
    .scheduled-task.humidity-task:hover { background: rgba(6, 182, 212, 0.2); }
    
    /* ì™„ë£Œ/ì‚­ì œ ìƒíƒœ */
    .scheduled-task.completed {
      opacity: 0.6;
      background: rgba(34, 197, 94, 0.1) !important;
      border-left-color: #22c55e !important;
    }
    .scheduled-task.completed .task-name {
      text-decoration: line-through;
      color: #22c55e;
    }
    .scheduled-task.deleted {
      opacity: 0.4;
      background: rgba(239, 68, 68, 0.1) !important;
      border-left-color: #ef4444 !important;
    }
    .scheduled-task.deleted .task-name {
      text-decoration: line-through;
      color: #ef4444;
    }
    
    /* ìƒì„¸ ë‚´ìš© í‘œì‹œ */
    .scheduled-task .wsc-task-detail {
      display: none;
      margin-top: 6px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      font-size: 9px;
      color: #94a3b8;
      white-space: pre-line;
      line-height: 1.5;
    }
    .scheduled-task.open .wsc-task-detail { display: block; }
    .scheduled-task[onclick] { cursor: pointer; }
    .scheduled-task[onclick]:hover { background: rgba(255,255,255,0.05); }
    
    .task-time { color: #fef08a; font-size: 8px; }
    .task-name { color: #e2e8f0; font-weight: 500; margin-top: 2px; }
    .task-weather-info { color: #64748b; font-size: 8px; margin-top: 2px; }
    
    /* Collapsible Section */
    .collapsible-section {
      margin-top: 10px;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #334155;
      overflow: hidden;
    }
    .collapsible-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
      font-size: 11px;
      color: #94a3b8;
      background: rgba(71, 85, 105, 0.3);
      transition: background 0.2s;
    }
    .collapsible-header:hover {
      background: rgba(71, 85, 105, 0.5);
    }
    .collapsible-toggle {
      margin-left: auto;
      font-size: 10px;
      color: #64748b;
      transition: transform 0.3s;
    }
    .collapsible-section.open .collapsible-toggle {
      transform: rotate(180deg);
    }
    .collapsible-content {
      display: none;
      padding: 12px;
    }
    .collapsible-section.open .collapsible-content {
      display: block;
    }
    
    /* Custom Task Section */
    .custom-task-section {
      margin-top: 12px;
      padding: 12px;
      background: rgba(168, 85, 247, 0.1);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 8px;
    }
    .custom-task-form {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .custom-task-form input, .custom-task-form select {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 10px;
      padding: 6px 8px;
    }
    .custom-task-form input[type="text"] { min-width: 150px; }
    .custom-task-form button {
      background: #a855f7;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      padding: 6px 12px;
    }
    .custom-task-form button:hover { background: #9333ea; }
    
    .custom-task-list {
      max-height: 120px;
      overflow-y: auto;
    }
    .custom-task-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: #1e293b;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 9px;
      border-left: 3px solid #a855f7;
    }
    .custom-task-item.weather-sensitive { border-left-color: #fbbf24; }
    .custom-task-item .task-delete {
      margin-left: auto;
      color: #ef4444;
      cursor: pointer;
      font-size: 12px;
    }
    
    /* External Events */
    .external-events {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #334155;
    }
    .event-form {
      display: grid;
      grid-template-columns: 1fr 100px 60px 60px auto;
      gap: 6px;
      margin-bottom: 8px;
    }
    .event-form input, .event-form select {
      background: #334155;
      border: 1px solid #475569;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 10px;
      padding: 6px 8px;
    }
    .event-form button {
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      padding: 6px 10px;
    }
    .event-form button:hover { background: #4f46e5; }
    
    .event-list {
      max-height: 100px;
      overflow-y: auto;
    }
    .event-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      background: #1e293b;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 9px;
    }
    .event-item .event-delete {
      margin-left: auto;
      color: #ef4444;
      cursor: pointer;
      font-size: 12px;
    }
    
    /* Unscheduled Tasks */
    .unscheduled-section {
      margin-top: 12px;
      padding: 10px;
      background: rgba(239,68,68,0.1);
      border-radius: 6px;
      border: 1px solid rgba(239,68,68,0.3);
    }
    .unscheduled-title {
      font-size: 10px;
      color: #fca5a5;
      margin-bottom: 6px;
    }
    
    /* Badge */
    .badge {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 6px;
      font-size: 8px;
      font-weight: 600;
    }
    .badge.h { background: rgba(239,68,68,0.2); color: #f87171; }
    .badge.m { background: rgba(250,204,21,0.2); color: #fbbf24; }
    .badge.l { background: rgba(74,222,128,0.2); color: #4ade80; }
    .badge.pf { background: rgba(244,114,182,0.2); color: #f472b6; }
    .badge.current { background: #22c55e; color: white; }
    
    /* Task List */
    .task-list { display: flex; flex-wrap: wrap; gap: 4px; }
    .task {
      background: #475569;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 9px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .task input[type="checkbox"] {
      width: 12px;
      height: 12px;
      accent-color: #a855f7;
      cursor: pointer;
      margin: 0;
    }
    .task.checked span { opacity: 0.5; text-decoration: line-through; }
    
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>ğŸ‡ ìƒ¤ì¸ ì£¼ì°¨ë³„ ì „ë¬¸ê°€</h1>
    <span style="color:#fef08a; font-size:11px; margin-right:2px;">ì—´ê°€ë‘ :</span>
    <input type="date" id="heatStart" value="2025-01-19" title="ì—´ê°€ë‘  ì‹œì‘ì¼">
    <span style="color:#fef08a; font-size:11px; margin-left:8px; margin-right:2px;">ì˜¤ëŠ˜:</span>
    <span id="todayDateDisplay" style="color:#e2e8f0; font-size:12px; font-weight:600; margin-right:8px;"></span>
    <input type="date" id="targetDate" title="ë¶„ì„ì¼" style="display:none;">
    <div class="stat">ë‚¨ì€ ì£¼ <b id="dWeek">-</b></div>
    <div class="stat">ë‚¨ì€ ì¼ <b id="dDays">-</b></div>
    <div class="stat phase-stat"><b id="dPhase">-</b></div>
  </div>
  
  <!-- Weather Panel -->
  <div class="weather-panel">
    <div class="weather-header">
      <span class="title">ğŸŒ¤ï¸ ì˜¤ëŠ˜Â·ë‚´ì¼ ë‚ ì”¨</span>
      <div class="location">
        <select id="weatherLocation" onchange="loadWeather(); loadScheduler();">
          <option value="Gimcheon">ê¹€ì²œ</option>
          <option value="Sangju">ìƒì£¼</option>
          <option value="Yeongcheon">ì˜ì²œ</option>
          <option value="Gyeongsan">ê²½ì‚°</option>
          <option value="Daegu">ëŒ€êµ¬</option>
        </select>
      </div>
    </div>
    <div id="weatherContent"><div class="weather-loading">ë‚ ì”¨ ë¡œë”©ì¤‘...</div></div>
  </div>
  
  <!-- Weekly Scheduler -->
  <div class="scheduler-panel open" id="schedulerPanel">
    <div class="scheduler-header" onclick="toggleScheduler()">
      <span class="title">ğŸ—“ï¸ ì£¼ê°„ ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬</span>
      <span style="font-size:10px; color:#94a3b8; margin-left:10px;">ë‚ ì”¨ ê¸°ë°˜ ìë™ ì‘ì—… ë°°ì¹˜ | â†”ï¸ ë“œë˜ê·¸ë¡œ ì‘ì—… ì´ë™</span>
      <button class="reset-moves-btn" onclick="event.stopPropagation(); carryOverManually();" title="ì´ì „ ì£¼ ë¯¸ì™„ë£Œ ì‘ì—… ì´ì›”" style="background:#f59e0b;">ğŸ“Œ ì´ì›”</button>
      <button class="reset-moves-btn" onclick="event.stopPropagation(); resetTaskMoves();" title="ì‘ì—… ì´ë™ ì´ˆê¸°í™”">ğŸ”„ ì´ë™ì´ˆê¸°í™”</button>
      <button class="reset-moves-btn" onclick="event.stopPropagation(); resetAllTaskStates();" title="ì‘ì—… ìƒíƒœ ì´ˆê¸°í™”">ğŸ—‘ï¸ ìƒíƒœì´ˆê¸°í™”</button>
      <span class="toggle">â–¼</span>
    </div>
    <div class="scheduler-content">
      <div class="week-calendar" id="weekCalendar">
        <div class="weather-loading">ìŠ¤ì¼€ì¤„ ë¡œë”©ì¤‘...</div>
      </div>
      
      <!-- ë°°ì¹˜ ë¶ˆê°€ ì‘ì—… (ë¹„í™œì„±í™”)
      <div class="unscheduled-section" id="unscheduledSection" style="display:none;">
        <div class="unscheduled-title">âš ï¸ ì´ë²ˆ ì£¼ ë°°ì¹˜ ë¶ˆê°€ ì‘ì—… (ë‚ ì”¨ ì¡°ê±´ ë¶ˆì¶©ì¡±)</div>
        <div id="unscheduledTasks"></div>
      </div>
      -->
      
      <!-- ì‚¬ìš©ì ì‘ì—… ì¶”ê°€ -->
      <div class="collapsible-section" id="customTaskSection">
        <div class="collapsible-header" onclick="toggleCollapsible('customTaskSection')">
          <span>âœï¸ ì‘ì—… ì¼ì • ì¶”ê°€</span>
          <span style="color:#64748b; font-size:9px; margin-left:8px;">(ì‚¬ìš©ì ì •ì˜ ì‘ì—…)</span>
          <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
          <div class="custom-task-form">
            <input type="text" id="customTaskName" placeholder="ì‘ì—…ëª… (ì˜ˆ: ë¹„ë£Œ ì‚´í¬, ë³‘í•´ ì ê²€)" style="flex:2;" />
            <input type="date" id="customTaskDate" />
            <select id="customTaskStart">
              <option value="6">06:00</option>
              <option value="7">07:00</option>
              <option value="8">08:00</option>
              <option value="9" selected>09:00</option>
              <option value="10">10:00</option>
              <option value="11">11:00</option>
              <option value="12">12:00</option>
              <option value="13">13:00</option>
              <option value="14">14:00</option>
              <option value="15">15:00</option>
              <option value="16">16:00</option>
              <option value="17">17:00</option>
            </select>
            <select id="customTaskDuration">
              <option value="1">1ì‹œê°„</option>
              <option value="2" selected>2ì‹œê°„</option>
              <option value="3">3ì‹œê°„</option>
              <option value="4">4ì‹œê°„</option>
              <option value="6">6ì‹œê°„</option>
            </select>
            <select id="customTaskType">
              <option value="weather">ğŸŒ¡ï¸ ë‚ ì”¨ê³ ë ¤</option>
              <option value="independent">ğŸ“¦ ë‚ ì”¨ë¬´ê´€</option>
            </select>
            <button onclick="addCustomTask()">ì¶”ê°€</button>
          </div>
          <div class="custom-task-list" id="customTaskList"></div>
        </div>
      </div>
      
      <!-- ì™¸ë¶€ ì¼ì • ê´€ë¦¬ -->
      <div class="collapsible-section" id="externalEventSection">
        <div class="collapsible-header" onclick="toggleCollapsible('externalEventSection')">
          <span>ğŸ“… ì™¸ë¶€ ì¼ì • ì¶”ê°€</span>
          <span style="color:#64748b; font-size:9px; margin-left:8px;">(ì‘ì—… ë¶ˆê°€ ì‹œê°„)</span>
          <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
          <div class="event-form">
            <input type="text" id="eventName" placeholder="ì¼ì •ëª… (ì˜ˆ: ë³‘ì›, ëª¨ì„)" />
            <input type="date" id="eventDate" />
            <select id="eventStart">
              <option value="6">06:00</option>
              <option value="7">07:00</option>
              <option value="8">08:00</option>
              <option value="9" selected>09:00</option>
              <option value="10">10:00</option>
              <option value="11">11:00</option>
              <option value="12">12:00</option>
              <option value="13">13:00</option>
              <option value="14">14:00</option>
              <option value="15">15:00</option>
              <option value="16">16:00</option>
              <option value="17">17:00</option>
              <option value="18">18:00</option>
            </select>
            <select id="eventEnd">
              <option value="7">07:00</option>
              <option value="8">08:00</option>
              <option value="9">09:00</option>
              <option value="10">10:00</option>
              <option value="11">11:00</option>
              <option value="12" selected>12:00</option>
              <option value="13">13:00</option>
              <option value="14">14:00</option>
              <option value="15">15:00</option>
              <option value="16">16:00</option>
              <option value="17">17:00</option>
              <option value="18">18:00</option>
              <option value="19">19:00</option>
              <option value="20">20:00</option>
            </select>
            <button onclick="addExternalEvent()">ì¶”ê°€</button>
          </div>
          <div class="event-list" id="eventList"></div>
        </div>
      </div>
      
      <!-- ìë™ ë°°ì¹˜ ê¸°ì¤€ -->
      <div class="collapsible-section" id="autoPlacementSection">
        <div class="collapsible-header" onclick="toggleCollapsible('autoPlacementSection')">
          <span>ğŸ“‹ ìë™ ë°°ì¹˜ ê¸°ì¤€</span>
          <span style="color:#64748b; font-size:9px; margin-left:8px;">(ì‘ì—… ì¡°ê±´ ì•ˆë‚´)</span>
          <span class="collapsible-toggle">â–¼</span>
        </div>
        <div class="collapsible-content">
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
            
            <!-- ì¢Œì¸¡: ìë™ ë°°ì¹˜ ê¸°ì¤€ -->
            <div style="padding:10px; background:#0f172a; border-radius:6px; font-size:9px; color:#64748b;">
              <strong style="color:#a855f7; font-size:10px;">ğŸš« ì‘ì—… ë¶ˆê°€ì¼</strong><br>
              <span style="color:#ef4444; margin-left:10px;">ì¼ìš”ì¼, ìˆ˜ìš”ì¼</span><br><br>
              
              <strong style="color:#a855f7; font-size:10px;">â° ì‘ì—… ì‹œê°„</strong><br>
              <span style="margin-left:10px;">ì¼ì¶œ ~ ì¼ëª°</span><br><br>
              
              <strong style="color:#fbbf24;">ğŸŒ¡ï¸ ë‚ ì”¨ ë¯¼ê° ì‘ì—…</strong><br>
              <span style="margin-left:10px;">â€¢ GA/ë©”ë¦¬íŠ¸ì²­: 20~28Â°C</span><br>
              <span style="margin-left:10px;">â€¢ ì•½ì œ/ì—½ë©´: 15~30Â°C</span><br>
              <span style="margin-left:10px;">â€¢ ì „ì •/ì ê³¼: 10~30Â°C</span><br>
              <span style="margin-left:10px;">â€¢ ìˆ˜í™•: 15~28Â°C, ë¹„0%</span><br><br>
              
              <strong style="color:#94a3b8;">ğŸ“¦ ë‚ ì”¨ ë¬´ê´€ ì‘ì—…</strong><br>
              <span style="margin-left:10px;">â€¢ ìì¬/ë¹„ë£Œ/ë†ì•½ êµ¬ì…</span><br>
              <span style="margin-left:10px;">â€¢ ì‹œì„¤ ì ê²€, ê³„íš ìˆ˜ë¦½</span><br>
              <span style="margin-left:10px;">â€¢ ì„¼ì„œ ì„¤ì¹˜, ì¥ë¹„ í…ŒìŠ¤íŠ¸</span>
            </div>
            
            <!-- ì¤‘ì•™: ë‚ ì”¨ ë°ì´í„° -->
            <div style="padding:10px; background:#0f172a; border-radius:6px; font-size:9px; color:#64748b;">
              <strong style="color:#a855f7; font-size:10px;">ğŸŒ¤ï¸ ë‚ ì”¨ ë°ì´í„°</strong><br><br>
              
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                <span class="realtime-badge">ğŸ”´ì‹¤ì‹œê°„</span>
                <span>í˜„ì¬ ë‚ ì”¨ API</span>
              </div>
              <span style="margin-left:10px; color:#22c55e;">ì˜¤ëŠ˜~ë‚´ì¼ ì‹¤ì œ ë‚ ì”¨</span><br><br>
              
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                <span class="historical-badge">ğŸ“…5ë…„í‰ê· </span>
                <span>ë™ì¼ ì£¼ì°¨ í‰ê· </span>
              </div>
              <span style="margin-left:10px; color:#fbbf24;">ê¸°ìƒì²­ 5ë…„ í‰ë…„ê°’</span><br>
              <span style="margin-left:10px; color:#fbbf24;">(2020-2024 ê¸°ì¤€)</span><br>
              <span style="margin-left:10px; color:#fbbf24;">â†’ ì‘ì—… ë°°ì¹˜ ê¸°ì¤€</span><br><br>
              
              <strong style="color:#e2e8f0;">ì‹œê°„ë³„ í‘œì‹œ:</strong><br>
              <div style="margin-left:10px; margin-top:4px;">
                <span style="color:#fbbf24;">ğŸŒ¡ï¸ ì˜¨ë„Â°C</span>
                <span style="color:#38bdf8; margin-left:8px;">ğŸ’§ ìŠµë„%</span>
              </div>
            </div>
            
            <!-- ìš°ì¸¡: ì´ìƒê¸°í›„ ìë™ ê°ì§€ -->
            <div style="padding:10px; background:#0f172a; border-radius:6px; font-size:9px; color:#64748b;">
              <strong style="color:#a855f7; font-size:10px;">âš ï¸ ì´ìƒê¸°í›„ ìë™ ê°ì§€</strong><br><br>
              
              <div style="margin-bottom:4px;">
                <span class="alert-badge EXTREME_HEAT">ğŸ”¥ ì´ìƒê³ ì˜¨</span>
                <span style="margin-left:6px;">35Â°Câ†‘</span>
              </div>
              <div style="margin-bottom:4px;">
                <span class="alert-badge HEAT_WAVE">ğŸŒ¡ï¸ í­ì—¼</span>
                <span style="margin-left:6px;">33Â°C 3ì‹œê°„â†‘</span>
              </div>
              <div style="margin-bottom:4px;">
                <span class="alert-badge TROPICAL_NIGHT">ğŸŒ™ ì—´ëŒ€ì•¼</span>
                <span style="margin-left:6px;">ì•¼ê°„ 25Â°Câ†‘</span>
              </div>
              <div style="margin-bottom:4px;">
                <span class="alert-badge HEAVY_RAIN">ğŸŒ§ï¸ í­ìš°</span>
                <span style="margin-left:6px;">80%â†‘</span>
              </div>
              <div style="margin-bottom:4px;">
                <span class="alert-badge MONSOON">â˜” ì¥ë§ˆ</span>
                <span style="margin-left:6px;">ê³ ìŠµ+ë‹¤ìš°</span>
              </div>
              <div>
                <span class="alert-badge LOCALIZED_STORM">â›ˆï¸ êµ­ì§€ì„±í˜¸ìš°</span>
                <span style="margin-left:6px;">50mmâ†‘</span>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 52ì£¼ ì „ì²´ ì£¼ê°„ ìŠ¤ì¼€ì¤„ëŸ¬ -->
  <div class="all-weeks-schedule" id="allWeeksSchedule">
    <div class="all-weeks-header" onclick="toggleAllWeeksSchedule()">
      <span class="title">ğŸ“† 52ì£¼ ì „ì²´ ì£¼ê°„ ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬</span>
      <span style="font-size:10px; color:#94a3b8; margin-left:10px;">ê¸°ìƒì²­ 5ë…„ í‰ë…„ê°’ ê¸°ì¤€ ì‘ì—… ë°°ì¹˜</span>
      <span class="toggle" id="allWeeksToggle">â–¼</span>
    </div>
    <div class="all-weeks-content" id="allWeeksContent" style="display:none;">
      <div class="all-weeks-loading">52ì£¼ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œë”©ì¤‘...</div>
    </div>
  </div>
  
  <!-- ì‘ì—…ë³„ ì—°ê°„ ìŠ¤ì¼€ì¤„ -->
  <div class="task-yearly-schedule" id="taskYearlySchedule">
    <div class="task-yearly-header" onclick="toggleTaskYearlySchedule()">
      <span class="title">ğŸ“‹ ì‘ì—…ë³„ ì—°ê°„ ìŠ¤ì¼€ì¤„</span>
      <span style="font-size:10px; color:#94a3b8; margin-left:10px;">ì‘ì—… ìœ í˜•ë³„ 52ì£¼ ì¼ì • í•œëˆˆì— ë³´ê¸°</span>
      <span class="toggle" id="taskYearlyToggle">â–¼</span>
    </div>
    <div class="task-yearly-content" id="taskYearlyContent" style="display:none;">
      <div class="task-filter">
        <label>ì‘ì—… ìœ í˜• ì„ íƒ:</label>
        <select id="taskTypeFilter" onchange="renderTaskYearlySchedule()">
          <option value="ALL">ğŸ“Š ì „ì²´ ì‘ì—…</option>
          <option value="GA">ğŸ§ª GAì²˜ë¦¬</option>
          <option value="SPRAY">ğŸ§´ ì•½ì œì‚´í¬</option>
          <option value="WATER">ğŸ’§ ê´€ìˆ˜</option>
          <option value="FERTILIZER">ğŸŒ± ì‹œë¹„</option>
          <option value="PF">ğŸ¦  PFë†ë²•</option>
          <option value="PRUNING">âœ‚ï¸ ì „ì •/ìœ ì¸</option>
          <option value="BAGGING">ğŸ›ï¸ ë´‰ì§€ì”Œìš°ê¸°</option>
          <option value="HARVEST">ğŸ‡ ìˆ˜í™•</option>
          <option value="HUMIDITY">ğŸŒ¬ï¸ ìŠµë„ê´€ë¦¬</option>
        </select>
      </div>
      <div class="task-yearly-grid" id="taskYearlyGrid">
        <div class="task-yearly-loading">ë¡œë”©ì¤‘...</div>
      </div>
    </div>
  </div>
  
  <!-- Week List -->
  <div class="week-list" id="weekList"></div>
  
  <script src="shine_expert.js"></script>
  <script src="weekly_scheduler.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let currentWeekNo = 1;
    
    // ìµœì´ˆ ì‹¤í–‰ í™•ì¸ ë° ë°”íƒ•í™”ë©´ ë°”ë¡œê°€ê¸° ì•ˆë‚´
    function checkFirstRun() {
      const isFirstRun = !localStorage.getItem('shineMuscat_installed');
      
      if (isFirstRun) {
        // ìµœì´ˆ ì‹¤í–‰ í”Œë˜ê·¸ ì„¤ì •
        localStorage.setItem('shineMuscat_installed', 'true');
        localStorage.setItem('shineMuscat_installDate', new Date().toISOString());
        
        // ë°”íƒ•í™”ë©´ ë°”ë¡œê°€ê¸° ìƒì„± ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
        showInstallGuide();
      }
    }
    
    function showInstallGuide() {
      const modal = document.createElement('div');
      modal.id = 'installGuideModal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
      `;
      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1e1b4b, #312e81); border-radius: 16px; padding: 24px; max-width: 400px; margin: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);">
          <h2 style="color: #a78bfa; margin: 0 0 16px 0; font-size: 18px;">ğŸ‡ ìƒ¤ì¸ë¨¸ìŠ¤ìº£ ì „ë¬¸ê°€ ì‹œìŠ¤í…œ</h2>
          <p style="color: #e2e8f0; font-size: 13px; line-height: 1.6; margin-bottom: 16px;">
            í™˜ì˜í•©ë‹ˆë‹¤! ì²˜ìŒ ì‹¤í–‰í•˜ì…¨ë„¤ìš”.<br><br>
            <b style="color: #fbbf24;">ë°”íƒ•í™”ë©´ì— ë°”ë¡œê°€ê¸°ë¥¼ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?</b>
          </p>
          <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
            <p style="color: #94a3b8; font-size: 11px; margin: 0 0 8px 0;">ğŸ“Œ ë°”ë¡œê°€ê¸° ìƒì„± ë°©ë²•:</p>
            <ol style="color: #cbd5e1; font-size: 11px; margin: 0; padding-left: 20px; line-height: 1.8;">
              <li>í”„ë¡œê·¸ë¨ í´ë”ì—ì„œ <b style="color:#22c55e;">install.bat</b> ì‹¤í–‰</li>
              <li>ë˜ëŠ” ë¸Œë¼ìš°ì € ë©”ë‰´ â†’ "ë°”ë¡œê°€ê¸° ë§Œë“¤ê¸°"</li>
            </ol>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="openInstallFolder()" style="flex:1; background: #22c55e; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
              ğŸ“ í´ë” ì—´ê¸°
            </button>
            <button onclick="closeInstallGuide()" style="flex:1; background: #475569; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px;">
              ë‚˜ì¤‘ì— í•˜ê¸°
            </button>
          </div>
          <p style="color: #64748b; font-size: 9px; text-align: center; margin: 12px 0 0 0;">
            ì´ ì•ˆë‚´ëŠ” ìµœì´ˆ 1íšŒë§Œ í‘œì‹œë©ë‹ˆë‹¤
          </p>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function closeInstallGuide() {
      const modal = document.getElementById('installGuideModal');
      if (modal) modal.remove();
    }
    
    function openInstallFolder() {
      // í˜„ì¬ í˜ì´ì§€ ê²½ë¡œì—ì„œ í´ë” ê²½ë¡œ ì¶”ì¶œ
      const currentPath = window.location.pathname;
      const folderPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
      
      alert('í”„ë¡œê·¸ë¨ í´ë”ë¥¼ ì—´ì–´ install.batì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.\n\nê²½ë¡œ: ' + decodeURIComponent(folderPath || window.location.href));
      closeInstallGuide();
    }
    
    function init() {
      const t = new Date();
      const todayStr = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      $('targetDate').value = todayStr;
      
      // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ (MM/DD í˜•ì‹)
      const todayDisplay = `${t.getMonth()+1}/${t.getDate()}`;
      $('todayDateDisplay').textContent = todayDisplay;
      
      ['heatStart', 'targetDate'].forEach(id => {
        $(id).addEventListener('change', run);
        $(id).addEventListener('input', run);
      });
      
      // ìµœì´ˆ ì‹¤í–‰ ì‹œ ë°”íƒ•í™”ë©´ ë°”ë¡œê°€ê¸° ìƒì„± ì•ˆë‚´
      checkFirstRun();
      
      renderWeekList();
      run();
      setTimeout(loadTaskStates, 100);
    }
    
    function run() {
      const { analyze, getWeekNo } = window.ShineExpert;
      const heatStart = new Date($('heatStart').value);
      const targetDate = new Date($('targetDate').value);
      
      const rawWeekNo = getWeekNo(heatStart, targetDate);
      const daysFromStart = Math.floor((targetDate - heatStart) / (24 * 60 * 60 * 1000));
      
      // ë‹¤ìŒ ì‹œì¦Œ 1ì£¼ì°¨ ì—´ê°€ë‘  ì‹œì‘ì¼ (ë‚´ë…„ 1/19) ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜/ì£¼ì°¨ ê³„ì‚°
      let nextHeatStart = new Date(targetDate.getFullYear() + 1, 0, 19); // ë‚´ë…„ 1ì›” 19ì¼
      // ë§Œì•½ í˜„ì¬ ë‚ ì§œê°€ 1/19 ì´ì „ì´ë©´ ì˜¬í•´ 1/19ë¡œ ê³„ì‚°
      const thisYearHeat = new Date(targetDate.getFullYear(), 0, 19);
      if (targetDate < thisYearHeat) {
        nextHeatStart = thisYearHeat;
      }
      const daysRemaining = Math.ceil((nextHeatStart - targetDate) / (24 * 60 * 60 * 1000));
      const weeksRemaining = Math.ceil(daysRemaining / 7);
      
      // ì‹œì¦Œ ë²”ìœ„ ì²´í¬ (1~52ì£¼ = ì—°ê°„ ì‚¬ì´í´)
      const { WEEKLY_DATA } = window.ShineExpert;
      
      if (rawWeekNo <= 0) {
        currentWeekNo = 0;
        $('dWeek').textContent = '-' + weeksRemaining + 'ì£¼';
        $('dDays').textContent = 'D-' + daysRemaining;
        $('dPhase').textContent = 'ì‹œì¦Œ ì¤€ë¹„';
      } else if (rawWeekNo > 52) {
        // 52ì£¼ ì´ˆê³¼ ì‹œ ë‹¤ìŒ ì—°ë„ë¡œ ìˆœí™˜
        currentWeekNo = ((rawWeekNo - 1) % 52) + 1;
        const weekData = WEEKLY_DATA[currentWeekNo];
        const phaseName = weekData ? weekData.phase : '';
        $('dWeek').textContent = '-' + weeksRemaining + 'ì£¼';
        $('dDays').textContent = 'D-' + daysRemaining;
        $('dPhase').textContent = phaseName;
      } else {
        currentWeekNo = rawWeekNo;
        const weekData = WEEKLY_DATA[currentWeekNo];
        const phaseName = weekData ? weekData.phase : '';
        $('dWeek').textContent = '-' + weeksRemaining + 'ì£¼';
        $('dDays').textContent = 'D-' + daysRemaining;
        $('dPhase').textContent = phaseName;
      }
      
      updateWeekHighlight(currentWeekNo);
    }
    
    function updateWeekHighlight(weekNo) {
      document.querySelectorAll('.week-item').forEach((el, i) => {
        el.classList.remove('current');
        if (i + 1 === weekNo) {
          el.classList.add('current');
        }
      });
    }
    
    function renderWeekList() {
      const { WEEKLY_DATA } = window.ShineExpert;
      const container = $('weekList');
      container.innerHTML = '';
      
      for (let i = 1; i <= 52; i++) {
        const w = WEEKLY_DATA[i];
        if (!w) continue;
        
        const item = document.createElement('div');
        item.className = 'week-item';
        item.innerHTML = `
          <div class="week-header" onclick="toggleWeek(${i})">
            <div class="week-icon">${w.phaseEmoji}</div>
            <div class="week-info">
              <div class="week-title">${i}ì£¼ì°¨ - ${w.phase}</div>
              <div class="week-dates">${w.dateRange}</div>
            </div>
            <div class="week-alert">${w.keyAlert}</div>
            <div class="week-toggle">â–¼</div>
          </div>
          <div class="week-content" id="weekContent${i}">
            ${renderWeekContent(w, i)}
          </div>
        `;
        container.appendChild(item);
      }
    }
    
    function renderWeekContent(w, weekNum) {
      const rb = w.pest.risk === 'HIGH' ? 'h' : w.pest.risk === 'MEDIUM' ? 'm' : 'l';
      
      return `
        <div class="goal-header" onclick="toggleGoalContent(${weekNum})" style="margin-bottom:8px;padding:8px;background:#1e293b;border-radius:4px;font-size:11px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
          <span><strong>ğŸ¯ ëª©í‘œ:</strong> ${w.goal}</span>
          <span class="goal-toggle" id="goalToggle${weekNum}" style="font-size:10px;color:#94a3b8;transition:transform 0.3s;">â–¼</span>
        </div>
        
        <div class="goal-content" id="goalContent${weekNum}" style="display:none;">
        <div class="content-grid">
          <!-- ê´€ìˆ˜ -->
          <div class="card">
            <div class="card-title">ğŸ’§ ê´€ìˆ˜</div>
            <div class="row water"><div class="row-label">ì£¼ê¸°</div><div class="row-value">${w.water.interval}</div></div>
            <div class="row water"><div class="row-label">ìš©ëŸ‰</div><div class="row-value">${w.water.amountTon}</div><div class="row-sub">${w.water.amountL}</div></div>
            <div class="row water"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.water.method}</div></div>
            <div class="row water"><div class="row-ok">âœ“ ${w.water.point}</div></div>
            <div class="row water"><div class="row-warn">âš  ${w.water.caution}</div></div>
          </div>
          
          <!-- ì‹œë¹„ -->
          <div class="card">
            <div class="card-title">ğŸ§ª ì‹œë¹„</div>
            <div class="row fert"><div class="row-label">${w.fertilizer.type}</div><div class="row-value">${w.fertilizer.main}</div></div>
            ${w.fertilizer.sub ? `<div class="row fert"><div class="row-sub">${w.fertilizer.sub}</div></div>` : ''}
            ${w.fertilizer.foliar ? `<div class="row fert"><div class="row-label">ì—½ë©´</div><div class="row-sub">${w.fertilizer.foliar}</div></div>` : ''}
            <div class="row fert"><div class="row-label">EC</div><div class="row-value">${w.fertilizer.ec}</div></div>
            <div class="row fert"><div class="row-ok">âœ“ ${w.fertilizer.npk}</div></div>
            <div class="row fert"><div class="row-warn">âš  ${w.fertilizer.point}</div></div>
          </div>
          
          <!-- PFë†ë²• -->
          <div class="card">
            <div class="card-title">ğŸ¦  PFë†ë²• (ë¹„)</div>
            ${w.pf.apply ? `
              <div class="row pf"><span class="badge pf">${w.pf.note}</span></div>
              <div class="row pf"><div class="row-label">ìš©ëŸ‰</div><div class="row-value">${w.pf.amount}</div></div>
              <div class="row pf"><div class="row-sub">${w.pf.timing || ''}</div></div>
            ` : `<div class="row"><div class="row-value">${w.pf.note}</div></div>`}
          </div>
          
          <!-- ë©€ì¹­ -->
          ${w.mulching ? `
          <div class="card">
            <div class="card-title">ğŸ›ï¸ ë©€ì¹­</div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-label">ìƒíƒœ</div><div class="row-value" style="color:#a78bfa">${w.mulching.status}</div></div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-label">ì‘ì—…</div><div class="row-sub">${w.mulching.action}</div></div>
            <div class="row" style="border-left:2px solid #8b5cf6;"><div class="row-ok">âœ“ ${w.mulching.point}</div></div>
          </div>
          ` : ''}
          
          <!-- ì „ì • -->
          ${w.pruning ? `
          <div class="card">
            <div class="card-title">âœ‚ï¸ ì „ì •</div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-label">ìƒíƒœ</div><div class="row-value" style="color:#f472b6">${w.pruning.status}</div></div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-label">ì‘ì—…</div><div class="row-sub">${w.pruning.action}</div></div>
            <div class="row" style="border-left:2px solid #f472b6;"><div class="row-ok">âœ“ ${w.pruning.point}</div></div>
          </div>
          ` : ''}
          
          <!-- í™”ìˆ˜ì •í˜• -->
          ${w.hwasoo ? `
          <div class="card">
            <div class="card-title">âœ‚ï¸ í™”ìˆ˜ì •í˜•</div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#f472b6">${w.hwasoo.stage}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ì‹œê¸°</div><div class="row-sub">${w.hwasoo.timing}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ëª©í‘œ</div><div class="row-value">${w.hwasoo.target}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.hwasoo.method}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-ok">âœ“ ${w.hwasoo.point}</div></div>
            <div class="row" style="border-left:2px solid #ec4899;"><div class="row-warn">${w.hwasoo.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ë©”ë¦¬íŠ¸ì²­ -->
          ${w.meritcheong ? `
          <div class="card">
            <div class="card-title">ğŸ§´ ë©”ë¦¬íŠ¸ì²­ (ë¹„)</div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#fbbf24">${w.meritcheong.stage}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ì‹œê¸°</div><div class="row-value">${w.meritcheong.timing}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë†ë„</div><div class="row-sub">${w.meritcheong.concentration}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.meritcheong.method}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-ok">âœ“ ${w.meritcheong.point}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-warn">${w.meritcheong.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ì§€ë² ë ë¦°(GA) -->
          ${w.ga ? `
          <div class="card">
            <div class="card-title">ğŸ’‰ ì§€ë² ë ë¦°(GA)</div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#34d399">${w.ga.stage}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ì‹œê¸°</div><div class="row-value">${w.ga.timing}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë†ë„</div><div class="row-sub">${w.ga.concentration}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.ga.method}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-ok">âœ“ ${w.ga.point}</div></div>
            <div class="row" style="border-left:2px solid #10b981;"><div class="row-warn">${w.ga.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- í† ì–‘ì ê²€ -->
          ${w.soilCheck ? `
          <div class="card">
            <div class="card-title">ğŸ”¬ í† ì–‘ì ê²€</div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#818cf8">${w.soilCheck.stage}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ì‹œê¸°</div><div class="row-sub">${w.soilCheck.timing}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">í•­ëª©</div><div class="row-sub">${w.soilCheck.items}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ì ì •ê°’</div><div class="row-value" style="font-size:9px">${w.soilCheck.target}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.soilCheck.method}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-ok">âœ“ ${w.soilCheck.point}</div></div>
            <div class="row" style="border-left:2px solid #6366f1;"><div class="row-warn">${w.soilCheck.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ë‹¹ë„ ì˜¬ë¦¬ê¸° ë¹„ë²• -->
          ${w.brix ? `
          <div class="card" style="grid-column: span 2;">
            <div class="card-title">ğŸ¯ ë‹¹ë„ ì˜¬ë¦¬ê¸° ë¹„ë²• (ë¹„)</div>
            <div class="row" style="border-left:2px solid #f59e0b;background:#451a03;"><div class="row-label">ë‹¨ê³„</div><div class="row-value" style="color:#fcd34d">${w.brix.stage}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ëª©í‘œ</div><div class="row-value" style="color:#fbbf24">${w.brix.target}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;">
              <div class="row-label">ğŸ”‘ ë¹„ë²•</div>
              <div style="font-size:9px;color:#fcd34d;">
                ${w.brix.secrets.map(s => `<div style="margin:2px 0;">${s}</div>`).join('')}
              </div>
            </div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.brix.method}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-ok">âœ“ ${w.brix.point}</div></div>
            <div class="row" style="border-left:2px solid #f59e0b;"><div class="row-warn">${w.brix.caution}</div></div>
          </div>
          ` : ''}
          
          <!-- ì˜¨ë„ -->
          <div class="card">
            <div class="card-title">ğŸŒ¡ï¸ ì˜¨ë„</div>
            ${w.avgOutdoorTemp ? `<div class="row" style="background:#1e3a5f;border-left:2px solid #3b82f6;"><div class="row-label">ğŸŒ¤ï¸ ì™¸ë¶€ í†µìƒ</div><div class="row-value" style="color:#60a5fa">${w.avgOutdoorTemp.min}~${w.avgOutdoorTemp.max}Â°C <span style="font-size:9px;color:#94a3b8">(í‰ê·  ${w.avgOutdoorTemp.avg}Â°C)</span></div></div>` : ''}
            <div class="row temp"><div class="row-label">ì£¼ê°„ ëª©í‘œ</div><div class="row-value">${w.temperature.dayTarget[0]}~${w.temperature.dayTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-label">ì•¼ê°„ ëª©í‘œ</div><div class="row-value">${w.temperature.nightTarget[0]}~${w.temperature.nightTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-label">ì§€ì˜¨ ëª©í‘œ</div><div class="row-value">${w.temperature.soilTarget[0]}~${w.temperature.soilTarget[1]}Â°C</div></div>
            <div class="row temp"><div class="row-ok">âœ“ ${w.temperature.point}</div></div>
            <div class="row temp"><div class="row-warn">âš  ${w.temperature.caution}</div></div>
          </div>
          
          <!-- ìŠµë„ -->
          <div class="card">
            <div class="card-title">ğŸ’¨ ìŠµë„</div>
            <div class="row humid"><div class="row-label">ì£¼ê°„</div><div class="row-value">${w.humidity.dayTarget[0]}~${w.humidity.dayTarget[1]}%</div></div>
            <div class="row humid"><div class="row-label">ì•¼ê°„</div><div class="row-value">${w.humidity.nightTarget[0]}~${w.humidity.nightTarget[1]}%</div></div>
            <div class="row humid"><div class="row-label">VPD</div><div class="row-value">${w.humidity.vpdTarget[0]}~${w.humidity.vpdTarget[1]} kPa</div></div>
            <div class="row humid"><div class="row-ok">âœ“ ${w.humidity.point}</div></div>
            <div class="row humid"><div class="row-warn">âš  ${w.humidity.caution}</div></div>
          </div>
          
          <!-- í™˜ê¸° -->
          <div class="card">
            <div class="card-title">ğŸŒ¬ï¸ í™˜ê¸°</div>
            <div class="row vent"><div class="row-label">ì‹œê°„ëŒ€</div><div class="row-value">${w.ventilation.timing}</div></div>
            <div class="row vent"><div class="row-label">ì‹œê°„</div><div class="row-value">${w.ventilation.duration}</div></div>
            <div class="row vent"><div class="row-label">ë°©ë²•</div><div class="row-sub">${w.ventilation.method}</div></div>
            <div class="row vent"><div class="row-ok">âœ“ ${w.ventilation.point}</div></div>
            <div class="row vent"><div class="row-warn">âš  ${w.ventilation.caution}</div></div>
          </div>
          
          <!-- ë³‘í•´ -->
          <div class="card">
            <div class="card-title">ğŸ›¡ï¸ ë³‘í•´ì¶©</div>
            <div class="row pest"><div class="row-label">ì£¼ì˜</div><div class="row-value">${w.pest.watch.join(', ')}</div><span class="badge ${rb}">${w.pest.risk}</span></div>
            <div class="row pest"><div class="row-label">ì¡°ê±´</div><div class="row-sub">${w.pest.condition}</div></div>
            <div class="row pest"><div class="row-label">ì˜ˆë°©</div><div class="row-sub">${w.pest.prevention}</div></div>
            <div class="row pest"><div class="row-label">ì•½ì œ</div><div class="row-sub">ğŸ’Š ${w.pest.spray}</div></div>
          </div>
          
          <!-- ì‘ì—… -->
          <div class="card">
            <div class="card-title">ğŸ“‹ ì´ë²ˆ ì£¼ ì‘ì—…</div>
            <div class="task-list">
              ${w.tasks.map((t, i) => `<div class="task" onclick="toggleTask(this)"><input type="checkbox" id="task_${weekNum}_${i}"><span>${t}</span></div>`).join('')}
            </div>
          </div>
          
          <!-- ì²´í¬ -->
          <div class="card">
            <div class="card-title">âœ… ì²´í¬í¬ì¸íŠ¸</div>
            <div class="task-list">
              ${w.checkPoints.map((c, i) => `<div class="task" onclick="toggleTask(this)"><input type="checkbox" id="check_${weekNum}_${i}"><span>${c}</span></div>`).join('')}
            </div>
          </div>
        </div>
        </div>
        
        <!-- ì£¼ê°„ ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ -->
        <div class="week-scheduler-section" id="weekSchedulerSection_${weekNum}">
          <div class="week-scheduler-title" onclick="toggleWeekScheduler(${weekNum})">
            ğŸ—“ï¸ ì£¼ê°„ ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ (5ë…„ í‰ê·  ê¸°í›„ ê¸°ì¤€)
            <span class="week-scheduler-toggle" id="weekSchedulerToggle_${weekNum}">â–¼</span>
          </div>
          <div class="week-scheduler-calendar" id="weekSchedulerCal_${weekNum}" style="display:none;">
            <!-- JavaScriptë¡œ ë Œë”ë§ -->
          </div>
        </div>
      `;
    }
    
    function toggleTask(el) {
      const checkbox = el.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      el.classList.toggle('checked', checkbox.checked);
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      const id = checkbox.id;
      const checked = JSON.parse(localStorage.getItem('shineTasks') || '{}');
      checked[id] = checkbox.checked;
      localStorage.setItem('shineTasks', JSON.stringify(checked));
    }
    
    function loadTaskStates() {
      const checked = JSON.parse(localStorage.getItem('shineTasks') || '{}');
      Object.keys(checked).forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox && checked[id]) {
          checkbox.checked = true;
          checkbox.closest('.task').classList.add('checked');
        }
      });
    }
    
    function toggleWeek(weekNo) {
      const items = document.querySelectorAll('.week-item');
      items.forEach((item, i) => {
        if (i + 1 === weekNo) {
          const wasOpen = item.classList.contains('open');
          item.classList.toggle('open');
          item.classList.add('active');
          
          // ì—´ë¦´ ë•Œ ìŠ¤ì¼€ì¤„ëŸ¬ ë Œë”ë§
          if (!wasOpen) {
            renderWeekSchedulerCalendar(weekNo);
          }
        } else {
          item.classList.remove('active');
        }
      });
    }
    
    // ëª©í‘œ í´ë¦­ ì‹œ ìƒì„¸ ë‚´ìš© í† ê¸€
    function toggleGoalContent(weekNum) {
      const content = document.getElementById(`goalContent${weekNum}`);
      const toggle = document.getElementById(`goalToggle${weekNum}`);
      
      if (!content || !toggle) return;
      
      const isOpen = content.style.display !== 'none';
      
      if (isOpen) {
        content.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
      }
    }
    
    // ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„ëŸ¬ í† ê¸€
    function toggleWeekScheduler(weekNo) {
      const section = document.getElementById(`weekSchedulerSection_${weekNo}`);
      const calendar = document.getElementById(`weekSchedulerCal_${weekNo}`);
      
      if (!section || !calendar) return;
      
      const isOpen = section.classList.contains('open');
      
      if (isOpen) {
        section.classList.remove('open');
        calendar.style.display = 'none';
      } else {
        section.classList.add('open');
        calendar.style.display = 'grid';
        renderWeekSchedulerCalendar(weekNo);
      }
    }
    
    // ì£¼ì°¨ë³„ ìŠ¤ì¼€ì¤„ëŸ¬ ìº˜ë¦°ë” ë Œë”ë§
    function renderWeekSchedulerCalendar(weekNo) {
      const container = document.getElementById(`weekSchedulerCal_${weekNo}`);
      if (!container) return;
      
      const { WEEKLY_DATA } = window.ShineExpert;
      const weekData = WEEKLY_DATA[weekNo];
      if (!weekData) return;
      
      const climate = WeeklyScheduler.getHistoricalClimate(weekNo);
      const DAYS_FULL = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      
      // ì‘ì—… ë¶„ë¥˜
      const tasks = weekData.tasks || [];
      const classifiedTasks = tasks.map(t => ({
        text: t,
        type: WeeklyScheduler.classifyTask(t),
        conditions: WeeklyScheduler.TASK_CONDITIONS[WeeklyScheduler.classifyTask(t)] || WeeklyScheduler.TASK_CONDITIONS.GENERAL
      }));
      
      const weatherSensitive = classifiedTasks.filter(t => t.conditions.weatherSensitive !== false);
      const weatherIndependent = classifiedTasks.filter(t => t.conditions.weatherSensitive === false);
      
      // ì‘ì—… ë°°ì¹˜
      const tasksByDay = {};
      const WORK_DAYS = [1, 2, 4, 5, 6];
      let dayIdx = 0, hourOff = 0;
      
      // ì‹œë¹„ ì‘ì—… ë¨¼ì € í™•ì¸ (ê´€ì£¼ì‹œë¹„ ì—¬ë¶€ íŒŒì•…)
      let fertigationDays = []; // ê´€ì£¼ì‹œë¹„ê°€ ìˆëŠ” ë‚ 
      let fertigationWaterAmount = 0; // ê´€ì£¼ì‹œë¹„ì— ì‚¬ìš©ë˜ëŠ” ë¬¼ëŸ‰
      if (weekData.fertilizer) {
        const fert = weekData.fertilizer;
        const fertType = fert.type || 'ì‹œë¹„';
        const isFertigation = fertType.includes('ê´€ì£¼');
        
        let fertDays = [1, 5];
        if (fertType.includes('ì—½ë©´') || fert.foliar) {
          fertDays = [2, 4, 6];
        }
        
        if (isFertigation) {
          fertigationDays = fertDays;
          // ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ì¼ì¼ ê´€ìˆ˜ëŸ‰ì˜ ì•½ 40% (EC ê´€ë¦¬ìš©)
          const waterAmount = weekData.water?.amountTon || '3~5í†¤';
          const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
          if (match) {
            fertigationWaterAmount = parseFloat(match[1]) * 0.4;
          }
        }
      }
      
      // ê´€ìˆ˜ ì‘ì—… ì¶”ê°€ (ì£¼ê°„ ê³„íš ê¸°ë°˜) - ë¬¼ë¹ ì§ ì ì ˆí•¨
      if (weekData.water) {
        const waterInterval = weekData.water.interval || '';
        const waterMethod = weekData.water.method || '';
        const waterAmount = weekData.water.amountTon || '';
        
        // ì¼ì¼ ì´ ê´€ìˆ˜ëŸ‰ íŒŒì‹±
        let dailyWaterTotal = 3; // ê¸°ë³¸ê°’
        const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
        if (match) {
          dailyWaterTotal = parseFloat(match[1]);
        }
        
        let waterDays = [2, 5];
        if (waterInterval.includes('2~3ì¼') || waterInterval.includes('2ì¼')) {
          waterDays = [1, 4, 6];
        } else if (waterInterval.includes('3~4ì¼') || waterInterval.includes('3ì¼')) {
          waterDays = [2, 5];
        } else if (waterInterval.includes('5~7ì¼') || waterInterval.includes('7ì¼')) {
          waterDays = [4];
        }
        
        let waterHour = 9;
        if (waterMethod.includes('ì˜¤í›„') || waterMethod.includes('ì €ë…')) {
          waterHour = 16;
        } else if (waterMethod.includes('ì´ë¥¸ ì•„ì¹¨') || waterMethod.includes('6')) {
          waterHour = 7;
        }
        
        waterDays.forEach(day => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          
          // ê´€ì£¼ì‹œë¹„ê°€ ìˆëŠ” ë‚ ì€ ê´€ìˆ˜ëŸ‰ ì¡°ì • (ì¼ì¼ì´ëŸ‰ - ê´€ì£¼ì‹œë¹„ë¬¼ëŸ‰)
          const isFertigationDay = fertigationDays.includes(day);
          let adjustedAmount = dailyWaterTotal;
          let waterNote = '';
          
          if (isFertigationDay && fertigationWaterAmount > 0) {
            adjustedAmount = Math.max(0, dailyWaterTotal - fertigationWaterAmount);
            waterNote = ` (ì¡°ì •: ê´€ì£¼${fertigationWaterAmount.toFixed(1)}í†¤ ì œì™¸)`;
          }
          
          if (adjustedAmount > 0) {
            tasksByDay[day].unshift({
              text: `ğŸ’§ ê´€ìˆ˜ (${adjustedAmount.toFixed(1)}í†¤)${waterNote}`,
              type: 'WATER',
              isWater: true,
              isFertigationDay: isFertigationDay,
              conditions: { weatherSensitive: true, duration: 1 },
              startHour: waterHour,
              endHour: waterHour + 1
            });
          }
        });
      }
      
      // ì‹œë¹„ ì‘ì—… ì¶”ê°€ (ì£¼ê°„ ê³„íš ê¸°ë°˜)
      if (weekData.fertilizer) {
        const fert = weekData.fertilizer;
        const fertType = fert.type || 'ì‹œë¹„';
        const fertMain = fert.main || '';
        const fertSub = fert.sub || '';
        const fertFoliar = fert.foliar || '';
        const fertEc = fert.ec || '';
        const fertPoint = fert.point || '';
        const fertNpk = fert.npk || '';
        const isFertigation = fertType.includes('ê´€ì£¼');
        const waterAmount = weekData.water?.amountTon || '';
        
        // ì‹œë¹„ëŠ” ì£¼ 1~2íšŒ (ì›”, ê¸ˆ)
        let fertDays = [1, 5]; // ì›”, ê¸ˆ
        if (fertType.includes('ì—½ë©´') || fertFoliar) {
          fertDays = [2, 4, 6]; // ì—½ë©´ì‹œë¹„ëŠ” í™”, ëª©, í† 
        }
        
        // ì‹œë¹„ ì‹œê°„ (ì˜¤ì „ 10ì‹œ)
        const fertHour = 10;
        
        // ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ì¼ì¼ ê´€ìˆ˜ëŸ‰ì˜ 40% (EC ê´€ë¦¬/ë¹„ë£Œ í¬ì„ìš©)
        let fertigationWater = 0;
        let dailyTotal = 0;
        if (isFertigation && waterAmount) {
          const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
          if (match) {
            dailyTotal = parseFloat(match[1]);
            fertigationWater = dailyTotal * 0.4;
          }
        }
        
        // ìƒì„¸ ë‚´ìš© êµ¬ì„±
        const fertDetail = [
          fertMain ? `ğŸ“Œ ${fertMain}` : '',
          fertSub ? `â• ${fertSub}` : '',
          fertFoliar ? `ğŸƒ ì—½ë©´: ${fertFoliar}` : '',
          fertEc ? `âš¡ EC: ${fertEc}` : '',
          fertPoint ? `âœ“ ${fertPoint}` : '',
          fertNpk ? fertNpk : '',
          isFertigation ? `ğŸ’§ ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ${fertigationWater.toFixed(1)}í†¤ (40%)` : '',
          isFertigation ? `ğŸ’§ ì¶”ê°€ ê´€ìˆ˜: ${(dailyTotal - fertigationWater).toFixed(1)}í†¤ (60%)` : '',
          isFertigation ? `ğŸ“Š ì¼ì¼ ì´ëŸ‰: ${dailyTotal}í†¤ (100%)` : ''
        ].filter(x => x).join('\\n');
        
        fertDays.forEach((day, idx) => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          tasksByDay[day].push({
            text: isFertigation ? `ğŸ§ªğŸ’§ ê´€ì£¼ì‹œë¹„ (${fertigationWater.toFixed(1)}í†¤)` : `ğŸ§ª ${fertType} (${fertMain.substring(0, 10)}${fertMain.length > 10 ? '...' : ''})`,
            type: 'FERTILIZER',
            isFertilizer: true,
            isFertigation: isFertigation,
            detail: fertDetail,
            conditions: { weatherSensitive: true, duration: 1 },
            startHour: fertHour + idx,
            endHour: fertHour + idx + 1
          });
        });
      }
      
      [...weatherSensitive, ...weatherIndependent].forEach(task => {
        const targetDay = WORK_DAYS[dayIdx % WORK_DAYS.length];
        if (!tasksByDay[targetDay]) tasksByDay[targetDay] = [];
        const startHour = 9 + (hourOff * 2);
        const duration = task.conditions.duration || 2;
        tasksByDay[targetDay].push({ ...task, startHour, endHour: startHour + duration });
        hourOff++;
        if (hourOff >= 3) { hourOff = 0; dayIdx++; }
      });
      
      // PFë†ë²• ì‘ì—… ì¶”ê°€ (ë°œì•„/ê°œí™” ê¸°ì¤€)
      // ë°œì•„: 5~6ì£¼ì°¨ (2/25), ê°œí™”: 11ì£¼ì°¨ (4/3)
      const PF_SCHEDULE = {
        1: { timing: 'ë°œì•„ 45ì¼ì „', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        2: { timing: 'ë°œì•„ 30ì¼ì „', pf: 'PF-2', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        4: { timing: 'ë°œì•„ 15ì¼ì „', pf: 'PF-4', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        6: { timing: 'ë°œì•„', pf: 'PF-4', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        9: { timing: 'ê°œí™” 15ì¼ì „', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        11: { timing: 'ê°œí™”', pf: 'PF-2', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        13: { timing: 'ê°œí™” 15ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        15: { timing: 'ê°œí™” 30ì¼í›„', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        17: { timing: 'ê°œí™” 45ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        18: { timing: 'ê°œí™” 50ì¼í›„', pf: 'PF-2', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        20: { timing: 'ê°œí™” 65ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        22: { timing: 'ê°œí™” 80ì¼í›„', pf: 'PF-2', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        24: { timing: 'ê°œí™” 95ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' }
      };
      
      if (PF_SCHEDULE[weekNo]) {
        const pf = PF_SCHEDULE[weekNo];
        const pfDay = 4; // ëª©ìš”ì¼
        const pfHour = 14; // ì˜¤í›„ 2ì‹œ
        
        const pfDetail = [
          `ğŸ“… ì‹œê¸°: ${pf.timing}`,
          `ğŸ¦  ${pf.pf}: ${pf.pfAmount}`,
          `ğŸ“¦ ${pf.kit}: ${pf.kitAmount}`,
          ``,
          `ğŸ“‹ ì‚¬ìš© ë°©ë²•:`,
          `  â€¢ ${pf.pf}ì™€ ${pf.kit} í˜¼í•© ì‚¬ìš©`,
          `  â€¢ ë¬¼ 200Lë‹¹ í¬ì„`,
          `  â€¢ í† ì–‘ ê´€ì£¼ ë˜ëŠ” ì—½ë©´ ì‚´í¬`,
          ``,
          `ğŸ’¡ PFë†ë²• íš¨ê³¼:`,
          `  â€¢ í† ì–‘ ë¯¸ìƒë¬¼ í™œì„±í™”`,
          `  â€¢ ë¿Œë¦¬ ë°œë‹¬ ì´‰ì§„`,
          `  â€¢ ë³‘í•´ ì €í•­ì„± ê°•í™”`,
          `  â€¢ ë‹¹ë„ ë° í’ˆì§ˆ í–¥ìƒ`
        ].join('\\n');
        
        if (!tasksByDay[pfDay]) tasksByDay[pfDay] = [];
        tasksByDay[pfDay].push({
          text: `ğŸ¦  PFë†ë²• (${pf.pf} ${pf.pfAmount})`,
          type: 'PF',
          isPF: true,
          detail: pfDetail,
          conditions: { weatherSensitive: true, duration: 1 },
          startHour: pfHour,
          endHour: pfHour + 1
        });
      }
      
      // ì•½ì œ ì‚´í¬ ì‘ì—… ì¶”ê°€ (2ì£¼ì— 1íšŒ, ì§ìˆ˜ ì£¼ì°¨ì— ë°°ì¹˜)
      if (weekData.pest && weekNo % 2 === 0) {
        const pest = weekData.pest;
        const sprayDrug = pest.spray || 'ì˜ˆë°© ì•½ì œ';
        const watchList = pest.watch?.join(', ') || '-';
        const riskLevel = pest.risk || 'LOW';
        const condition = pest.condition || '-';
        const prevention = pest.prevention || '-';
        
        // ì ì • ì˜¨ë„/ìŠµë„ ì¡°ê±´: 15~28Â°C, ìŠµë„ 50~70%
        // í™”ìš”ì¼ ì˜¤ì „ 10ì‹œ ë°°ì¹˜ (ì´ìŠ¬ ë§ˆë¥¸ í›„, ê³ ì˜¨ ì „)
        const sprayDay = 2; // í™”ìš”ì¼
        const sprayHour = 10;
        
        // ì•½ì œ ì •ë³´ ìƒì„¸
        const sprayDetail = [
          `ğŸ¯ ì£¼ì˜ ë³‘í•´ì¶©: ${watchList}`,
          `âš ï¸ ìœ„í—˜ë„: ${riskLevel}`,
          `ğŸŒ¡ï¸ ë°œìƒ ì¡°ê±´: ${condition}`,
          `ğŸ›¡ï¸ ì˜ˆë°©: ${prevention}`,
          `ğŸ’Š ê¶Œì¥ ì•½ì œ: ${sprayDrug}`,
          ``,
          `ğŸ“‹ ì‚´í¬ ì¡°ê±´:`,
          `  â€¢ ì˜¨ë„: 15~28Â°C`,
          `  â€¢ ìŠµë„: 50~70%`,
          `  â€¢ ì‹œê°„: ì´ìŠ¬ ë§ˆë¥¸ í›„ (ì˜¤ì „ 9~11ì‹œ)`,
          `  â€¢ ë°”ëŒ: ì•½í•œ ë°”ëŒ (3m/s ì´í•˜)`,
          ``,
          `ğŸ“¦ í¬ì„ ë°°ìœ¨ (ì¼ë°˜ ê¸°ì¤€):`,
          `  â€¢ ì‚´ê· ì œ: 1,000~2,000ë°°`,
          `  â€¢ ì‚´ì¶©ì œ: 1,000~1,500ë°°`,
          `  â€¢ ì§„ë”§ë¬¼: 2,000ë°°`,
          `  â€¢ ì‘ì• ë¥˜: 1,500ë°°`
        ].join('\\n');
        
        if (!tasksByDay[sprayDay]) tasksByDay[sprayDay] = [];
        tasksByDay[sprayDay].push({
          text: `ğŸ§´ ì•½ì œì‚´í¬ (${sprayDrug.substring(0, 8)}${sprayDrug.length > 8 ? '...' : ''})`,
          type: 'SPRAY',
          isSpray: true,
          detail: sprayDetail,
          conditions: { weatherSensitive: true, duration: 2 },
          startHour: sprayHour,
          endHour: sprayHour + 2
        });
      }
      
      // ìŠµë„ê´€ë¦¬ ì‘ì—… ì¶”ê°€ (ì—°ë™í•˜ìš°ìŠ¤ ê¸°ì¤€)
      const HUMIDITY_PHASES = {
        dormant: { weeks: [1,2,3,4], name: 'íœ´ë©´ê¸°', humidity: '60-70%', mode: 'ìµœì†Œí™˜ê¸°', note: 'ë™í•´ë°©ì§€' },
        budding: { weeks: [5,6,7,8], name: 'ë°œì•„ê¸°', humidity: '70-80%', mode: 'ê²°ë¡œë°©ì§€', note: 'ìƒˆë²½í™˜ê¸° í•„ìˆ˜' },
        shooting: { weeks: [9,10,11,12,13,14], name: 'ì‹ ì´ˆìƒì¥ê¸°', humidity: '60-70%', mode: 'ì ê·¹í™˜ê¸°', note: 'ì›ƒìëŒ ë°©ì§€' },
        flowering: { weeks: [15,16,17], name: 'ê°œí™”ê¸°', humidity: '50-60%', mode: 'í•„ìˆ˜í™˜ê¸°', note: 'í™”ì§„ ë°©ì§€!' },
        fruitGrowth: { weeks: [18,19,20,21,22,23,24], name: 'ê³¼ë¦½ë¹„ëŒ€ê¸°', humidity: '60-70%', mode: 'ì—´ê³¼ë°©ì§€', note: 'ê¸‰ë³€ ì£¼ì˜' },
        coloring: { weeks: [25,26,27,28,29,30], name: 'ì°©ìƒ‰ê¸°', humidity: '50-60%', mode: 'ë‹¹ë„í–¥ìƒ', note: 'ì €ìŠµë„ ìœ ì§€' },
        harvest: { weeks: [31,32,33,34,35,36], name: 'ìˆ˜í™•ê¸°', humidity: '50-60%', mode: 'í’ˆì§ˆìœ ì§€', note: 'ê²°ë¡œ ë°©ì§€' },
        postHarvest: { weeks: [37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52], name: 'ìˆ˜í™•í›„', humidity: '60-70%', mode: 'ìµœì†Œí™˜ê¸°', note: 'ì›”ë™ ì¤€ë¹„' }
      };
      
      let humidityInfo = null;
      for (const [phase, info] of Object.entries(HUMIDITY_PHASES)) {
        if (info.weeks.includes(weekNo)) {
          humidityInfo = info;
          break;
        }
      }
      
      if (humidityInfo) {
        const humidityDetail = [
          `ğŸ“Š ìƒìœ¡ë‹¨ê³„: ${humidityInfo.name}`,
          `ğŸ’§ ì ì •ìŠµë„: ${humidityInfo.humidity}`,
          `ğŸŒ¬ï¸ í™˜ê¸°ëª¨ë“œ: ${humidityInfo.mode}`,
          `âš ï¸ ì£¼ì˜: ${humidityInfo.note}`,
          ``,
          `ğŸ“‹ ì‹œê°„ëŒ€ë³„ í™˜ê¸° (ì—°ë™í•˜ìš°ìŠ¤):`,
          `  06-08ì‹œ | 15Â°Câ†‘,80%â†‘ â†’ í™˜ê¸°íŒ¬,ì¸¡ì°½10%`,
          `  09-11ì‹œ | 20Â°Câ†‘,70%â†‘ â†’ ì¸¡ì°½30%,ì²œì°½ê°œë°©`,
          `  12-15ì‹œ | 25Â°Câ†‘ â†’ ì¸¡ì°½50%,í™˜ê¸°íŒ¬`,
          `  16-18ì‹œ | 20Â°Câ†“ â†’ ì¸¡ì°½20%,ì²œì°½íì‡„`,
          `  ì•¼ê°„ | 85%â†‘ â†’ í™˜ê¸°íŒ¬ ê°„í—ê°€ë™`,
          ``,
          `ğŸš¨ ì¦‰ì‹œì¡°ì¹˜: 80%â†‘â†’ì¦‰ì‹œí™˜ê¸°, ê²°ë¡œâ†’ì¼ì¶œ30ë¶„ì „`
        ].join('\\n');
        
        // ì›”,ëª©ì— ìŠµë„ê´€ë¦¬ ì ê²€
        [1, 4].forEach(day => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          tasksByDay[day].push({
            text: `ğŸŒ¬ï¸ ìŠµë„ê´€ë¦¬ (${humidityInfo.humidity})`,
            type: 'HUMIDITY',
            isHumidity: true,
            detail: humidityDetail,
            conditions: { weatherSensitive: true, duration: 1 },
            startHour: 9,
            endHour: 10
          });
        });
      }
      
      // ì‚¬ìš©ìê°€ ì´ë™í•œ ì‘ì—… ì ìš©
      applyTaskMoveOverrides(tasksByDay, weekNo);
      
      // ìš”ì¼ë³„ ê¸°í›„ ë³€ë™ í•¨ìˆ˜ (ê°™ì€ ì£¼ì°¨ ë‚´ì—ì„œë„ ìš”ì¼ë³„ë¡œ Â±1~2Â°C ë³€í™”)
      function getDayVariation(dayIdx) {
        const variations = [-1, 1, 2, 0, -1, 1, 0]; // ì¼~í†  ë³€ë™ê°’
        return variations[dayIdx] || 0;
      }
      function getHumidityVariation(dayIdx) {
        const variations = [2, -2, -3, 0, 1, -1, 2]; // ì¼~í†  ìŠµë„ ë³€ë™
        return variations[dayIdx] || 0;
      }
      
      // ì£¼ê°„ ì‹œì‘ì¼ ê³„ì‚°
      const weekStartDate = WeeklyScheduler.getWeekStart();
      
      let html = '';
      for (let d = 0; d < 7; d++) {
        const isBlocked = d === 0 || d === 3;
        const dayTasks = (tasksByDay[d] || []).sort((a, b) => (a.startHour || 0) - (b.startHour || 0));
        
        // í•´ë‹¹ ìš”ì¼ì˜ ë‚ ì§œ ê³„ì‚°
        const dayDate = new Date(weekStartDate);
        dayDate.setDate(dayDate.getDate() + d);
        const dayDateStr = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
        
        // ìš”ì¼ë³„ ê¸°í›„ ë°ì´í„° (ë³€ë™ ì ìš©) - ì¼ì¶œ~ì¼ëª° 6ë“±ë¶„
        const tempVar = getDayVariation(d);
        const humVar = getHumidityVariation(d);
        
        // ì¼ì¶œ/ì¼ëª° ì‹œê°„ (ì›”ë³„)
        const sunTimes = WeeklyScheduler.getSunTimes(dayDate);
        const sunriseHour = Math.ceil(sunTimes.rise);  // ì¼ì¶œ ì‹œê°„ ì˜¬ë¦¼
        const sunsetHour = Math.floor(sunTimes.set);   // ì¼ëª° ì‹œê°„ ë‚´ë¦¼
        
        // ì¼ì¶œ~ì¼ëª°ì„ 6ë“±ë¶„í•˜ì—¬ 6ê°œ ì‹œê°„ëŒ€ ìƒì„±
        const hours = [];
        const dayLength = sunsetHour - sunriseHour;
        const interval = dayLength / 5; // 6ê°œ í¬ì¸íŠ¸ = 5ê°œ ê°„ê²©
        for (let i = 0; i < 6; i++) {
          hours.push(Math.round(sunriseHour + interval * i));
        }
        
        const hourlyData = hours.map(hr => {
          const base = climate.hourly.find(h => h.hour === hr) || climate.hourly.find(h => Math.abs(h.hour - hr) <= 1) || climate.hourly[Math.floor((hr - 6) / 3)];
          return {
            hour: hr,
            temp: (base?.temp || 0) + tempVar,
            humidity: Math.max(0, Math.min(100, (base?.humidity || 0) + humVar))
          };
        });
        
        // ì˜¨ë„ì— ë”°ë¥¸ ìƒ‰ìƒ (ì˜í•˜=íŒŒë‘, ì˜ìƒ=ë¹¨ê°•)
        const getTempColor = (temp) => {
          if (temp <= -10) return '#1e3a8a';      // ë§¤ìš° ì¶”ì›€: ì§„í•œ íŒŒë‘
          if (temp <= -5) return '#1d4ed8';       // ë§ì´ ì¶”ì›€: íŒŒë‘
          if (temp <= 0) return '#3b82f6';        // ì¶”ì›€: ë°ì€ íŒŒë‘
          if (temp <= 5) return '#f87171';        // ìŒ€ìŒ€: ì—°í•œ ë¹¨ê°•
          if (temp <= 10) return '#ef4444';       // ì„ ì„ : ë¹¨ê°•
          if (temp <= 15) return '#dc2626';       // ë³´í†µ: ì§„í•œ ë¹¨ê°•
          if (temp <= 20) return '#b91c1c';       // ë”°ëœ»: ë” ì§„í•œ ë¹¨ê°•
          if (temp <= 28) return '#991b1b';       // ë”ì›€: ì–´ë‘ìš´ ë¹¨ê°•
          if (temp <= 33) return '#7f1d1d';       // ë§¤ìš° ë”ì›€: ë§¤ìš° ì§„í•œ ë¹¨ê°•
          return '#450a0a';                        // í­ì—¼: ê°€ì¥ ì§„í•œ ë¹¨ê°•
        };
        
        html += `
          <div class="wsc-day ${isBlocked ? 'blocked' : ''}" 
               ondragover="handleDragOver(event)" 
               ondragleave="handleDragLeave(event)" 
               ondrop="handleDrop(event, ${d}, ${weekNo})">
            <div class="wsc-header">
              <div class="wsc-dayname">${DAYS_FULL[d]}</div>
              <div class="wsc-date" style="font-size:10px; color:#fef08a; margin-top:-2px;">${dayDateStr}</div>
              ${!isBlocked ? `
                <span class="wsc-badge">5ë…„í‰ê· </span>
                <div class="wsc-hourly-scroll">
                  ${hourlyData.map(h => `
                    <div class="wsc-hourly-item">
                      <span class="wsc-h-time">${h.hour}ì‹œ</span>
                      <span class="wsc-h-temp" style="color:${getTempColor(h.temp)}">${h.temp}Â°</span>
                      <span class="wsc-h-hum">ğŸ’§${h.humidity}%</span>
                    </div>
                  `).join('')}
                </div>
              ` : '<div class="wsc-blocked-label">ğŸš« íœ´ë¬´</div>'}
            </div>
            ${!isBlocked ? `
              <div class="wsc-tasks">
                ${dayTasks.length === 0 ? '<div class="wsc-no-task">ì‘ì—… ì—†ìŒ<div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div></div>' :
                  dayTasks.map((t, idx) => {
                    const taskId = t.type + '_' + idx;
                    // ì˜êµ¬ ì‚­ì œëœ ì‘ì—…ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    if (isTaskPermanentlyDeleted(weekNo, taskId)) return '';
                    const taskState = getTaskState(weekNo, d, taskId);
                    const statusClass = taskState.status === 'completed' ? 'completed' : (taskState.status === 'deleted' ? 'deleted' : '');
                    const taskTextEscaped = (t.text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                    <div class="wsc-task ${t.isWater ? 'water' : (t.isFertilizer ? 'fertilizer' : (t.isSpray ? 'spray' : (t.isPF ? 'pf' : (t.isHumidity ? 'humidity' : (t.conditions.weatherSensitive !== false ? 'ws' : 'wi')))))} ${statusClass}" 
                         draggable="true"
                         ondragstart="handleDragStart(event, '${taskId}', '${taskTextEscaped}', ${d}, ${weekNo})"
                         ondragend="handleDragEnd(event)"
                         ${t.detail ? `onclick="toggleTaskDetail(this)"` : ''}>
                      <div class="wsc-task-time">â° ${t.startHour}:00~${t.endHour}:00</div>
                      <div class="wsc-task-name">${t.text}${t.detail ? ' â–¾' : ''}${t.carriedOver ? '<span class="task-carried-over">ğŸ“Œ ì´ì›”</span>' : ''}</div>
                      <div class="wsc-task-cond" style="color:${t.isWater ? '#38bdf8' : t.isFertilizer ? '#22c55e' : t.isSpray ? '#f59e0b' : t.isPF ? '#8b5cf6' : t.isHumidity ? '#06b6d4' : t.conditions.weatherSensitive !== false ? '#fbbf24' : '#64748b'}">
                        ${t.isWater ? 'ğŸ’§ ê´€ìˆ˜ ì‘ì—…' : t.isFertilizer ? 'ğŸ§ª ì‹œë¹„ ì‘ì—…' : t.isSpray ? 'ğŸ§´ ì•½ì œ ì‚´í¬' : t.isPF ? 'ğŸ¦  PFë†ë²•' : t.isHumidity ? 'ğŸŒ¬ï¸ í™˜ê¸°/ìŠµë„' : t.conditions.weatherSensitive !== false ? 'ğŸŒ¡ï¸' + (hourlyData.find(h => h.hour === 12)?.temp || '-') + 'Â°C ğŸ’§' + (hourlyData.find(h => h.hour === 12)?.humidity || '-') + '%' : 'ğŸ“¦ ë‚ ì”¨ë¬´ê´€'}
                      </div>
                      ${t.detail ? `<div class="wsc-task-detail">${t.detail.replace(/\\n/g, '<br>')}</div>` : ''}
                      <div class="task-actions">
                        ${taskState.status === 'deleted' ? `
                          <button class="task-action-btn restore" onclick="restoreTask(${weekNo}, ${d}, '${taskId}', '${taskTextEscaped}', event)">ğŸ”„ ë³µì›</button>
                          <button class="task-action-btn permanent-delete" onclick="permanentDeleteTask(${weekNo}, ${d}, '${taskId}', '${taskTextEscaped}', event)">âŒ ì™„ì „ì‚­ì œ</button>
                        ` : `
                          <button class="task-action-btn complete" onclick="completeTask(${weekNo}, ${d}, '${taskId}', '${taskTextEscaped}', event)">${taskState.status === 'completed' ? 'â†©ï¸ ì·¨ì†Œ' : 'âœ… ì™„ë£Œ'}</button>
                          <button class="task-action-btn delete" onclick="deleteTask(${weekNo}, ${d}, '${taskId}', '${taskTextEscaped}', event)">ğŸ—‘ï¸ ì‚­ì œ</button>
                        `}
                      </div>
                    </div>
                  `}).join('')
                }
                <div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // í˜„ì¬ ì£¼ì°¨ ìë™ ì—´ê¸°
    function openCurrentWeek() {
      const items = document.querySelectorAll('.week-item');
      if (currentWeekNo >= 1 && currentWeekNo <= 52) {
        items[currentWeekNo - 1]?.classList.add('open', 'current');
        // ìŠ¤ì¼€ì¤„ëŸ¬ ë Œë”ë§
        setTimeout(() => renderWeekSchedulerCalendar(currentWeekNo), 100);
      }
    }
    
    // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
    function getWeatherIcon(code) {
      const icons = {
        '113': 'â˜€ï¸', '116': 'â›…', '119': 'â˜ï¸', '122': 'â˜ï¸',
        '143': 'ğŸŒ«ï¸', '176': 'ğŸŒ¦ï¸', '179': 'ğŸŒ¨ï¸', '182': 'ğŸŒ§ï¸',
        '185': 'ğŸŒ§ï¸', '200': 'â›ˆï¸', '227': 'ğŸŒ¨ï¸', '230': 'â„ï¸',
        '248': 'ğŸŒ«ï¸', '260': 'ğŸŒ«ï¸', '263': 'ğŸŒ¦ï¸', '266': 'ğŸŒ§ï¸',
        '281': 'ğŸŒ§ï¸', '284': 'ğŸŒ§ï¸', '293': 'ğŸŒ¦ï¸', '296': 'ğŸŒ§ï¸',
        '299': 'ğŸŒ§ï¸', '302': 'ğŸŒ§ï¸', '305': 'ğŸŒ§ï¸', '308': 'ğŸŒ§ï¸',
        '311': 'ğŸŒ§ï¸', '314': 'ğŸŒ§ï¸', '317': 'ğŸŒ¨ï¸', '320': 'ğŸŒ¨ï¸',
        '323': 'ğŸŒ¨ï¸', '326': 'ğŸŒ¨ï¸', '329': 'â„ï¸', '332': 'â„ï¸',
        '335': 'â„ï¸', '338': 'â„ï¸', '350': 'ğŸŒ§ï¸', '353': 'ğŸŒ¦ï¸',
        '356': 'ğŸŒ§ï¸', '359': 'ğŸŒ§ï¸', '362': 'ğŸŒ¨ï¸', '365': 'ğŸŒ¨ï¸',
        '368': 'ğŸŒ¨ï¸', '371': 'â„ï¸', '374': 'ğŸŒ¨ï¸', '377': 'ğŸŒ¨ï¸',
        '386': 'â›ˆï¸', '389': 'â›ˆï¸', '392': 'â›ˆï¸', '395': 'â„ï¸'
      };
      return icons[code] || 'ğŸŒ¤ï¸';
    }
    
    // ë‚ ì”¨ ë¡œë“œ
    async function loadWeather() {
      const location = document.getElementById('weatherLocation').value;
      const container = document.getElementById('weatherContent');
      
      try {
        container.innerHTML = '<div class="weather-loading">ë‚ ì”¨ ë¡œë”©ì¤‘...</div>';
        
        const response = await fetch(`https://wttr.in/${location}?format=j1`);
        if (!response.ok) throw new Error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        
        const data = await response.json();
        const today = data.weather[0];
        const tomorrow = data.weather[1];
        const current = data.current_condition[0];
        const currentHour = new Date().getHours();
        
        const todayIcon = getWeatherIcon(current.weatherCode);
        const tomorrowIcon = getWeatherIcon(tomorrow.hourly[4].weatherCode);
        
        // ì˜¨ë„ë³„ ìƒ‰ìƒ (ì˜í•˜=íŒŒë‘, ì˜ìƒ=ë¹¨ê°•)
        const getTempColor = (temp) => {
          const t = parseInt(temp);
          if (t <= -10) return '#1e3a8a';  // ë§¤ìš° ì¶”ì›€: ì§„í•œ íŒŒë‘
          if (t <= -5) return '#1d4ed8';   // ë§ì´ ì¶”ì›€: íŒŒë‘
          if (t <= 0) return '#3b82f6';    // ì¶”ì›€: ë°ì€ íŒŒë‘
          if (t <= 5) return '#f87171';    // ìŒ€ìŒ€: ì—°í•œ ë¹¨ê°•
          if (t <= 10) return '#ef4444';   // ì„ ì„ : ë¹¨ê°•
          if (t <= 15) return '#dc2626';   // ë³´í†µ: ì§„í•œ ë¹¨ê°•
          if (t <= 20) return '#b91c1c';   // ë”°ëœ»: ë” ì§„í•œ ë¹¨ê°•
          if (t <= 28) return '#991b1b';   // ë”ì›€: ì–´ë‘ìš´ ë¹¨ê°•
          if (t <= 33) return '#7f1d1d';   // ë§¤ìš° ë”ì›€: ë§¤ìš° ì§„í•œ ë¹¨ê°•
          return '#450a0a';               // í­ì—¼: ê°€ì¥ ì§„í•œ ë¹¨ê°•
        };
        
        // 3ì‹œê°„ ë°ì´í„°ë¥¼ 2ì‹œê°„ ë‹¨ìœ„ë¡œ ë³´ê°„
        const interpolateHourly = (hourlyData) => {
          const result = [];
          for (let hour = 0; hour <= 22; hour += 2) {
            // í•´ë‹¹ ì‹œê°„ì— ê°€ì¥ ê°€ê¹Œìš´ 3ì‹œê°„ ë°ì´í„° ì°¾ê¸°
            const idx = Math.min(Math.floor(hour / 3), hourlyData.length - 1);
            const nextIdx = Math.min(idx + 1, hourlyData.length - 1);
            const h = hourlyData[idx];
            const hNext = hourlyData[nextIdx];
            
            // ì„ í˜• ë³´ê°„ ê³„ìˆ˜
            const hourInSlot = hour % 3;
            const ratio = hourInSlot / 3;
            
            // ì˜¨ë„ ë³´ê°„
            const temp = Math.round(parseFloat(h.tempC) * (1 - ratio) + parseFloat(hNext.tempC) * ratio);
            // ê°•ìˆ˜ í™•ë¥ ì€ ë†’ì€ ê°’ ì‚¬ìš©
            const rain = Math.max(parseInt(h.chanceofrain), parseInt(hNext.chanceofrain) * ratio);
            const snow = Math.max(parseInt(h.chanceofsnow), parseInt(hNext.chanceofsnow) * ratio);
            
            result.push({
              hour,
              temp,
              rain: Math.round(rain),
              snow: Math.round(snow),
              weatherCode: h.weatherCode,
              icon: getWeatherIcon(h.weatherCode)
            });
          }
          return result;
        };
        
        // ì‹œê°„ë³„ ë°ì´í„° ë Œë”ë§ (2ì‹œê°„ ë‹¨ìœ„)
        const renderHourly = (hourlyData, dayLabel, isToday = false) => {
          const interpolated = interpolateHourly(hourlyData);
          
          return interpolated.map(h => {
            const isNow = isToday && currentHour >= h.hour && currentHour < h.hour + 2;
            const tempColor = getTempColor(h.temp);
            
            return `
              <div class="hourly-item ${isNow ? 'now' : ''}">
                <span class="time">${h.hour}ì‹œ</span>
                <span class="icon">${h.icon}</span>
                <span class="t" style="color:${tempColor};text-shadow:0 0 4px ${tempColor}40;">${h.temp}Â°</span>
                ${h.rain > 20 ? `<span class="rain">ğŸ’§${h.rain}%</span>` : ''}
                ${h.snow > 20 ? `<span class="snow">â„ï¸${h.snow}%</span>` : ''}
              </div>
            `;
          }).join('');
        };
        
        // ì˜¤ëŠ˜ ìµœëŒ€ ê°•ìˆ˜/ì ì„¤ í™•ë¥ 
        const todayMaxRain = Math.max(...today.hourly.map(h => parseInt(h.chanceofrain)));
        const todayMaxSnow = Math.max(...today.hourly.map(h => parseInt(h.chanceofsnow)));
        const tomorrowMaxRain = Math.max(...tomorrow.hourly.map(h => parseInt(h.chanceofrain)));
        const tomorrowMaxSnow = Math.max(...tomorrow.hourly.map(h => parseInt(h.chanceofsnow)));
        
        container.innerHTML = `
          <div class="weather-grid">
            <!-- ì˜¤ëŠ˜ -->
            <div class="weather-day">
              <div class="day-header">
                <span class="day-label">ì˜¤ëŠ˜ (${today.date.slice(5).replace('-', '/')})</span>
                <span class="day-icon">${todayIcon}</span>
                <span class="day-temp">${today.mintempC}Â° ~ ${today.maxtempC}Â°C</span>
                <span class="day-desc">${current.lang_ko?.[0]?.value || current.weatherDesc[0].value}</span>
                <span class="day-precip">
                  ${todayMaxRain > 20 ? `ğŸ’§${todayMaxRain}%` : ''}
                  ${todayMaxSnow > 20 ? `â„ï¸${todayMaxSnow}%` : ''}
                </span>
              </div>
              <div class="hourly-scroll">${renderHourly(today.hourly, 'ì˜¤ëŠ˜', true)}</div>
            </div>
            
            <!-- ë‚´ì¼ -->
            <div class="weather-day">
              <div class="day-header">
                <span class="day-label">ë‚´ì¼ (${tomorrow.date.slice(5).replace('-', '/')})</span>
                <span class="day-icon">${tomorrowIcon}</span>
                <span class="day-temp">${tomorrow.mintempC}Â° ~ ${tomorrow.maxtempC}Â°C</span>
                <span class="day-desc">${tomorrow.hourly[4].lang_ko?.[0]?.value || tomorrow.hourly[4].weatherDesc[0].value}</span>
                <span class="day-precip">
                  ${tomorrowMaxRain > 20 ? `ğŸ’§${tomorrowMaxRain}%` : ''}
                  ${tomorrowMaxSnow > 20 ? `â„ï¸${tomorrowMaxSnow}%` : ''}
                </span>
              </div>
              <div class="hourly-scroll">${renderHourly(tomorrow.hourly, 'ë‚´ì¼', false)}</div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<div class="weather-loading">âš ï¸ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    }
    
    // =============================================
    // ì£¼ê°„ ìŠ¤ì¼€ì¤„ëŸ¬ ê¸°ëŠ¥
    // =============================================
    
    function toggleScheduler() {
      document.getElementById('schedulerPanel').classList.toggle('open');
    }
    
    function toggleCollapsible(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('open');
      }
    }
    
    function toggleTaskDetail(element) {
      element.classList.toggle('open');
    }
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜
    let draggedTask = null;
    let draggedTaskData = null;
    let dragSourceDay = null;
    let dragSourceWeek = null;
    
    // ì‚¬ìš©ì ì‘ì—… ì´ë™ ì €ì¥ì†Œ
    let taskMoveOverrides = JSON.parse(localStorage.getItem('taskMoveOverrides') || '{}');
    
    function saveTaskMoveOverrides() {
      localStorage.setItem('taskMoveOverrides', JSON.stringify(taskMoveOverrides));
    }
    
    function handleDragStart(e, taskId, taskText, sourceDay, weekNo) {
      draggedTask = e.target;
      draggedTaskData = { taskId, taskText, sourceDay, weekNo };
      dragSourceDay = sourceDay;
      dragSourceWeek = weekNo;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify({ taskId, taskText, sourceDay, weekNo }));
    }
    
    function handleDragEnd(e) {
      if (draggedTask) {
        draggedTask.classList.remove('dragging');
      }
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      draggedTask = null;
      draggedTaskData = null;
      dragSourceDay = null;
      dragSourceWeek = null;
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const dayColumn = e.target.closest('.wsc-day, .day-column-full, .day-col-full');
      if (dayColumn && !dayColumn.classList.contains('blocked')) {
        dayColumn.classList.add('drag-over');
      }
    }
    
    function handleDragLeave(e) {
      const dayColumn = e.target.closest('.wsc-day, .day-column-full, .day-col-full');
      if (dayColumn) {
        dayColumn.classList.remove('drag-over');
      }
    }
    
    function handleDrop(e, targetDay, weekNo) {
      e.preventDefault();
      const dayColumn = e.target.closest('.wsc-day, .day-column-full, .day-col-full');
      if (dayColumn) {
        dayColumn.classList.remove('drag-over');
      }
      
      if (!draggedTaskData) return;
      
      // ì¼ìš”ì¼(0), ìˆ˜ìš”ì¼(3)ì€ ë“œë¡­ ë¶ˆê°€
      if (targetDay === 0 || targetDay === 3) {
        alert('ì¼ìš”ì¼ê³¼ ìˆ˜ìš”ì¼ì€ ì‘ì—… ë¶ˆê°€ì¼ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ê°™ì€ ë‚ ì´ë©´ ë¬´ì‹œ
      if (draggedTaskData.sourceDay === targetDay && draggedTaskData.weekNo === weekNo) {
        return;
      }
      
      // ì‘ì—… ì´ë™ ì €ì¥
      const moveKey = `${weekNo}_${draggedTaskData.taskId}`;
      taskMoveOverrides[moveKey] = {
        taskId: draggedTaskData.taskId,
        taskText: draggedTaskData.taskText,
        originalDay: draggedTaskData.sourceDay,
        newDay: targetDay,
        weekNo: weekNo
      };
      saveTaskMoveOverrides();
      
      // ìŠ¤ì¼€ì¤„ëŸ¬ ë‹¤ì‹œ ë Œë”ë§
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      alert(`ì‘ì—…ì´ ${dayNames[draggedTaskData.sourceDay]}ìš”ì¼ì—ì„œ ${dayNames[targetDay]}ìš”ì¼ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      
      loadScheduler();
      renderFullYearScheduler();
    }
    
    function getMovedDay(weekNo, taskId, originalDay) {
      const moveKey = `${weekNo}_${taskId}`;
      if (taskMoveOverrides[moveKey]) {
        return taskMoveOverrides[moveKey].newDay;
      }
      return originalDay;
    }
    
    function resetTaskMoves() {
      if (confirm('ëª¨ë“  ì‘ì—… ì´ë™ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        taskMoveOverrides = {};
        saveTaskMoveOverrides();
        loadScheduler();
        renderFullYearScheduler();
        alert('ì‘ì—… ì´ë™ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì‘ì—… ìƒíƒœ ì €ì¥ì†Œ (ì™„ë£Œ, ì‚­ì œ)
    let taskStates = JSON.parse(localStorage.getItem('taskStates') || '{}');
    
    // ì˜êµ¬ ì‚­ì œëœ ì‘ì—… ì €ì¥ì†Œ (ë‹¤ì‹œ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŒ)
    let permanentlyDeletedTasks = JSON.parse(localStorage.getItem('permanentlyDeletedTasks') || '{}');
    
    function savePermanentlyDeletedTasks() {
      localStorage.setItem('permanentlyDeletedTasks', JSON.stringify(permanentlyDeletedTasks));
    }
    
    function isTaskPermanentlyDeleted(weekNo, taskId) {
      // weekNoì™€ taskId ì¡°í•©ìœ¼ë¡œ í™•ì¸ (dayIdxëŠ” ì´ë™ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œì™¸)
      const key = `${weekNo}_${taskId}`;
      return permanentlyDeletedTasks[key] === true;
    }
    
    function addToPermanentlyDeleted(weekNo, taskId, taskText) {
      const key = `${weekNo}_${taskId}`;
      permanentlyDeletedTasks[key] = true;
      savePermanentlyDeletedTasks();
    }
    
    function saveTaskStates() {
      localStorage.setItem('taskStates', JSON.stringify(taskStates));
    }
    
    function getTaskStateKey(weekNo, dayIdx, taskId) {
      return `${weekNo}_${dayIdx}_${taskId}`;
    }
    
    function getTaskState(weekNo, dayIdx, taskId) {
      const key = getTaskStateKey(weekNo, dayIdx, taskId);
      return taskStates[key] || { status: 'pending' };
    }
    
    function setTaskState(weekNo, dayIdx, taskId, taskText, status) {
      const key = getTaskStateKey(weekNo, dayIdx, taskId);
      taskStates[key] = { 
        status: status, 
        taskText: taskText,
        weekNo: weekNo,
        dayIdx: dayIdx,
        taskId: taskId,
        updatedAt: new Date().toISOString()
      };
      saveTaskStates();
    }
    
    function completeTask(weekNo, dayIdx, taskId, taskText, event) {
      event.stopPropagation();
      const currentState = getTaskState(weekNo, dayIdx, taskId);
      if (currentState.status === 'completed') {
        setTaskState(weekNo, dayIdx, taskId, taskText, 'pending');
      } else {
        setTaskState(weekNo, dayIdx, taskId, taskText, 'completed');
      }
      loadScheduler();
      renderFullYearScheduler();
    }
    
    function deleteTask(weekNo, dayIdx, taskId, taskText, event) {
      event.stopPropagation();
      if (confirm('ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        setTaskState(weekNo, dayIdx, taskId, taskText, 'deleted');
        loadScheduler();
        renderFullYearScheduler();
      }
    }
    
    function restoreTask(weekNo, dayIdx, taskId, taskText, event) {
      event.stopPropagation();
      setTaskState(weekNo, dayIdx, taskId, taskText, 'pending');
      loadScheduler();
      renderFullYearScheduler();
    }
    
    function permanentDeleteTask(weekNo, dayIdx, taskId, taskText, event) {
      event.stopPropagation();
      if (confirm('ì´ ì‘ì—…ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µì› ë¶ˆê°€ëŠ¥, í”„ë¡œê·¸ë¨ ì¬ì‹œì‘ í›„ì—ë„ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŒ)')) {
        const key = weekNo + '_' + dayIdx + '_' + taskId;
        delete taskStates[key];
        saveTaskStates();
        
        // ì´ë™ëœ ì‘ì—…ì—ì„œë„ ì‚­ì œ
        delete taskMoveOverrides[key];
        saveTaskMoveOverrides();
        
        // ì´ì›”ëœ ì‘ì—…ì—ì„œë„ ì‚­ì œ
        const carriedKey = weekNo + '_' + taskId;
        delete carriedOverTasks[carriedKey];
        saveCarriedOverTasks();
        
        // ì˜êµ¬ ì‚­ì œ ëª©ë¡ì— ì¶”ê°€ (ë‹¤ì‹œ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŒ)
        addToPermanentlyDeleted(weekNo, taskId, taskText);
        
        loadScheduler();
        renderFullYearScheduler();
      }
    }
    
    // ì´ì›”ëœ ì‘ì—… (ë¯¸ì™„ë£Œ ì‘ì—…ì„ ë‹¤ìŒ ì£¼ë¡œ)
    let carriedOverTasks = JSON.parse(localStorage.getItem('carriedOverTasks') || '{}');
    
    function saveCarriedOverTasks() {
      localStorage.setItem('carriedOverTasks', JSON.stringify(carriedOverTasks));
    }
    
    function getCarriedOverTasksForWeek(weekNo) {
      return carriedOverTasks[weekNo] || [];
    }
    
    function carryOverIncompleteTasks() {
      const today = new Date();
      const currentWeekNo = getWeekNumber(today);
      
      // ì§€ë‚œ ì£¼ì˜ ë¯¸ì™„ë£Œ ì‘ì—…ë“¤ì„ ì°¾ì•„ì„œ ì´ë²ˆ ì£¼ë¡œ ì´ì›”
      const previousWeekNo = currentWeekNo - 1;
      if (previousWeekNo < 1) return;
      
      const incompleteTasks = [];
      
      // ì´ì „ ì£¼ì˜ ëª¨ë“  ì‘ì—… ìƒíƒœ í™•ì¸
      Object.keys(taskStates).forEach(key => {
        const state = taskStates[key];
        if (state.weekNo === previousWeekNo && state.status === 'pending') {
          incompleteTasks.push({
            taskText: state.taskText,
            originalWeekNo: state.weekNo,
            originalDayIdx: state.dayIdx,
            taskId: state.taskId
          });
        }
      });
      
      if (incompleteTasks.length > 0) {
        // í˜„ì¬ ì£¼ì— ì´ì›” ì‘ì—… ì¶”ê°€
        if (!carriedOverTasks[currentWeekNo]) {
          carriedOverTasks[currentWeekNo] = [];
        }
        
        incompleteTasks.forEach(task => {
          // ì¤‘ë³µ ì²´í¬
          const exists = carriedOverTasks[currentWeekNo].some(t => 
            t.taskId === task.taskId && t.originalWeekNo === task.originalWeekNo
          );
          if (!exists) {
            carriedOverTasks[currentWeekNo].push(task);
          }
        });
        
        saveCarriedOverTasks();
      }
    }
    
    function resetAllTaskStates() {
      if (confirm('ëª¨ë“  ì‘ì—… ìƒíƒœ (ì™„ë£Œ/ì‚­ì œ)ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        taskStates = {};
        carriedOverTasks = {};
        saveTaskStates();
        saveCarriedOverTasks();
        loadScheduler();
        renderFullYearScheduler();
        alert('ëª¨ë“  ì‘ì—… ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function getWeekNumber(date) {
      // ì—´ê°€ë‘  ì‹œì‘ì¼ (1ì£¼ì°¨ ê¸°ì¤€) - ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
      const heatStartInput = document.getElementById('heatStart');
      const heatStart = heatStartInput ? new Date(heatStartInput.value) : new Date(date.getFullYear(), 0, 19);
      const days = Math.floor((date - heatStart) / (24 * 60 * 60 * 1000));
      return days < 0 ? 0 : Math.floor(days / 7) + 1;
    }
    
    // ìˆ˜ë™ìœ¼ë¡œ ì´ì›” ì‘ì—… ì‹¤í–‰
    function carryOverManually() {
      const today = new Date();
      const currentWeekNo = getWeekNumber(today);
      const previousWeekNo = currentWeekNo - 1;
      
      if (previousWeekNo < 1) {
        alert('ì´ì „ ì£¼ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì´ì „ ì£¼ì˜ ëª¨ë“  ì‘ì—… ì¤‘ 'pending' ìƒíƒœì¸ ì‘ì—… ì°¾ê¸°
      const incompleteTasks = [];
      
      Object.keys(taskStates).forEach(key => {
        const state = taskStates[key];
        if (state.weekNo === previousWeekNo && state.status === 'pending') {
          incompleteTasks.push({
            taskText: state.taskText,
            originalWeekNo: state.weekNo,
            originalDayIdx: state.dayIdx,
            taskId: state.taskId
          });
        }
      });
      
      // ì´ì „ ì£¼ì— ê¸°ë¡ë˜ì§€ ì•Šì€ ì‘ì—…ë“¤ë„ í™•ì¸ (ìƒíƒœê°€ ì—†ìœ¼ë©´ pendingìœ¼ë¡œ ê°„ì£¼)
      // ì´ì „ ì£¼ì˜ ëª¨ë“  ì‘ì—…ì„ ì²´í¬
      const { WEEKLY_DATA } = window.ShineExpert;
      const prevWeekData = WEEKLY_DATA[previousWeekNo];
      if (prevWeekData && prevWeekData.tasks) {
        prevWeekData.tasks.forEach((taskText, idx) => {
          const taskId = 'GENERAL_' + idx;
          const key = getTaskStateKey(previousWeekNo, 1, taskId);
          if (!taskStates[key]) {
            // ìƒíƒœê°€ ì—†ìœ¼ë©´ ë¯¸ì™„ë£Œë¡œ ê°„ì£¼í•˜ì—¬ ì´ì›”
            incompleteTasks.push({
              taskText: taskText,
              originalWeekNo: previousWeekNo,
              originalDayIdx: 1,
              taskId: taskId
            });
          }
        });
      }
      
      if (incompleteTasks.length === 0) {
        alert(`${previousWeekNo}ì£¼ì°¨ì˜ ë¯¸ì™„ë£Œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      
      if (!confirm(`${previousWeekNo}ì£¼ì°¨ì˜ ë¯¸ì™„ë£Œ ì‘ì—… ${incompleteTasks.length}ê±´ì„ ${currentWeekNo}ì£¼ì°¨ë¡œ ì´ì›”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }
      
      // í˜„ì¬ ì£¼ì— ì´ì›” ì‘ì—… ì¶”ê°€
      if (!carriedOverTasks[currentWeekNo]) {
        carriedOverTasks[currentWeekNo] = [];
      }
      
      let addedCount = 0;
      incompleteTasks.forEach(task => {
        // ì¤‘ë³µ ì²´í¬
        const exists = carriedOverTasks[currentWeekNo].some(t => 
          t.taskId === task.taskId && t.originalWeekNo === task.originalWeekNo
        );
        if (!exists) {
          carriedOverTasks[currentWeekNo].push(task);
          addedCount++;
        }
      });
      
      saveCarriedOverTasks();
      loadScheduler();
      renderFullYearScheduler();
      alert(`${addedCount}ê±´ì˜ ì‘ì—…ì´ ì´ì›”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì›” ì‘ì—… í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
      carryOverIncompleteTasks();
    });
    
    function applyTaskMoveOverrides(tasksByDay, weekNo) {
      // ì´ë™ëœ ì‘ì—…ë“¤ì„ ì ìš©
      const movedTasks = [];
      
      // í•´ë‹¹ ì£¼ì°¨ì˜ ëª¨ë“  ì´ë™ ì„¤ì • ì°¾ê¸°
      Object.keys(taskMoveOverrides).forEach(key => {
        if (key.startsWith(weekNo + '_')) {
          movedTasks.push(taskMoveOverrides[key]);
        }
      });
      
      // ê° ì´ë™ ì„¤ì • ì ìš©
      movedTasks.forEach(move => {
        const originalDay = move.originalDay;
        const newDay = move.newDay;
        const taskId = move.taskId;
        
        // ì›ë˜ ë‚ ì§œì—ì„œ ì‘ì—… ì°¾ê¸°
        if (tasksByDay[originalDay]) {
          const taskIndex = tasksByDay[originalDay].findIndex((t, idx) => {
            return (t.type + '_' + idx) === taskId;
          });
          
          if (taskIndex !== -1) {
            // ì‘ì—…ì„ ìƒˆ ë‚ ì§œë¡œ ì´ë™
            const task = tasksByDay[originalDay].splice(taskIndex, 1)[0];
            if (!tasksByDay[newDay]) tasksByDay[newDay] = [];
            tasksByDay[newDay].push(task);
          }
        }
      });
      
      // ì´ì›”ëœ ì‘ì—… ì¶”ê°€ (ì´ì „ ì£¼ì—ì„œ ë¯¸ì™„ë£Œëœ ì‘ì—…)
      const carriedTasks = getCarriedOverTasksForWeek(weekNo);
      if (carriedTasks.length > 0) {
        // ì›”ìš”ì¼(1)ì— ì´ì›” ì‘ì—… ì¶”ê°€
        if (!tasksByDay[1]) tasksByDay[1] = [];
        
        carriedTasks.forEach((ct, idx) => {
          // ì´ë¯¸ ì™„ë£Œë˜ê±°ë‚˜ ì‚­ì œëœ ì´ì›” ì‘ì—…ì€ ì œì™¸
          const ctState = getTaskState(weekNo, 1, `CARRIED_${idx}`);
          if (ctState.status !== 'deleted') {
            tasksByDay[1].push({
              text: `ğŸ“Œ ${ct.taskText} (${ct.originalWeekNo}ì£¼ì°¨ ì´ì›”)`,
              type: 'CARRIED',
              carriedOver: true,
              originalWeekNo: ct.originalWeekNo,
              conditions: { weatherSensitive: false },
              startHour: 9,
              endHour: 11
            });
          }
        });
      }
      
      return tasksByDay;
    }
    
    async function loadScheduler() {
      const location = document.getElementById('weatherLocation').value;
      const { WEEKLY_DATA } = window.ShineExpert;
      const weekNo = currentWeekNo || 1;
      const weekData = WEEKLY_DATA[weekNo] || WEEKLY_DATA[1];
      
      try {
        const result = await WeeklyScheduler.generateWeeklySchedule(weekData, location, weekNo);
        
        // ì‚¬ìš©ì ì •ì˜ ì‘ì—… ë³‘í•©
        result.scheduledTasks = mergeCustomTasksToSchedule(result.scheduledTasks);
        
        renderWeekCalendar(result);
        renderExternalEvents();
        renderCustomTasks();
      } catch (error) {
        console.error('ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('weekCalendar').innerHTML = 
          '<div class="weather-loading">âš ï¸ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }
    
    function renderWeekCalendar(result) {
      const container = document.getElementById('weekCalendar');
      const today = new Date();
      today.setHours(0,0,0,0);
      
      let html = '';
      const unscheduled = [];
      
      // 7ì¼ (ì¼~í† ) ë Œë”ë§
      for (let i = 0; i < 7; i++) {
        const date = new Date(result.weekStart);
        date.setDate(date.getDate() + i);
        const dayIndex = date.getDay();
        const dateStr = WeeklyScheduler.formatDateFull(date);
        const isBlocked = WeeklyScheduler.isBlockedDay(dayIndex);
        const isToday = date.getTime() === today.getTime();
        
        // í•´ë‹¹ ë‚ ì§œì˜ ë‚ ì”¨ (ì‘ë…„ ë°ì´í„° ê¸°ì¤€ - ìŠ¤ì¼€ì¤„ë§ìš©)
        const dayWeather = result.fullWeatherByDate ? result.fullWeatherByDate[dateStr] : null;
        const isHistorical = dayWeather && dayWeather.isHistorical;
        
        // ì‹¤ì‹œê°„ ë‚ ì”¨ (ì°¸ê³ ìš©)
        const realtimeWeather = result.realtimeWeatherData ? result.realtimeWeatherData[dateStr] : null;
        
        // í•´ë‹¹ ë‚ ì§œì˜ ì´ìƒê¸°í›„ ì•Œë¦¼
        const dayAlerts = result.alertsByDate ? result.alertsByDate[dateStr] : [];
        const hasAlert = dayAlerts && dayAlerts.length > 0;
        const hasSevereAlert = dayAlerts && dayAlerts.some(a => 
          a.type === 'EXTREME_HEAT' || a.type === 'HEAVY_RAIN' || a.type === 'LOCALIZED_STORM'
        );
        
        // í•´ë‹¹ ë‚ ì§œì˜ ì‘ì—…ë“¤
        const dayTasks = result.scheduledTasks.filter(t => t.date === dateStr);
        
        // ì‹œê°„ë³„ ì˜¨ë„/ìŠµë„ ìš”ì•½ (ì˜¤ì „/ì˜¤í›„)
        let hourlyInfo = '';
        if (dayWeather && dayWeather.hourly) {
          const morning = dayWeather.hourly.find(h => h.hour === 9) || dayWeather.hourly[3];
          const noon = dayWeather.hourly.find(h => h.hour === 12) || dayWeather.hourly[6];
          const afternoon = dayWeather.hourly.find(h => h.hour === 15) || dayWeather.hourly[9];
          
          hourlyInfo = `
            <div class="hourly-climate">
              <div class="hourly-row" title="09ì‹œ">
                <span class="h-time">09</span>
                <span class="h-temp">${morning?.temp || '-'}Â°</span>
                <span class="h-humid">${morning?.humidity || '-'}%</span>
              </div>
              <div class="hourly-row" title="12ì‹œ">
                <span class="h-time">12</span>
                <span class="h-temp">${noon?.temp || '-'}Â°</span>
                <span class="h-humid">${noon?.humidity || '-'}%</span>
              </div>
              <div class="hourly-row" title="15ì‹œ">
                <span class="h-time">15</span>
                <span class="h-temp">${afternoon?.temp || '-'}Â°</span>
                <span class="h-humid">${afternoon?.humidity || '-'}%</span>
              </div>
            </div>
          `;
        }
        
        // ì´ìƒê¸°í›„ ì•Œë¦¼ ë°°ì§€
        let alertBadges = '';
        if (hasAlert && !isBlocked) {
          alertBadges = `
            <div class="weather-alerts">
              ${dayAlerts.map(a => `<span class="alert-badge ${a.type}">${a.name}</span>`).join('')}
            </div>
          `;
          
          // ê°€ì¥ ì¤‘ìš”í•œ ê¶Œê³ ì‚¬í•­ í‘œì‹œ
          const mainAlert = dayAlerts[0];
          if (mainAlert && mainAlert.recommendation) {
            alertBadges += `<div class="alert-recommendation">ğŸ’¡ ${mainAlert.recommendation}</div>`;
          }
        }
        
        // ì¼ì¶œ/ì¼ëª° ì‹œê°„ ê³„ì‚°
        const sunTimes = WeeklyScheduler.getSunTimes(date);
        const sunriseHour = Math.ceil(sunTimes.rise);
        const sunsetHour = Math.floor(sunTimes.set);
        
        // ì¼ì¶œ~ì¼ëª°ì„ 6ë“±ë¶„í•˜ì—¬ 6ê°œ ì‹œê°„ëŒ€ ìƒì„±
        const hours = [];
        const dayLength = sunsetHour - sunriseHour;
        const interval = dayLength / 5;
        for (let j = 0; j < 6; j++) {
          hours.push(Math.round(sunriseHour + interval * j));
        }
        
        // ì˜¤ëŠ˜ë¶€í„° ë©°ì¹  í›„ì¸ì§€ ê³„ì‚°
        const currentDate = new Date(date);
        currentDate.setHours(0, 0, 0, 0);
        const daysDiff = Math.floor((currentDate - today) / (1000 * 60 * 60 * 24));
        
        // ì˜¤ëŠ˜, ë‚´ì¼, ëª¨ë ˆ(0, 1, 2ì¼ í›„)ê¹Œì§€ëŠ” ì‹¤ì‹œê°„, ê·¸ ì´í›„ëŠ” 5ë…„ í‰ê· 
        const useRealtime = daysDiff >= 0 && daysDiff <= 2 && realtimeWeather && realtimeWeather.hourly;
        
        // ìš”ì¼ë³„ ê¸°í›„ ë³€ë™ (5ë…„ í‰ê· ìš©)
        const tempVariations = [-1, 1, 2, 0, -1, 1, 0]; // ì¼~í†  ì˜¨ë„ ë³€ë™
        const humVariations = [2, -2, -3, 0, 1, -1, 2]; // ì¼~í†  ìŠµë„ ë³€ë™
        const tempVar = tempVariations[dayIndex] || 0;
        const humVar = humVariations[dayIndex] || 0;
        
        // 5ë…„ í‰ê·  ê¸°í›„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const climate = result.historicalClimate || WeeklyScheduler.getHistoricalClimate(currentWeekNo);
        
        // ì‹œê°„ë³„ ë°ì´í„° ìƒì„±
        const hourlyDataForDisplay = hours.map(hr => {
          let temp = 0, humidity = 0;
          
          if (useRealtime) {
            // ì‹¤ì‹œê°„ ë‚ ì”¨ ì‚¬ìš© (ì˜¤ëŠ˜, ë‚´ì¼, ëª¨ë ˆ)
            const found = realtimeWeather.hourly.find(h => h.hour === hr) || realtimeWeather.hourly.find(h => Math.abs(h.hour - hr) <= 1);
            if (found) {
              temp = found.temp || 0;
              humidity = found.humidity || 0;
            }
          } else if (climate && climate.hourly) {
            // 5ë…„ í‰ê·  ì‚¬ìš© (ê·¸ ì´í›„)
            const base = climate.hourly.find(h => h.hour === hr) || climate.hourly.find(h => Math.abs(h.hour - hr) <= 1) || climate.hourly[Math.floor((hr - 6) / 3)];
            if (base) {
              temp = (base.temp || 0) + tempVar;
              humidity = Math.max(0, Math.min(100, (base.humidity || 0) + humVar));
            }
          }
          return { hour: hr, temp, humidity };
        });
        
        // ë°°ì§€ í…ìŠ¤íŠ¸ ê²°ì •
        const badgeText = useRealtime ? 'ğŸ”´ì‹¤ì‹œê°„' : '5ë…„í‰ê· ';
        
        // ì˜¨ë„ì— ë”°ë¥¸ ìƒ‰ìƒ
        const getTempColorTop = (temp) => {
          if (temp <= -10) return '#1e3a8a';
          if (temp <= -5) return '#1d4ed8';
          if (temp <= 0) return '#3b82f6';
          if (temp <= 5) return '#f87171';
          if (temp <= 10) return '#ef4444';
          if (temp <= 15) return '#dc2626';
          if (temp <= 20) return '#b91c1c';
          if (temp <= 28) return '#991b1b';
          if (temp <= 33) return '#7f1d1d';
          return '#450a0a';
        };
        
        const weekNo = result.weekNo || currentWeekNo || 1;
        
        html += `
          <div class="wsc-day ${isBlocked ? 'blocked' : ''} ${isToday ? 'today' : ''} ${hasAlert ? 'has-alert' : ''} ${hasSevereAlert ? 'has-severe-alert' : ''}"
               ondragover="handleDragOver(event)" 
               ondragleave="handleDragLeave(event)" 
               ondrop="handleDrop(event, ${dayIndex}, ${weekNo})">
            <div class="wsc-header">
              <div class="wsc-dayname">${WeeklyScheduler.DAYS_FULL[dayIndex]}</div>
              <div class="wsc-date" style="font-size:10px; color:#fef08a; margin-top:-2px;">${WeeklyScheduler.formatDate(date)}</div>
              ${!isBlocked ? `
                <span class="wsc-badge">${badgeText}</span>
                <div class="wsc-hourly-scroll">
                  ${hourlyDataForDisplay.map(h => `
                    <div class="wsc-hourly-item">
                      <span class="wsc-h-time">${h.hour}ì‹œ</span>
                      <span class="wsc-h-temp" style="color:${getTempColorTop(h.temp)}">${h.temp}Â°</span>
                      <span class="wsc-h-hum">ğŸ’§${h.humidity}%</span>
                    </div>
                  `).join('')}
                </div>
                ${alertBadges}
              ` : (isBlocked ? '<div class="wsc-blocked-label">ğŸš« íœ´ë¬´</div>' : '')}
            </div>
            ${!isBlocked ? `
              <div class="wsc-tasks">
                ${renderDayTasks(dayTasks, weekNo)}
              </div>
            ` : ''}
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // ë°°ì¹˜ ë¶ˆê°€ ì‘ì—… í‘œì‹œ (ë¹„í™œì„±í™”)
      // const unscheduledSection = document.getElementById('unscheduledSection');
      // if (unscheduledSection) unscheduledSection.style.display = 'none';
    }
    
    function renderDayTasks(tasks, weekNoParam) {
      const weekNo = weekNoParam || currentWeekNo || 1;
      
      if (tasks.length === 0) {
        return '<div class="wsc-no-task">ì‘ì—… ì—†ìŒ<div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div></div>';
      }
      
      // ì‹œì‘ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedTasks = [...tasks].sort((a, b) => (a.startHour || 0) - (b.startHour || 0));
      
      let html = sortedTasks.map((t, idx) => {
        const isWater = t.taskType === 'WATER';
        const isFertilizer = t.taskType === 'FERTILIZER';
        const isPF = t.taskType === 'PF';
        const isSpray = t.taskType === 'SPRAY';
        const isHumidity = t.taskType === 'HUMIDITY';
        const hasDetail = t.detail && t.detail.length > 0;
        
        // ì‘ì—… ìƒíƒœ í™•ì¸
        const taskId = (t.taskType || 'GENERAL') + '_' + idx;
        const dayIndex = t.dayIndex !== undefined ? t.dayIndex : new Date(t.date).getDay();
        
        // ì˜êµ¬ ì‚­ì œëœ ì‘ì—…ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        if (isTaskPermanentlyDeleted(weekNo, taskId)) return '';
        
        const taskState = getTaskState(weekNo, dayIndex, taskId);
        const statusClass = taskState.status === 'completed' ? 'completed' : (taskState.status === 'deleted' ? 'deleted' : '');
        const taskTextEscaped = (t.task || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        // ì‘ì—… ìœ í˜•ë³„ í´ë˜ìŠ¤
        const typeClass = isWater ? 'water' : isFertilizer ? 'fertilizer' : isSpray ? 'spray' : isPF ? 'pf' : isHumidity ? 'humidity' : (t.weatherSensitive !== false ? 'ws' : 'wi');
        
        // ì‘ì—… ì¡°ê±´ ìƒ‰ìƒ
        const condColor = isWater ? '#38bdf8' : isFertilizer ? '#22c55e' : isSpray ? '#f59e0b' : isPF ? '#8b5cf6' : isHumidity ? '#06b6d4' : (t.weatherSensitive !== false ? '#fbbf24' : '#64748b');
        
        // ì‘ì—… ì¡°ê±´ í…ìŠ¤íŠ¸
        let condText = '';
        if (isWater) condText = 'ğŸ’§ ê´€ìˆ˜ ì‘ì—…';
        else if (isFertilizer) condText = 'ğŸ§ª ì‹œë¹„ ì‘ì—…';
        else if (isSpray) condText = 'ğŸ§´ ì•½ì œ ì‚´í¬';
        else if (isPF) condText = 'ğŸ¦  PFë†ë²•';
        else if (isHumidity) condText = 'ğŸŒ¬ï¸ í™˜ê¸°/ìŠµë„';
        else if (t.weatherSensitive !== false && t.weather) condText = `ğŸŒ¡ï¸${t.weather.temp}Â°C ğŸ’§${t.weather.humidity}%`;
        else condText = 'ğŸ“¦ ë‚ ì”¨ë¬´ê´€';
        
        return `
        <div class="wsc-task ${typeClass} ${statusClass}" 
             draggable="true"
             ondragstart="handleDragStart(event, '${taskId}', '${taskTextEscaped}', ${dayIndex}, ${weekNo})"
             ondragend="handleDragEnd(event)"
             ${hasDetail ? 'onclick="toggleTaskDetail(this)"' : ''}>
          <div class="wsc-task-time">â° ${t.startHour}:00~${t.endHour}:00</div>
          <div class="wsc-task-name">${t.task}${hasDetail ? ' â–¾' : ''}${t.carriedOver ? '<span class="task-carried-over">ğŸ“Œ ì´ì›”</span>' : ''}</div>
          <div class="wsc-task-cond" style="color:${condColor}">
            ${condText}
          </div>
          ${hasDetail ? `<div class="wsc-task-detail">${t.detail.replace(/\\n/g, '<br>')}</div>` : ''}
          <div class="task-actions">
            ${taskState.status === 'deleted' ? `
              <button class="task-action-btn restore" onclick="event.stopPropagation(); restoreTask(${weekNo}, ${dayIndex}, '${taskId}', '${taskTextEscaped}', event)">ğŸ”„ ë³µì›</button>
              <button class="task-action-btn permanent-delete" onclick="event.stopPropagation(); permanentDeleteTask(${weekNo}, ${dayIndex}, '${taskId}', '${taskTextEscaped}', event)">âŒ ì™„ì „ì‚­ì œ</button>
            ` : `
              <button class="task-action-btn complete" onclick="event.stopPropagation(); completeTask(${weekNo}, ${dayIndex}, '${taskId}', '${taskTextEscaped}', event)">${taskState.status === 'completed' ? 'â†©ï¸ ì·¨ì†Œ' : 'âœ… ì™„ë£Œ'}</button>
              <button class="task-action-btn delete" onclick="event.stopPropagation(); deleteTask(${weekNo}, ${dayIndex}, '${taskId}', '${taskTextEscaped}', event)">ğŸ—‘ï¸ ì‚­ì œ</button>
            `}
          </div>
        </div>
      `}).join('');
      
      html += '<div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div>';
      return html;
    }
    
    function renderExternalEvents() {
      const events = WeeklyScheduler.loadExternalEvents();
      const container = document.getElementById('eventList');
      
      if (events.length === 0) {
        container.innerHTML = '<div style="color:#475569; font-size:9px;">ë“±ë¡ëœ ì™¸ë¶€ ì¼ì • ì—†ìŒ</div>';
        return;
      }
      
      container.innerHTML = events.map(e => `
        <div class="event-item">
          <span>ğŸ“… ${e.date}</span>
          <span>${e.startHour}:00~${e.endHour}:00</span>
          <span style="color:#e2e8f0;">${e.name}</span>
          <span class="event-delete" onclick="deleteExternalEvent(${e.id})">âœ•</span>
        </div>
      `).join('');
    }
    
    function addExternalEvent() {
      const name = document.getElementById('eventName').value.trim();
      const date = document.getElementById('eventDate').value;
      const startHour = parseInt(document.getElementById('eventStart').value);
      const endHour = parseInt(document.getElementById('eventEnd').value);
      
      if (!name || !date) {
        alert('ì¼ì •ëª…ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (endHour <= startHour) {
        alert('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      WeeklyScheduler.addExternalEvent({
        name,
        date,
        startHour,
        endHour
      });
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('eventName').value = '';
      
      // ìŠ¤ì¼€ì¤„ëŸ¬ ìƒˆë¡œê³ ì¹¨
      loadScheduler();
    }
    
    function deleteExternalEvent(id) {
      WeeklyScheduler.removeExternalEvent(id);
      loadScheduler();
    }
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì™¸ë¶€ ì¼ì • ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
    function initEventDatePicker() {
      const today = new Date();
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('eventDate').value = dateStr;
      document.getElementById('customTaskDate').value = dateStr;
    }
    
    // =============================================
    // ì‚¬ìš©ì ì •ì˜ ì‘ì—… ê´€ë¦¬
    // =============================================
    
    let customTasks = [];
    
    function loadCustomTasks() {
      const saved = localStorage.getItem('shineCustomTasks');
      if (saved) {
        customTasks = JSON.parse(saved);
      }
      renderCustomTasks();
      return customTasks;
    }
    
    function saveCustomTasks() {
      localStorage.setItem('shineCustomTasks', JSON.stringify(customTasks));
    }
    
    function addCustomTask() {
      const name = document.getElementById('customTaskName').value.trim();
      const date = document.getElementById('customTaskDate').value;
      const startHour = parseInt(document.getElementById('customTaskStart').value);
      const duration = parseInt(document.getElementById('customTaskDuration').value);
      const type = document.getElementById('customTaskType').value;
      
      if (!name) {
        alert('ì‘ì—…ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!date) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const newTask = {
        id: Date.now(),
        name: name,
        date: date,
        startHour: startHour,
        endHour: startHour + duration,
        duration: duration,
        weatherSensitive: type === 'weather',
        isCustom: true
      };
      
      customTasks.push(newTask);
      saveCustomTasks();
      renderCustomTasks();
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('customTaskName').value = '';
      
      // ìŠ¤ì¼€ì¤„ëŸ¬ ìƒˆë¡œê³ ì¹¨
      loadScheduler();
    }
    
    function deleteCustomTask(id) {
      customTasks = customTasks.filter(t => t.id !== id);
      saveCustomTasks();
      renderCustomTasks();
      loadScheduler();
    }
    
    function renderCustomTasks() {
      const container = document.getElementById('customTaskList');
      
      if (customTasks.length === 0) {
        container.innerHTML = '<div style="color:#64748b; font-size:9px; padding:4px;">ë“±ë¡ëœ ì‚¬ìš©ì ì‘ì—… ì—†ìŒ</div>';
        return;
      }
      
      container.innerHTML = customTasks.map(t => `
        <div class="custom-task-item ${t.weatherSensitive ? 'weather-sensitive' : ''}">
          <span style="color:#a855f7;">âœï¸</span>
          <span>${t.date}</span>
          <span>${t.startHour}:00~${t.endHour}:00</span>
          <span style="color:#e2e8f0; font-weight:500;">${t.name}</span>
          <span style="color:${t.weatherSensitive ? '#fbbf24' : '#94a3b8'}; font-size:8px;">
            ${t.weatherSensitive ? 'ğŸŒ¡ï¸ë‚ ì”¨ê³ ë ¤' : 'ğŸ“¦ë‚ ì”¨ë¬´ê´€'}
          </span>
          <span class="task-delete" onclick="deleteCustomTask(${t.id})">âœ•</span>
        </div>
      `).join('');
    }
    
    // ì‚¬ìš©ì ì‘ì—…ì„ ìŠ¤ì¼€ì¤„ëŸ¬ ê²°ê³¼ì— í¬í•¨
    function mergeCustomTasksToSchedule(scheduledTasks) {
      const merged = [...scheduledTasks];
      
      customTasks.forEach(ct => {
        merged.push({
          task: ct.name,
          taskType: 'CUSTOM',
          date: ct.date,
          dayName: null,
          startHour: ct.startHour,
          endHour: ct.endHour,
          weather: null,
          weatherSensitive: ct.weatherSensitive,
          isCustom: true
        });
      });
      
      return merged;
    }
    
    // =============================================
    // ì‘ì—…ë³„ ì—°ê°„ ìŠ¤ì¼€ì¤„
    // =============================================
    
    let taskYearlyScheduleOpen = false;
    
    function toggleTaskYearlySchedule() {
      const panel = document.getElementById('taskYearlySchedule');
      const content = document.getElementById('taskYearlyContent');
      taskYearlyScheduleOpen = !taskYearlyScheduleOpen;
      
      if (taskYearlyScheduleOpen) {
        panel.classList.add('open');
        content.style.display = 'block';
        renderTaskYearlySchedule();
      } else {
        panel.classList.remove('open');
        content.style.display = 'none';
      }
    }
    
    function renderTaskYearlySchedule() {
      const container = document.getElementById('taskYearlyGrid');
      const filterType = document.getElementById('taskTypeFilter').value;
      const { WEEKLY_DATA } = window.ShineExpert;
      
      // ì‘ì—… ìœ í˜•ë³„ ì•„ì´ì½˜
      const taskIcons = {
        GA: 'ğŸ§ª',
        SPRAY: 'ğŸ§´',
        WATER: 'ğŸ’§',
        FERTILIZER: 'ğŸŒ±',
        PF: 'ğŸ¦ ',
        PRUNING: 'âœ‚ï¸',
        BAGGING: 'ğŸ›ï¸',
        HARVEST: 'ğŸ‡',
        HUMIDITY: 'ğŸŒ¬ï¸',
        GENERAL: 'ğŸ“‹'
      };
      
      // 52ì£¼ ì‘ì—… ë°ì´í„° ìˆ˜ì§‘
      const weeklyTasks = {};
      for (let w = 1; w <= 52; w++) {
        weeklyTasks[w] = [];
        const weekData = WEEKLY_DATA[w];
        if (!weekData) continue;
        
        // ì‘ì—… ëª©ë¡ì—ì„œ ìœ í˜• ë¶„ë¥˜
        if (weekData.tasks) {
          weekData.tasks.forEach(task => {
            const taskType = WeeklyScheduler.classifyTask(task);
            if (filterType === 'ALL' || taskType === filterType) {
              weeklyTasks[w].push({ type: taskType, text: task });
            }
          });
        }
        
        // ê´€ìˆ˜ (ë§¤ì£¼)
        if (weekData.water && (filterType === 'ALL' || filterType === 'WATER')) {
          weeklyTasks[w].push({ type: 'WATER', text: 'ê´€ìˆ˜' });
        }
        
        // ì‹œë¹„
        if (weekData.fertilizer && (filterType === 'ALL' || filterType === 'FERTILIZER')) {
          weeklyTasks[w].push({ type: 'FERTILIZER', text: weekData.fertilizer.type });
        }
        
        // PFë†ë²• (íŠ¹ì • ì£¼ì°¨)
        const pfWeeks = [1, 2, 4, 6, 9, 11, 13, 15, 17, 18, 20, 22, 24];
        if (pfWeeks.includes(w) && (filterType === 'ALL' || filterType === 'PF')) {
          weeklyTasks[w].push({ type: 'PF', text: 'PFë†ë²•' });
        }
        
        // ì•½ì œì‚´í¬ (ì§ìˆ˜ ì£¼)
        if (w % 2 === 0 && weekData.pest && (filterType === 'ALL' || filterType === 'SPRAY')) {
          weeklyTasks[w].push({ type: 'SPRAY', text: 'ì•½ì œì‚´í¬' });
        }
        
        // ìŠµë„ê´€ë¦¬ (ë§¤ì£¼)
        if (filterType === 'ALL' || filterType === 'HUMIDITY') {
          weeklyTasks[w].push({ type: 'HUMIDITY', text: 'ìŠµë„ê´€ë¦¬' });
        }
      }
      
      // ê·¸ë¦¬ë“œ ë Œë”ë§ (4í–‰ x 13ì—´ = 52ì£¼)
      let html = '';
      
      // í—¤ë” í–‰
      html += '<div class="task-yearly-cell header">ì£¼ì°¨</div>';
      for (let c = 1; c <= 12; c++) {
        html += `<div class="task-yearly-cell header">${c}ì—´</div>`;
      }
      
      // 4í–‰ (ê° í–‰ 13ì£¼)
      for (let row = 0; row < 4; row++) {
        // í–‰ ë ˆì´ë¸”
        const startWeek = row * 13 + 1;
        const endWeek = Math.min((row + 1) * 13, 52);
        html += `<div class="task-yearly-cell week-label">${startWeek}~${endWeek}ì£¼</div>`;
        
        // ê° ì…€
        for (let col = 0; col < 12; col++) {
          const weekNo = row * 13 + col + 1;
          if (weekNo > 52) {
            html += '<div class="task-yearly-cell"></div>';
            continue;
          }
          
          const tasks = weeklyTasks[weekNo] || [];
          const isCurrent = weekNo === currentWeekNo;
          const isDeleted = tasks.every(t => isTaskPermanentlyDeleted(weekNo, t.type + '_0'));
          
          if (tasks.length > 0 && !isDeleted) {
            // ê°€ì¥ ìš°ì„ ìˆœìœ„ ë†’ì€ ì‘ì—… íƒ€ì…
            const primaryType = tasks[0].type;
            const icon = taskIcons[primaryType] || 'ğŸ“‹';
            html += `
              <div class="task-yearly-cell has-task ${primaryType} ${isCurrent ? 'current' : ''}" 
                   title="${weekNo}ì£¼ì°¨: ${tasks.map(t => t.text).join(', ')}"
                   onclick="scrollToWeek(${weekNo})">
                <span class="task-icon">${icon}</span>
                <span class="task-count">${weekNo}ì£¼ (${tasks.length})</span>
              </div>
            `;
          } else {
            html += `
              <div class="task-yearly-cell ${isCurrent ? 'current' : ''}" 
                   title="${weekNo}ì£¼ì°¨"
                   onclick="scrollToWeek(${weekNo})">
                <span style="color:#475569; font-size:7px;">${weekNo}</span>
              </div>
            `;
          }
        }
      }
      
      // ë²”ë¡€
      html += `
        <div style="grid-column: 1 / -1; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 9px; color: #94a3b8;">
          <strong>ë²”ë¡€:</strong>
          <span style="margin-left:10px;">ğŸ§ªGA</span>
          <span style="margin-left:8px;">ğŸ§´ì‚´í¬</span>
          <span style="margin-left:8px;">ğŸ’§ê´€ìˆ˜</span>
          <span style="margin-left:8px;">ğŸŒ±ì‹œë¹„</span>
          <span style="margin-left:8px;">ğŸ¦ PF</span>
          <span style="margin-left:8px;">âœ‚ï¸ì „ì •</span>
          <span style="margin-left:8px;">ğŸ›ï¸ë´‰ì§€</span>
          <span style="margin-left:8px;">ğŸ‡ìˆ˜í™•</span>
          <span style="margin-left:8px;">ğŸŒ¬ï¸ìŠµë„</span>
          <span style="margin-left:15px; color:#22c55e;">â–  í˜„ì¬ì£¼ì°¨</span>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    function scrollToWeek(weekNo) {
      // ì£¼ì°¨ ëª©ë¡ì—ì„œ í•´ë‹¹ ì£¼ì°¨ë¡œ ìŠ¤í¬ë¡¤
      const weekItems = document.querySelectorAll('.week-item');
      if (weekItems[weekNo - 1]) {
        weekItems[weekNo - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
        weekItems[weekNo - 1].classList.add('highlight');
        setTimeout(() => weekItems[weekNo - 1].classList.remove('highlight'), 2000);
      }
    }
    
    // =============================================
    // 52ì£¼ ì „ì²´ ì‘ì—… ë°°ì¹˜í‘œ
    // =============================================
    
    let allWeeksScheduleOpen = false;
    
    function toggleAllWeeksSchedule() {
      const panel = document.getElementById('allWeeksSchedule');
      const content = document.getElementById('allWeeksContent');
      allWeeksScheduleOpen = !allWeeksScheduleOpen;
      
      if (allWeeksScheduleOpen) {
        panel.classList.add('open');
        content.style.display = 'block';
        renderAllWeeksSchedule();
      } else {
        panel.classList.remove('open');
        content.style.display = 'none';
      }
    }
    
    function renderAllWeeksSchedule() {
      const container = document.getElementById('allWeeksContent');
      const { WEEKLY_DATA } = window.ShineExpert;
      
      let html = '';
      
      for (let weekNo = 1; weekNo <= 52; weekNo++) {
        const weekData = WEEKLY_DATA[weekNo];
        if (!weekData) continue;
        
        const climate = WeeklyScheduler.getHistoricalClimate(weekNo);
        const isCurrent = weekNo === currentWeekNo;
        
        // ì‘ì—… ë¶„ë¥˜ ë° ë°°ì¹˜
        const tasks = weekData.tasks || [];
        const classifiedTasks = tasks.map(t => ({
          text: t,
          type: WeeklyScheduler.classifyTask(t),
          conditions: WeeklyScheduler.TASK_CONDITIONS[WeeklyScheduler.classifyTask(t)] || WeeklyScheduler.TASK_CONDITIONS.GENERAL
        }));
        
        // ë‚ ì”¨ ë¯¼ê°/ë¬´ê´€ ë¶„ë¥˜
        const weatherSensitiveTasks = classifiedTasks.filter(t => t.conditions.weatherSensitive !== false);
        const weatherIndependentTasks = classifiedTasks.filter(t => t.conditions.weatherSensitive === false);
        
        // ì‘ì—… ë°°ì¹˜
        const tasksByDay = distributeTasksToWeekFull(weatherSensitiveTasks, weatherIndependentTasks, climate, weekNo, weekData);
        
        // ì‚¬ìš©ìê°€ ì´ë™í•œ ì‘ì—… ì ìš©
        applyTaskMoveOverrides(tasksByDay, weekNo);
        
        html += `
          <div class="week-schedule-card ${isCurrent ? 'current' : ''}" id="weekSchedule${weekNo}">
            <div class="week-schedule-header" onclick="toggleWeekSchedule(${weekNo})">
              <span class="week-schedule-icon">${weekData.phaseEmoji}</span>
              <span class="week-schedule-title">${weekNo}ì£¼ì°¨ - ${weekData.phase}</span>
              <span class="week-schedule-dates">${weekData.dateRange}</span>
              <div class="week-schedule-climate">
                <span>ğŸŒ¡ï¸${climate.minTemp}~${climate.maxTemp}Â°C</span>
                <span>ğŸ’§${climate.rainChance}%</span>
              </div>
              <span class="week-schedule-toggle">â–¼</span>
            </div>
            <div class="week-schedule-content">
              <div style="margin-bottom:8px; padding:8px; background:#1e293b; border-radius:6px;">
                <div style="font-size:10px; color:#a855f7; font-weight:600;">ğŸ¯ ${weekData.goal}</div>
                <div style="font-size:9px; color:#fca5a5; margin-top:4px;">âš ï¸ ${weekData.keyAlert}</div>
              </div>
              
              <!-- 7ì¼ ìº˜ë¦°ë” (í˜„ì¬ ì£¼ ìŠ¤ì¼€ì¤„ëŸ¬ì™€ ë™ì¼ í˜•íƒœ) -->
              <div class="week-full-calendar">
                ${renderWeekFullCalendar(weekNo, weekData, climate, tasksByDay)}
              </div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // í˜„ì¬ ì£¼ì°¨ ìë™ ì—´ê¸°
      if (currentWeekNo >= 1 && currentWeekNo <= 52) {
        const currentCard = document.getElementById(`weekSchedule${currentWeekNo}`);
        if (currentCard) {
          currentCard.classList.add('open');
          setTimeout(() => {
            currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        }
      }
    }
    
    // ì „ì²´ 7ì¼ ìº˜ë¦°ë” ë Œë”ë§ (í˜„ì¬ ì£¼ ìŠ¤ì¼€ì¤„ëŸ¬ì™€ ë™ì¼)
    function renderWeekFullCalendar(weekNo, weekData, climate, tasksByDay) {
      const DAYS_FULL = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      let html = '<div class="week-scheduler-calendar">';
      
      // ìš”ì¼ë³„ ê¸°í›„ ë³€ë™ í•¨ìˆ˜
      const tempVariations = [-1, 1, 2, 0, -1, 1, 0];
      const humVariations = [2, -2, -3, 0, 1, -1, 2];
      
      // ì£¼ì°¨ ì‹œì‘ì¼ ê³„ì‚° (ì—´ê°€ë‘  ì‹œì‘ì¼ ê¸°ì¤€)
      const heatStartDate = new Date($('heatStart').value);
      const weekStartDate = new Date(heatStartDate);
      weekStartDate.setDate(heatStartDate.getDate() + (weekNo - 1) * 7);
      
      // ì˜¨ë„ì— ë”°ë¥¸ ìƒ‰ìƒ (ì˜í•˜=íŒŒë‘, ì˜ìƒ=ë¹¨ê°•)
      const getTempColorFull = (temp) => {
        if (temp <= -10) return '#1e3a8a';
        if (temp <= -5) return '#1d4ed8';
        if (temp <= 0) return '#3b82f6';
        if (temp <= 5) return '#f87171';
        if (temp <= 10) return '#ef4444';
        if (temp <= 15) return '#dc2626';
        if (temp <= 20) return '#b91c1c';
        if (temp <= 28) return '#991b1b';
        if (temp <= 33) return '#7f1d1d';
        return '#450a0a';
      };
      
      for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
        const isBlocked = dayIdx === 0 || dayIdx === 3; // ì¼ìš”ì¼, ìˆ˜ìš”ì¼
        const dayTasks = (tasksByDay[dayIdx] || []).sort((a, b) => (a.startHour || 0) - (b.startHour || 0));
        
        // í•´ë‹¹ ìš”ì¼ì˜ ë‚ ì§œ ê³„ì‚°
        const dayDate = new Date(weekStartDate);
        dayDate.setDate(dayDate.getDate() + dayIdx);
        const dayDateStr = `${dayDate.getMonth() + 1}/${dayDate.getDate()}`;
        
        // ì‹œê°„ë³„ ê¸°í›„ - ì¼ì¶œ~ì¼ëª° 6ë“±ë¶„ + ìš”ì¼ë³„ ë³€ë™
        const tempVar = tempVariations[dayIdx] || 0;
        const humVar = humVariations[dayIdx] || 0;
        
        // ì¼ì¶œ/ì¼ëª° ì‹œê°„ (ì›”ë³„)
        const sunTimes = WeeklyScheduler.getSunTimes(dayDate);
        const sunriseHour = Math.ceil(sunTimes.rise);
        const sunsetHour = Math.floor(sunTimes.set);
        
        // ì¼ì¶œ~ì¼ëª°ì„ 6ë“±ë¶„í•˜ì—¬ 6ê°œ ì‹œê°„ëŒ€ ìƒì„±
        const hours = [];
        const dayLength = sunsetHour - sunriseHour;
        const interval = dayLength / 5; // 6ê°œ í¬ì¸íŠ¸ = 5ê°œ ê°„ê²©
        for (let i = 0; i < 6; i++) {
          hours.push(Math.round(sunriseHour + interval * i));
        }
        
        const hourlyData = hours.map(hr => {
          const base = climate.hourly.find(h => h.hour === hr) || climate.hourly.find(h => Math.abs(h.hour - hr) <= 1) || climate.hourly[Math.floor((hr - 6) / 3)];
          return {
            hour: hr,
            temp: (base?.temp || 0) + tempVar,
            humidity: Math.max(0, Math.min(100, (base?.humidity || 0) + humVar))
          };
        });
        const h12 = hourlyData.find(h => h.hour === 12) || hourlyData[Math.floor(hourlyData.length / 2)];
        
        html += `
          <div class="wsc-day ${isBlocked ? 'blocked' : ''}" 
               ondragover="handleDragOver(event)" 
               ondragleave="handleDragLeave(event)" 
               ondrop="handleDrop(event, ${dayIdx}, ${weekNo})">
            <div class="wsc-header">
              <div class="wsc-dayname">${DAYS_FULL[dayIdx]}</div>
              <div class="wsc-date" style="font-size:10px; color:#fef08a; margin-top:-2px;">${dayDateStr}</div>
              ${!isBlocked ? `
                <span class="wsc-badge">5ë…„í‰ê· </span>
                <div class="wsc-hourly-scroll">
                  ${hourlyData.map(h => `
                    <div class="wsc-hourly-item">
                      <span class="wsc-h-time">${h.hour}ì‹œ</span>
                      <span class="wsc-h-temp" style="color:${getTempColorFull(h.temp)}">${h.temp}Â°</span>
                      <span class="wsc-h-hum">ğŸ’§${h.humidity}%</span>
                    </div>
                  `).join('')}
                </div>
              ` : '<div class="wsc-blocked-label">ğŸš« íœ´ë¬´</div>'}
            </div>
            ${!isBlocked ? `
              <div class="wsc-tasks">
                ${dayTasks.length === 0 ? '<div class="wsc-no-task">ì‘ì—… ì—†ìŒ<div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div></div>' :
                  dayTasks.map((t, idx) => {
                    const taskId = t.type + '_' + idx;
                    // ì˜êµ¬ ì‚­ì œëœ ì‘ì—…ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    if (isTaskPermanentlyDeleted(weekNo, taskId)) return '';
                    const taskState = getTaskState(weekNo, dayIdx, taskId);
                    const statusClass = taskState.status === 'completed' ? 'completed' : (taskState.status === 'deleted' ? 'deleted' : '');
                    const taskTextEscaped = (t.text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                    <div class="wsc-task ${t.isWater ? 'water' : (t.isFertilizer ? 'fertilizer' : (t.isSpray ? 'spray' : (t.isPF ? 'pf' : (t.isHumidity ? 'humidity' : (t.conditions.weatherSensitive !== false ? 'ws' : 'wi')))))} ${statusClass}" 
                         draggable="true"
                         ondragstart="handleDragStart(event, '${taskId}', '${taskTextEscaped}', ${dayIdx}, ${weekNo})"
                         ondragend="handleDragEnd(event)"
                         ${t.detail ? `onclick="toggleTaskDetail(this)"` : ''}>
                      <div class="wsc-task-time">â° ${t.startHour}:00~${t.endHour}:00</div>
                      <div class="wsc-task-name">${t.text}${t.detail ? ' â–¾' : ''}${t.carriedOver ? '<span class="task-carried-over">ğŸ“Œ ì´ì›”</span>' : ''}</div>
                      <div class="wsc-task-cond" style="color:${t.isWater ? '#38bdf8' : t.isFertilizer ? '#22c55e' : t.isSpray ? '#f59e0b' : t.isPF ? '#8b5cf6' : t.isHumidity ? '#06b6d4' : t.conditions.weatherSensitive !== false ? '#fbbf24' : '#64748b'}">
                        ${t.isWater ? 'ğŸ’§ ê´€ìˆ˜ ì‘ì—…' : t.isFertilizer ? 'ğŸ§ª ì‹œë¹„ ì‘ì—…' : t.isSpray ? 'ğŸ§´ ì•½ì œ ì‚´í¬' : t.isPF ? 'ğŸ¦  PFë†ë²•' : t.isHumidity ? 'ğŸŒ¬ï¸ í™˜ê¸°/ìŠµë„' : t.conditions.weatherSensitive !== false ? 'ğŸŒ¡ï¸' + (hourlyData.find(h => h.hour === 12)?.temp || '-') + 'Â°C ğŸ’§' + (hourlyData.find(h => h.hour === 12)?.humidity || '-') + '%' : 'ğŸ“¦ ë‚ ì”¨ë¬´ê´€'}
                      </div>
                      ${t.detail ? `<div class="wsc-task-detail">${t.detail.replace(/\\n/g, '<br>')}</div>` : ''}
                      <div class="task-actions">
                        ${taskState.status === 'deleted' ? `
                          <button class="task-action-btn restore" onclick="restoreTask(${weekNo}, ${dayIdx}, '${taskId}', '${taskTextEscaped}', event)">ğŸ”„ ë³µì›</button>
                          <button class="task-action-btn permanent-delete" onclick="permanentDeleteTask(${weekNo}, ${dayIdx}, '${taskId}', '${taskTextEscaped}', event)">âŒ ì™„ì „ì‚­ì œ</button>
                        ` : `
                          <button class="task-action-btn complete" onclick="completeTask(${weekNo}, ${dayIdx}, '${taskId}', '${taskTextEscaped}', event)">${taskState.status === 'completed' ? 'â†©ï¸ ì·¨ì†Œ' : 'âœ… ì™„ë£Œ'}</button>
                          <button class="task-action-btn delete" onclick="deleteTask(${weekNo}, ${dayIdx}, '${taskId}', '${taskTextEscaped}', event)">ğŸ—‘ï¸ ì‚­ì œ</button>
                        `}
                      </div>
                    </div>
                  `}).join('')
                }
                <div class="drag-hint">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      html += '</div>';
      return html;
    }
    
    // ì „ì²´ 7ì¼ì— ì‘ì—… ë¶„ë°° (ì‹œê°„ í¬í•¨)
    function distributeTasksToWeekFull(weatherSensitiveTasks, weatherIndependentTasks, climate, weekNo, weekData) {
      const tasksByDay = {};
      const WORK_DAYS = [1, 2, 4, 5, 6]; // ì›”,í™”,ëª©,ê¸ˆ,í† 
      
      // ì‹œë¹„ ì‘ì—… ë¨¼ì € í™•ì¸ (ê´€ì£¼ì‹œë¹„ ì—¬ë¶€ íŒŒì•…)
      let fertigationDays = []; // ê´€ì£¼ì‹œë¹„ê°€ ìˆëŠ” ë‚ 
      let fertigationWaterAmount = 0; // ê´€ì£¼ì‹œë¹„ì— ì‚¬ìš©ë˜ëŠ” ë¬¼ëŸ‰
      if (weekData && weekData.fertilizer) {
        const fert = weekData.fertilizer;
        const fertType = fert.type || 'ì‹œë¹„';
        const isFertigation = fertType.includes('ê´€ì£¼');
        
        let fertDays = [1, 5];
        if (fertType.includes('ì—½ë©´') || fert.foliar) {
          fertDays = [2, 4, 6];
        }
        
        if (isFertigation) {
          fertigationDays = fertDays;
          // ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ì¼ì¼ ê´€ìˆ˜ëŸ‰ì˜ ì•½ 40%
          const waterAmount = weekData.water?.amountTon || '3~5í†¤';
          const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
          if (match) {
            fertigationWaterAmount = parseFloat(match[1]) * 0.4;
          }
        }
      }
      
      // ê´€ìˆ˜ ì‘ì—… ì¶”ê°€ (ì£¼ê°„ ê³„íš ê¸°ë°˜) - ë¬¼ë¹ ì§ ì ì ˆí•¨
      if (weekData && weekData.water) {
        const waterInterval = weekData.water.interval || '';
        const waterMethod = weekData.water.method || '';
        const waterAmount = weekData.water.amountTon || '';
        
        // ì¼ì¼ ì´ ê´€ìˆ˜ëŸ‰ íŒŒì‹±
        let dailyWaterTotal = 3;
        const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
        if (match) {
          dailyWaterTotal = parseFloat(match[1]);
        }
        
        let waterDays = [2, 5];
        if (waterInterval.includes('2~3ì¼') || waterInterval.includes('2ì¼')) {
          waterDays = [1, 4, 6];
        } else if (waterInterval.includes('3~4ì¼') || waterInterval.includes('3ì¼')) {
          waterDays = [2, 5];
        } else if (waterInterval.includes('5~7ì¼') || waterInterval.includes('7ì¼')) {
          waterDays = [4];
        }
        
        let waterHour = 9;
        if (waterMethod.includes('ì˜¤í›„') || waterMethod.includes('ì €ë…')) {
          waterHour = 16;
        } else if (waterMethod.includes('ì´ë¥¸ ì•„ì¹¨') || waterMethod.includes('6')) {
          waterHour = 7;
        }
        
        waterDays.forEach(day => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          
          // ê´€ì£¼ì‹œë¹„ê°€ ìˆëŠ” ë‚ ì€ ê´€ìˆ˜ëŸ‰ ì¡°ì • (ì¼ì¼ì´ëŸ‰ - ê´€ì£¼ì‹œë¹„ë¬¼ëŸ‰)
          const isFertigationDay = fertigationDays.includes(day);
          let adjustedAmount = dailyWaterTotal;
          let waterNote = '';
          
          if (isFertigationDay && fertigationWaterAmount > 0) {
            adjustedAmount = Math.max(0, dailyWaterTotal - fertigationWaterAmount);
            waterNote = ` (ê´€ì£¼${fertigationWaterAmount.toFixed(1)}í†¤ ì œì™¸)`;
          }
          
          if (adjustedAmount > 0) {
            tasksByDay[day].unshift({
              text: `ğŸ’§ ê´€ìˆ˜ (${adjustedAmount.toFixed(1)}í†¤)${waterNote}`,
              type: 'WATER',
              isWater: true,
              isFertigationDay: isFertigationDay,
              conditions: { weatherSensitive: true, duration: 1 },
              startHour: waterHour,
              endHour: waterHour + 1
            });
          }
        });
      }
      
      // ì‹œë¹„ ì‘ì—… ì¶”ê°€ (ì£¼ê°„ ê³„íš ê¸°ë°˜)
      if (weekData && weekData.fertilizer) {
        const fert = weekData.fertilizer;
        const fertType = fert.type || 'ì‹œë¹„';
        const fertMain = fert.main || '';
        const fertSub = fert.sub || '';
        const fertFoliar = fert.foliar || '';
        const fertEc = fert.ec || '';
        const fertPoint = fert.point || '';
        const fertNpk = fert.npk || '';
        const isFertigation = fertType.includes('ê´€ì£¼');
        const waterAmount = weekData.water?.amountTon || '';
        
        let fertDays = [1, 5];
        if (fertType.includes('ì—½ë©´') || fertFoliar) {
          fertDays = [2, 4, 6];
        }
        
        const fertHour = 10;
        
        // ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ì¼ì¼ ê´€ìˆ˜ëŸ‰ì˜ 40%
        let fertigationWater = 0;
        let dailyTotal = 0;
        if (isFertigation && waterAmount) {
          const match = waterAmount.match(/(\d+(?:\.\d+)?)/);
          if (match) {
            dailyTotal = parseFloat(match[1]);
            fertigationWater = dailyTotal * 0.4;
          }
        }
        
        const fertDetail = [
          fertMain ? `ğŸ“Œ ${fertMain}` : '',
          fertSub ? `â• ${fertSub}` : '',
          fertFoliar ? `ğŸƒ ì—½ë©´: ${fertFoliar}` : '',
          fertEc ? `âš¡ EC: ${fertEc}` : '',
          fertPoint ? `âœ“ ${fertPoint}` : '',
          fertNpk ? fertNpk : '',
          isFertigation ? `ğŸ’§ ê´€ì£¼ì‹œë¹„ ë¬¼ëŸ‰: ${fertigationWater.toFixed(1)}í†¤ (40%)` : '',
          isFertigation ? `ğŸ’§ ì¶”ê°€ ê´€ìˆ˜: ${(dailyTotal - fertigationWater).toFixed(1)}í†¤ (60%)` : '',
          isFertigation ? `ğŸ“Š ì¼ì¼ ì´ëŸ‰: ${dailyTotal}í†¤ (100%)` : ''
        ].filter(x => x).join('\\n');
        
        fertDays.forEach((day, idx) => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          tasksByDay[day].push({
            text: isFertigation ? `ğŸ§ªğŸ’§ ê´€ì£¼ì‹œë¹„ (${fertigationWater.toFixed(1)}í†¤)` : `ğŸ§ª ${fertType} (${fertMain.substring(0, 10)}${fertMain.length > 10 ? '...' : ''})`,
            type: 'FERTILIZER',
            isFertilizer: true,
            isFertigation: isFertigation,
            detail: fertDetail,
            conditions: { weatherSensitive: true, duration: 1 },
            startHour: fertHour + idx,
            endHour: fertHour + idx + 1
          });
        });
      }
      
      let dayIndex = 0;
      let hourOffset = 0;
      
      // ë‚ ì”¨ ë¯¼ê° ì‘ì—… ë°°ì¹˜
      weatherSensitiveTasks.forEach(task => {
        const targetDay = WORK_DAYS[dayIndex % WORK_DAYS.length];
        if (!tasksByDay[targetDay]) tasksByDay[targetDay] = [];
        
        const startHour = 9 + (hourOffset * 2);
        const duration = task.conditions.duration || 2;
        
        tasksByDay[targetDay].push({
          ...task,
          startHour: startHour,
          endHour: startHour + duration
        });
        
        hourOffset++;
        if (hourOffset >= 3) {
          hourOffset = 0;
          dayIndex++;
        }
      });
      
      // ë‚ ì”¨ ë¬´ê´€ ì‘ì—… ë°°ì¹˜
      weatherIndependentTasks.forEach(task => {
        const targetDay = WORK_DAYS[dayIndex % WORK_DAYS.length];
        if (!tasksByDay[targetDay]) tasksByDay[targetDay] = [];
        
        const startHour = 9 + (hourOffset * 2);
        const duration = task.conditions.duration || 2;
        
        tasksByDay[targetDay].push({
          ...task,
          startHour: startHour,
          endHour: startHour + duration
        });
        
        hourOffset++;
        if (hourOffset >= 3) {
          hourOffset = 0;
          dayIndex++;
        }
      });
      
      // PFë†ë²• ì‘ì—… ì¶”ê°€
      const PF_SCHEDULE_FULL = {
        1: { timing: 'ë°œì•„ 45ì¼ì „', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        2: { timing: 'ë°œì•„ 30ì¼ì „', pf: 'PF-2', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        4: { timing: 'ë°œì•„ 15ì¼ì „', pf: 'PF-4', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        6: { timing: 'ë°œì•„', pf: 'PF-4', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        9: { timing: 'ê°œí™” 15ì¼ì „', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        11: { timing: 'ê°œí™”', pf: 'PF-2', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        13: { timing: 'ê°œí™” 15ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        15: { timing: 'ê°œí™” 30ì¼í›„', pf: 'PF-1', pfAmount: '500g', kit: 'PF-kit', kitAmount: '1kg' },
        17: { timing: 'ê°œí™” 45ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        18: { timing: 'ê°œí™” 50ì¼í›„', pf: 'PF-2', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        20: { timing: 'ê°œí™” 65ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        22: { timing: 'ê°œí™” 80ì¼í›„', pf: 'PF-2', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' },
        24: { timing: 'ê°œí™” 95ì¼í›„', pf: 'PF-4', pfAmount: '250g', kit: 'PF-kit', kitAmount: '500g' }
      };
      
      if (PF_SCHEDULE_FULL[weekNo]) {
        const pf = PF_SCHEDULE_FULL[weekNo];
        const pfDay = 4;
        const pfHour = 14;
        
        const pfDetail = [
          `ğŸ“… ì‹œê¸°: ${pf.timing}`,
          `ğŸ¦  ${pf.pf}: ${pf.pfAmount}`,
          `ğŸ“¦ ${pf.kit}: ${pf.kitAmount}`,
          ``,
          `ğŸ“‹ ì‚¬ìš© ë°©ë²•:`,
          `  â€¢ ${pf.pf}ì™€ ${pf.kit} í˜¼í•© ì‚¬ìš©`,
          `  â€¢ ë¬¼ 200Lë‹¹ í¬ì„`,
          `  â€¢ í† ì–‘ ê´€ì£¼ ë˜ëŠ” ì—½ë©´ ì‚´í¬`,
          ``,
          `ğŸ’¡ PFë†ë²• íš¨ê³¼:`,
          `  â€¢ í† ì–‘ ë¯¸ìƒë¬¼ í™œì„±í™”`,
          `  â€¢ ë¿Œë¦¬ ë°œë‹¬ ì´‰ì§„`,
          `  â€¢ ë³‘í•´ ì €í•­ì„± ê°•í™”`,
          `  â€¢ ë‹¹ë„ ë° í’ˆì§ˆ í–¥ìƒ`
        ].join('\\n');
        
        if (!tasksByDay[pfDay]) tasksByDay[pfDay] = [];
        tasksByDay[pfDay].push({
          text: `ğŸ¦  PFë†ë²• (${pf.pf} ${pf.pfAmount})`,
          type: 'PF',
          isPF: true,
          detail: pfDetail,
          conditions: { weatherSensitive: true, duration: 1 },
          startHour: pfHour,
          endHour: pfHour + 1
        });
      }
      
      // ì•½ì œ ì‚´í¬ ì‘ì—… ì¶”ê°€ (2ì£¼ì— 1íšŒ, ì§ìˆ˜ ì£¼ì°¨ì— ë°°ì¹˜)
      if (weekData && weekData.pest && weekNo % 2 === 0) {
        const pest = weekData.pest;
        const sprayDrug = pest.spray || 'ì˜ˆë°© ì•½ì œ';
        const watchList = pest.watch?.join(', ') || '-';
        const riskLevel = pest.risk || 'LOW';
        const condition = pest.condition || '-';
        const prevention = pest.prevention || '-';
        
        const sprayDay = 2;
        const sprayHour = 10;
        
        const sprayDetail = [
          `ğŸ¯ ì£¼ì˜ ë³‘í•´ì¶©: ${watchList}`,
          `âš ï¸ ìœ„í—˜ë„: ${riskLevel}`,
          `ğŸŒ¡ï¸ ë°œìƒ ì¡°ê±´: ${condition}`,
          `ğŸ›¡ï¸ ì˜ˆë°©: ${prevention}`,
          `ğŸ’Š ê¶Œì¥ ì•½ì œ: ${sprayDrug}`,
          ``,
          `ğŸ“‹ ì‚´í¬ ì¡°ê±´:`,
          `  â€¢ ì˜¨ë„: 15~28Â°C`,
          `  â€¢ ìŠµë„: 50~70%`,
          `  â€¢ ì‹œê°„: ì´ìŠ¬ ë§ˆë¥¸ í›„ (ì˜¤ì „ 9~11ì‹œ)`,
          `  â€¢ ë°”ëŒ: ì•½í•œ ë°”ëŒ (3m/s ì´í•˜)`,
          ``,
          `ğŸ“¦ í¬ì„ ë°°ìœ¨ (ì¼ë°˜ ê¸°ì¤€):`,
          `  â€¢ ì‚´ê· ì œ: 1,000~2,000ë°°`,
          `  â€¢ ì‚´ì¶©ì œ: 1,000~1,500ë°°`,
          `  â€¢ ì§„ë”§ë¬¼: 2,000ë°°`,
          `  â€¢ ì‘ì• ë¥˜: 1,500ë°°`
        ].join('\\n');
        
        if (!tasksByDay[sprayDay]) tasksByDay[sprayDay] = [];
        tasksByDay[sprayDay].push({
          text: `ğŸ§´ ì•½ì œì‚´í¬ (${sprayDrug.substring(0, 8)}${sprayDrug.length > 8 ? '...' : ''})`,
          type: 'SPRAY',
          isSpray: true,
          detail: sprayDetail,
          conditions: { weatherSensitive: true, duration: 2 },
          startHour: sprayHour,
          endHour: sprayHour + 2
        });
      }
      
      // ìŠµë„ê´€ë¦¬ ì‘ì—… ì¶”ê°€ (ì—°ë™í•˜ìš°ìŠ¤ ê¸°ì¤€)
      const HUMIDITY_PHASES_FULL = {
        dormant: { weeks: [1,2,3,4], name: 'íœ´ë©´ê¸°', humidity: '60-70%', mode: 'ìµœì†Œí™˜ê¸°', note: 'ë™í•´ë°©ì§€' },
        budding: { weeks: [5,6,7,8], name: 'ë°œì•„ê¸°', humidity: '70-80%', mode: 'ê²°ë¡œë°©ì§€', note: 'ìƒˆë²½í™˜ê¸° í•„ìˆ˜' },
        shooting: { weeks: [9,10,11,12,13,14], name: 'ì‹ ì´ˆìƒì¥ê¸°', humidity: '60-70%', mode: 'ì ê·¹í™˜ê¸°', note: 'ì›ƒìëŒ ë°©ì§€' },
        flowering: { weeks: [15,16,17], name: 'ê°œí™”ê¸°', humidity: '50-60%', mode: 'í•„ìˆ˜í™˜ê¸°', note: 'í™”ì§„ ë°©ì§€!' },
        fruitGrowth: { weeks: [18,19,20,21,22,23,24], name: 'ê³¼ë¦½ë¹„ëŒ€ê¸°', humidity: '60-70%', mode: 'ì—´ê³¼ë°©ì§€', note: 'ê¸‰ë³€ ì£¼ì˜' },
        coloring: { weeks: [25,26,27,28,29,30], name: 'ì°©ìƒ‰ê¸°', humidity: '50-60%', mode: 'ë‹¹ë„í–¥ìƒ', note: 'ì €ìŠµë„ ìœ ì§€' },
        harvest: { weeks: [31,32,33,34,35,36], name: 'ìˆ˜í™•ê¸°', humidity: '50-60%', mode: 'í’ˆì§ˆìœ ì§€', note: 'ê²°ë¡œ ë°©ì§€' },
        postHarvest: { weeks: [37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52], name: 'ìˆ˜í™•í›„', humidity: '60-70%', mode: 'ìµœì†Œí™˜ê¸°', note: 'ì›”ë™ ì¤€ë¹„' }
      };
      
      let humidityInfoFull = null;
      for (const [phase, info] of Object.entries(HUMIDITY_PHASES_FULL)) {
        if (info.weeks.includes(weekNo)) {
          humidityInfoFull = info;
          break;
        }
      }
      
      if (humidityInfoFull) {
        const humidityDetailFull = [
          `ğŸ“Š ìƒìœ¡ë‹¨ê³„: ${humidityInfoFull.name}`,
          `ğŸ’§ ì ì •ìŠµë„: ${humidityInfoFull.humidity}`,
          `ğŸŒ¬ï¸ í™˜ê¸°ëª¨ë“œ: ${humidityInfoFull.mode}`,
          `âš ï¸ ì£¼ì˜: ${humidityInfoFull.note}`,
          ``,
          `ğŸ“‹ ì‹œê°„ëŒ€ë³„ í™˜ê¸° (ì—°ë™í•˜ìš°ìŠ¤):`,
          `  06-08ì‹œ | 15Â°Câ†‘,80%â†‘ â†’ í™˜ê¸°íŒ¬,ì¸¡ì°½10%`,
          `  09-11ì‹œ | 20Â°Câ†‘,70%â†‘ â†’ ì¸¡ì°½30%,ì²œì°½ê°œë°©`,
          `  12-15ì‹œ | 25Â°Câ†‘ â†’ ì¸¡ì°½50%,í™˜ê¸°íŒ¬`,
          `  16-18ì‹œ | 20Â°Câ†“ â†’ ì¸¡ì°½20%,ì²œì°½íì‡„`,
          `  ì•¼ê°„ | 85%â†‘ â†’ í™˜ê¸°íŒ¬ ê°„í—ê°€ë™`,
          ``,
          `ğŸš¨ ì¦‰ì‹œì¡°ì¹˜: 80%â†‘â†’ì¦‰ì‹œí™˜ê¸°, ê²°ë¡œâ†’ì¼ì¶œ30ë¶„ì „`
        ].join('\\n');
        
        [1, 4].forEach(day => {
          if (!tasksByDay[day]) tasksByDay[day] = [];
          tasksByDay[day].push({
            text: `ğŸŒ¬ï¸ ìŠµë„ê´€ë¦¬ (${humidityInfoFull.humidity})`,
            type: 'HUMIDITY',
            isHumidity: true,
            detail: humidityDetailFull,
            conditions: { weatherSensitive: true, duration: 1 },
            startHour: 9,
            endHour: 10
          });
        });
      }
      
      return tasksByDay;
    }
    
    function toggleWeekSchedule(weekNo) {
      const card = document.getElementById(`weekSchedule${weekNo}`);
      if (card) {
        card.classList.toggle('open');
      }
    }
    
    // ì‘ì—…ì„ ìš”ì¼ë³„ë¡œ ë¶„ë°°
    function distributeTasksToWeek(weatherSensitiveTasks, weatherIndependentTasks, climate) {
      const tasksByDay = {};
      const DAY_INDICES = [1, 2, 4, 5, 6]; // ì›”,í™”,ëª©,ê¸ˆ,í† 
      
      let dayIndex = 0;
      
      // ë‚ ì”¨ ë¯¼ê° ì‘ì—…: ìµœì  ì¡°ê±´ ìš”ì¼ì— ë°°ì¹˜
      weatherSensitiveTasks.forEach(task => {
        // ê°„ë‹¨í•œ ë°°ì¹˜: ìˆœì°¨ì ìœ¼ë¡œ ë¶„ë°°
        const targetDay = DAY_INDICES[dayIndex % DAY_INDICES.length];
        if (!tasksByDay[targetDay]) tasksByDay[targetDay] = [];
        tasksByDay[targetDay].push(task);
        dayIndex++;
      });
      
      // ë‚ ì”¨ ë¬´ê´€ ì‘ì—…: ë‚¨ì€ ìš”ì¼ì— ë°°ì¹˜
      weatherIndependentTasks.forEach(task => {
        const targetDay = DAY_INDICES[dayIndex % DAY_INDICES.length];
        if (!tasksByDay[targetDay]) tasksByDay[targetDay] = [];
        tasksByDay[targetDay].push(task);
        dayIndex++;
      });
      
      return tasksByDay;
    }
    
    // ìš”ì¼ë³„ ê¸°í›„ ì •ë³´ (12ì‹œ ê¸°ì¤€)
    function getDayClimateInfo(climate, dayIdx) {
      const noon = climate.hourly.find(h => h.hour === 12) || climate.hourly[6];
      return {
        temp: noon ? noon.temp : climate.avgTemp,
        humidity: noon ? noon.humidity : 60
      };
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setTimeout(openCurrentWeek, 100);
      loadWeather(); // ë‚ ì”¨ ë¡œë“œ
      
      // ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™”
      initEventDatePicker();
      loadCustomTasks(); // ì‚¬ìš©ì ì‘ì—… ë¡œë“œ
      setTimeout(loadScheduler, 500); // ë‚ ì”¨ ë¡œë“œ í›„ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œë“œ
    });
  </script>
</body>
</html>
